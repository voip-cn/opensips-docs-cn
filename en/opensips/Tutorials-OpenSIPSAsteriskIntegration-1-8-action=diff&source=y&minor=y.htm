<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title>openSIPS | Documentation / Tutorials-OpenSIPSAsteriskIntegration-1-8 | History</title>
  <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel='stylesheet' href="opensips.css" tppabs="http://www.opensips.org/pub/skins/opensips/opensips.css" type='text/css' />
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 4px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
  .editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }

  .diffbox { width:570px; border-left:1px #999999 solid; margin-top:1.33em; }
  .diffauthor { font-weight:bold; }
  .diffchangesum { font-weight:bold; }
  .difftime { font-family:verdana,sans-serif; font-size:66%; 
    background-color:#dddddd; }
  .difftype { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; font-weight:bold; }
  .diffadd { border-left:5px #99ff99 solid; padding-left:5px; }
  .diffdel { border-left:5px #ffff99 solid; padding-left:5px; }
  .diffrestore { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; margin:1.5em 0px; }
  .diffmarkup { font-family:monospace; }  
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script>
  <link href="commentboxplus.css" tppabs="http://www.opensips.org/pub/commentboxplus/commentboxplus.css" rel='stylesheet' type='text/css' />
  <link rel='stylesheet' href="wsplus.css" tppabs="http://www.opensips.org/pub/wsplus/wsplus.css" 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url("csshover.htc")/*tpa=http://www.opensips.org/pub/wsplus/csshover.htc*/; }
    .rollover * { visibility: visible; }
  </style><![endif]-->
  <meta name='robots' content='noindex,nofollow' />

  <link rel="icon" type="image/png" href="http://opensips.org/favicon.png">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','analytics.js'/*tpa=http://www.google-analytics.com/analytics.js*/,'ga');

  ga('create', 'UA-47615177-1', 'http://www.opensips.org/Documentation/opensips.org');
  ga('send', 'pageview');

	function resizeIframe(obj) {
	    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
		  }

  </script>

</head>
<body>
<div id="main">
<!--PageHeaderFmt-->
  <div id='wikilogo'>
  <img class="motto" src="motto.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/motto.jpg" width="328" height="40" alt="The new breed of communication engine.">
  <a href="javascript:if(confirm(%27http://www.opensips.org/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/%27" tppabs="http://www.opensips.org/"><img class="logo" src="logo2.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/logo2.jpg"
    alt='openSIPS' border='0' /></a>
 </div>
 <div id='wikihead'>
 <table border=0>
  <tr valign=top><td width=250>
   
  </td></tr>
  <tr><td width=250>
   <form action="http://www.opensips.org/">
   
    <input type='hidden' name='n' value='Documentation.Tutorials-OpenSIPSAsteriskIntegration-1-8' />
    <input type='hidden' name='action' value='search' />

    <input type='text' name='q' id='formsubmit' value='' class='inputbox searchbox' />
	<input type='submit' id='formbutton' class='inputbutton searchbutton' value=' ' /></form>
  </td></tr>
  </table>
 </div>

<!--/PageHeaderFmt-->
<div id="osTopNav" >
	<div id="osTopNavLeft">
	</div>

	<div id="osTopNavRight">
	</div>

	<ul id="osTopNavList">
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/About/About  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/About/About%27" tppabs="http://www.opensips.org/About/About" title="About">About</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Downloads/Downloads  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Downloads/Downloads%27" tppabs="http://www.opensips.org/Downloads/Downloads" title="Download">Downloads</a>
		</li>
		<li>
			<a href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals" title="Documentation">Documentation</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Community/Foundation-Main  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Community/Foundation-Main%27" tppabs="http://www.opensips.org/Community/Foundation-Main" title="Community">Community</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Development/Development  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Development/Development%27" tppabs="http://www.opensips.org/Development/Development" title="Development">Development</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Support/Contact  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Support/Contact%27" tppabs="http://www.opensips.org/Support/Contact" title="Support">Support</a>
		</li>
	</ul>
</div>
<!--PageMenuFmt-->
<!--/PageMenuFmt-->
  <table width='100%' align="center" cellpadding='0' cellspacing='0' id='wikimid'>
    <tr>
<!--PageLeftFmt-->
      <td valign='top' bgcolor="#E2F8DA" id='wikileft'>
        <p class='sidehead'> <span  style='color: #185662;'> Documentation</span>
</p><ul><li><a class='wikilink' title='Manuals' href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals">Manuals</a>
</li><li><a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Advanced Tutorials</a>
</li><li><a class='wikilink' title='TipsFAQ' href="TipsFAQ.htm" tppabs="http://www.opensips.org/Documentation/TipsFAQ">Tips &amp; FAQ</a>
</li><li><a class='wikilink' title='Migration' href="Migration.htm" tppabs="http://www.opensips.org/Documentation/Migration">Version Migration</a>
</li><li><a class='wikilink' title='Webinars' href="Webinars.htm" tppabs="http://www.opensips.org/Documentation/Webinars">OpenSIPS Webinars</a>
</li><li><a class='wikilink' title='Troubleshooting' href="Troubleshooting.htm" tppabs="http://www.opensips.org/Documentation/Troubleshooting">Troubleshooting</a>
</li><li><a class='wikilink' title='Tools' href="Tools.htm" tppabs="http://www.opensips.org/Documentation/Tools">OpenSIPS Tools</a>
</li><li><a class='wikilink' title='Development-Tutorials' href="Development-Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Development-Tutorials">Devel Tutorial</a>
</li></ul><div class='vspace'></div>
</td>
<!--/PageLeftFmt-->
      <td id='wikibody' valign='top'>
<!--PageTitleFmt-->
        
<!--PageText-->
<div id='wikitext'>
<h2 class='wikiaction'>Documentation.Tutorials-OpenSIPSAsteriskIntegration-1-8 History</h2>
  <p><a href="Tutorials-OpenSIPSAsteriskIntegration-1-8-action=diff&source=y&minor=n.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=diff&source=y&minor=n">Hide minor edits</a> - <a href="Tutorials-OpenSIPSAsteriskIntegration-1-8-action=diff&source=n&minor=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=diff&source=n&minor=y">Show changes to output</a></p>
  <div id='wikidiff'>
      <div class='diffbox'><div class='difftime'>May 16, 2013, at 06:08 PM 
        by <span class='diffauthor' title='109.99.235.212'>109.99.235.212</span> - </div>
        <div class='difftype'>Changed line 1 from:</div>
        <div class='diffdel'><div class='diffmarkup'>!!Resources -&gt; [[Resources.Documentation | Documentation]] -&gt; [[Resources.DocsTutorials | Tutorials]] -&gt; Realtime OpenSIPS - Asterisk Integration</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>!!!!!Documentation -&gt; [[Documentation.Tutorials | Tutorials]] -&gt; Realtime OpenSIPS - Asterisk Integration</div></div></div>
      <div class='diffrestore'><a href="Tutorials-OpenSIPSAsteriskIntegration-1-8-action=edit&restore=diff-1368720529-1366821818-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=edit&restore=diff:1368720529:1366821818:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>April 24, 2013, at 06:43 PM 
        by <span class='diffauthor' title='213.233.101.41'>213.233.101.41</span> - </div>
        <div class='difftype'>Added lines 1-718:</div>
        <div class='diffadd'><div class='diffmarkup'>!!Resources -&gt; [[Resources.Documentation | Documentation]] -&gt; [[Resources.DocsTutorials | Tutorials]] -&gt; Realtime OpenSIPS - Asterisk Integration<br />This page has been visited {$PageCount} times.<br />(:toc-float Table of Content:)<br />----<br /><br />!!! Realtime '''OpenSIPS - Asterisk''' Integration<br /><br />'''This tutorial is made for OpenSIPS 1.8.x and Asterisk 1.8.x'''<br /><br />----<br />!!!! Scope<br /><br />This tutorial presents the concept and implementation of a realtime integration of OpenSIPS SIP server and Asterisk media server.<br /><br />OpenSIPS is used a SIP server - users are registering with it, it routes calls, etc - while the purpose of Asterisk is to provide a full set of media services - like voicemail, conference, announcements, etc.<br /><br />It is a realtime integration because both OpenSIPS and Asterisk are provisioned in the same same time when comes to user accounts - when creating a new OpenSIPS users, automatically Asterisk will learn about it an provide and configure all necessary  media services for it.<br /><br />Both OpenSIPS and Asterisk will be provisioned (for user accounts) via a shared mysql database.<br /><br />----<br />!!!! Setup presentation<br /><br />The following services will be offered by this integrated configuration:<br />* '''voicemail''' - users will get access to their mailbox; authentication will be done by OpenSIPS; while Asterisk will only provide voicemail IVR (with no access PIN);<br /> <br />* '''conference'''' - opensips will detect and forward calls related to conference service (based on prefixes) to Asterisk, which will provide access (pin based) to the conference rooms;<br /><br />* '''announcements''' - OpenSIPS will identify the cases and types of announcements that needs to be played and will simply redirect to Asterisk.<br /><br />----<br />!!!! Prerequisites  <br /><br />!!!! OpenSIPS<br /><br />Install OpenSIPS 1.8.x with mysql DB support (db_mysql module). if you use sources (tarballs or svn checkouts) do the following:<br />[@<br />   $ make include_modules=&quot;db_mysql&quot; prefix=&quot;/&quot; all<br />   $ make include_modules=&quot;db_mysql&quot; prefix=&quot;/&quot; install<br />@]<br /><br />!!!! Asterisk<br /><br />Install Asterisk 1.8 from local repository:<br /><br />[@<br />   # apt-get install asterisk<br />@]<br /><br />'''Note:''' if your repository does not have the Asterisk 1.8 version, you must install a backported version of Asterisk, by following these steps:<br /> * add the following line in the ''/etc/apt/sources.lst'' file:<br />[@<br />deb http://backports.debian.org/debian-backports squeeze-backports main<br />@]<br /> * update the repository:<br />[@<br />apt-get update<br />@]<br /> * install asterisk from backports repository<br />[@<br />apt-get -t squeeze-backports install asterisk<br />@]<br /><br />Install UnixODBC interface:<br /><br />[@<br />   # apt-get install unixodbc-dev libmyodbc<br />   # apt-get install asterisk-voicemail-odbcstorage<br />@]<br /><br />The latest version of the Meetme application needs the DAHDI telephony interface. Install the Asterisk Dahdi application:<br /><br />[@<br />   # apt-get install asterisk-dahdi dahdi<br />@]<br /><br />If a module package is not available for your platform, you must create your own package from dahdi sources, by issuing the following commands:<br /><br />[@<br />   # apt-get install dahdi-linux dahdi-source<br />   # cd /usr/src<br />   # m-a a-i dahdi<br />   # dpkg -i dahdi-modules-*.deb<br />   # modprobe dahdi<br />@]<br /><br /><br />----<br />!!!! DB Setup<br /><br />Only '''voicemail''' and '''conference''' services do require DB support. While the '''conference''' DB table will be exclusively be used by Asterisk (OpenSIPS does not require any information form there), the '''voicemail''' service do require a tight sharing of DB information about users between OpenSIPS and Asterisk.<br /><br />Considering OpenSIPS as the core SIP element of the platform, the core DB will be also belonging to OpenSIPS - we will use the OpenSIPS DB to drive both OpenSIPS and Asterisk. The tables required by Asterisk (for voicemail service) will be mapped over the OpenSIPS tables.<br /><br />This approach assumes two steps:<br /># creating the OpenSIP tables and extend them to contain also the fields (info) required by Asterisk.<br /># creating the mysql views over the OpenSIPS tables, in order to simulate the Asterisk tables<br /><br />!!!!! Creating the OpenSIPS tables<br /><br />In file '''/etc/opensips/opensipsctlrc''' enable the mysql backend (see '''DBENGINE''') and also configure the host where the mysql server is located, the name to be used for creating the opensips table, the read-only (ro) and read-write (rw) usernames and passwords to be created for accessing the opensips DB - see all the varaibles with '''DB''' prefix in the file.<br /><br />Proceed with creation of the OpenSIPS standard database:<br />[@<br />   $ opensipsdbctl create<br />@]<br /><br />If you use the default values to DB host and mysql access users, you can access the DB by:<br />[@<br />   $ mysql -h'localhost' -u'opensips' -p'opensipsrw' opensips<br />     &gt;<br />@]<br /><br />Once the default tables are created, we need to alter the '''subscriber''' table in order to add some additional fields required by the Asterisk DB view. These changes are:<br />* add '''vm_password''' to be used as voicemail pin<br />* add '''first_name''' and '''last_name''' as subscriber name<br />* add '''email_address''' as subscriber's email address<br />* add '''datetime_created''' as timestamp of the subscriber creation.<br /><br />Login to the '''opensips''' database (use the above login command) and run:<br />[@<br />  &gt; alter table subscriber add column `vmail_password` varchar(8) NOT NULL default '1234';<br />  &gt; alter table subscriber add column `first_name` varchar(25) NOT NULL default '';<br />  &gt; alter table subscriber add column `last_name` varchar(45) NOT NULL default '';<br />  &gt; alter table subscriber add column `email_address` varchar(50) NOT NULL default '';<br />  &gt; alter table subscriber add column `datetime_created` datetime NOT NULL default '0000-00-00 00:00:00';<br />@]<br /><br />!!!!! Creating the Asterisk tables<br /><br />Create a separate database to be used by Asterisk - login as root into mysql server and run:<br />[@<br />  &gt; create database asterisk;<br />  &gt; GRANT ALL PRIVILEGES ON asterisk.* TO 'asterisk' IDENTIFIED  BY 'asterisk_pwd';<br />@]<br /><br />Create the Asterisk tables which are exclusively used only by Asterisk (as mysql tables):<br />[@<br /># create table for the meetme service<br /><br />CREATE TABLE `meetme` (<br />  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,<br />  `confno` varchar(80) NOT NULL DEFAULT '0',<br />  `username` varchar(64) NOT NULL DEFAULT '',<br />  `domain` varchar(128) NOT NULL DEFAULT '',<br />  `pin` varchar(20) DEFAULT NULL,<br />  `adminpin` varchar(20) DEFAULT NULL,<br />  `members` int(11) DEFAULT NULL,<br />  PRIMARY KEY (`confno`),<br />  UNIQUE KEY `id` (`id`)<br />);<br /><br /><br /><br /># create table to store the voicemail massages<br />CREATE TABLE `voicemessages` (<br />  `id` int(11) NOT NULL auto_increment,<br />  `msgnum` int(11) NOT NULL default '0',<br />  `dir` varchar(80) default '',<br />  `context` varchar(80) default '',<br />  `macrocontext` varchar(80) default '',<br />  `callerid` varchar(40) default '',<br />  `origtime` varchar(40) default '',<br />  `duration` varchar(20) default '',<br />  `mailboxuser` varchar(80) default '',<br />  `mailboxcontext` varchar(80) default '',<br />  `recording` longblob,<br />  PRIMARY KEY  (`id`),<br />  KEY `dir` (`dir`)<br />);<br />@]<br /><br />Create the Asterisk tables (as mysql views) that import the information from OpenSIPS tables:<br />[@<br /># create the asterisk users tables as a view over the OpenSIPS subscriber table<br />CREATE VIEW `sipusers` AS select<br />  `opensips`.`subscriber`.`username` AS `name`<br />  ,_latin1'friend' AS `type`,<br />  NULL AS `secret`,<br />  `opensips`.`subscriber`.`domain` AS `host`,<br />  concat(`opensips`.`subscriber`.`rpid`,_latin1' ',_latin1'&lt;',`opensips`.`subscriber`.`username`,_latin1'&gt;') AS `callerid`,<br />  _latin1'default' AS `context`,<br />  `opensips`.`subscriber`.`username` AS `mailbox`,<br />  _latin1'yes' AS `nat`,<br />  _latin1'no' AS `qualify`,<br />  `opensips`.`subscriber`.`username` AS `fromuser`,<br />  NULL AS `authuser`,<br />  `opensips`.`subscriber`.`domain` AS `fromdomain`,<br />  NULL AS `insecure`,<br />  _latin1'no' AS `canreinvite`,<br />  NULL AS `disallow`,<br />  NULL AS `allow`,<br />  NULL AS `restrictcid`,<br />  `opensips`.`subscriber`.`domain` AS `defaultip`,<br />  `opensips`.`subscriber`.`domain` AS `ipaddr`,<br />  _latin1'5060' AS `port`,<br />  NULL AS `regseconds`,<br />  `opensips`.`subscriber`.`username` AS `defaultuser`,<br />  NULL AS `fullcontact`,<br />  `opensips`.`subscriber`.`domain` AS `regserver`,<br />  NULL AS `useragent`,<br />  0 AS `lastms`<br />from `opensips`.`subscriber`;<br /><br /># create the asterisk voceimail users table as a view over the OpenSIPS subscriber table<br />CREATE VIEW `vmusers` AS select<br />  concat(`opensips`.`subscriber`.`username`,`opensips`.`subscriber`.`domain`) AS `uniqueid`,<br />  `opensips`.`subscriber`.`username` AS `customer_id`,<br />  _latin1'default' AS `context`,<br />  `opensips`.`subscriber`.`username` AS `mailbox`,<br />  `opensips`.`subscriber`.`vmail_password` AS `password`,<br />  _latin1'joe' AS `fullname`,<br />  `opensips`.`subscriber`.`email_address` AS `email`,<br />  NULL AS `pager`,<br />  `opensips`.`subscriber`.`datetime_created` AS `stamp`<br />from `opensips`.`subscriber`;<br /><br />#create the asterisk voicemail aliases table as a view over the OpenSIPS dbaliases table<br />CREATE VIEW `asterisk`.`vmaliases` AS select<br />  `opensips`.`dbaliases`.`alias_username` AS `alias`,<br />  _latin1'default' AS `context`,<br />  `opensips`.`dbaliases`.`username` AS `mailbox`<br />from `opensips`.`dbaliases`;<br />@]<br /><br />Configure the access for Asterisk to the created database (via unixodbc):<br />* in ''etc/odbcinst.ini''<br />[@<br />[MySQL]<br />Description     = MySQL driver<br />Driver      = /usr/lib/odbc/libmyodbc.so<br />Setup       = /usr/lib/odbc/libodbcmyS.so<br />CPTimeout       =<br />CPReuse     =<br />UsageCount      = 1<br />@]<br /><br />* in ''/etc/odbc.ini''<br />[@<br />[MySQL-asterisk]<br />Description = MySQL Asterisk database<br />Trace       = Off<br />TraceFile   = stderr<br />Driver      = MySQL<br />SERVER      = localhost<br />USER        = asterisk<br />PASSWORD    = asterisk_pwd<br />PORT        = 3306<br />DATABASE    = asterisk<br />@]<br /><br />* in ''/etc/asterisk/res_odbc.conf''<br />[@<br />[asterisk]<br />enabled =&gt; yes<br />dsn =&gt; MySQL-asterisk<br />username =&gt; asterisk<br />password =&gt; asterisk_pwd<br />pre-connect =&gt; yes<br />@]<br /><br />* in ''/etc/asterisk/extconfig.conf''<br />[@<br />sipusers =&gt; odbc,asterisk,sipusers<br />sippeers =&gt; odbc,asterisk,sipusers<br />voicemail =&gt; odbc,asterisk,vmusers<br />meetme =&gt; odbc,asterisk,meetme<br />@]<br /><br /><br />----<br />!!!! Asterisk dialplan<br /><br />The following extensions are set for Asterisk:<br /><br /># '''VMR_''' prefix indicates that the caller (identify by SIP FROM header) leaves a voicemail message to the user indicated by the RURI (after the prefix).<br /><br /># '''VM_pickup''' RURI indicates that the caller (identify by SIP FROM header) accesses his own voicemailbox IVR (to listen his messages); the access is done directly, without any PIN required from Asterisk<br /><br /># '''AN_notavailable''' plays the &quot;Not Available&quot; audio message<br /><br /># '''AN_time''' plays the current time message (for the given timezone)<br /><br /># '''AN_date''' plays the current time message (for the given timezone)<br /><br /># '''AN_echo''' accesses the echo audio service<br /><br /># '''CR_''' prefix indicates access to a conference room; the number of the room is part of the RURI, after the prefix (like CR_3322); Asterisk will perform the checks for conference room existence and for the access PIN code. <br /><br /><br /><br />Set in ''/etc/asterisk/extensions.conf''' :<br />[@<br />[general]<br />static=yes<br />writeprotect=no<br /><br />[default]<br /><br />; Voicemail <br />exten =&gt; _VMR_.,n,Ringing<br />exten =&gt; _VMR_.,n,Wait(1)<br />exten =&gt; _VMR_.,n,Answer<br />exten =&gt; _VMR_.,n,Wait(1)<br />exten =&gt; _VMR_.,n,Voicemail(${EXTEN:4}|u)<br />exten =&gt; _VMR_.,n,Hangup<br /><br />; Allow users to call their Voicemail directly<br />exten =&gt; VM_pickup,n,Ringing<br />exten =&gt; VM_pickup,n,wait(1)<br />exten =&gt; VM_pickup,n,VoicemailMain(${CALLERIDNUM}|s)<br />exten =&gt; VM_pickup,n,Hangup<br /><br /><br />; announcement: not available<br />exten =&gt; AN_notavailable,1,Ringing<br />exten =&gt; AN_notavailable,2,Playback(notavailable)<br />exten =&gt; AN_notavailable,3,Hangup<br /><br />; announcement: time<br />exten =&gt; AN_time,1,Ringing<br />exten =&gt; AN_time,2,Wait(1)<br />exten =&gt; AN_time,3,SayUnixTime(,Europe/Bucharest,HMp)<br />exten =&gt; AN_time,4,Hangup<br /><br />; announcement:date<br />exten =&gt; AN_date,1,Ringing<br />exten =&gt; AN_date,2,SayUnixTime(,Europe/Bucharest,ABdY)<br />exten =&gt; AN_date,3,Hangup<br /><br />; announcement: echo<br />exten =&gt; AN_echo,1,Ringing<br />exten =&gt; AN_echo,2,Answer<br />exten =&gt; AN_echo,3,Echo<br /><br />; Conference service<br />exten =&gt; _CR_.,1,Ringing<br />exten =&gt; _CR_.,n,Wait(1)<br />exten =&gt; _CR_.,n,MeetMe(${EXTEN:3}|Mi)<br /><br /><br />@]<br /><br /><br />----<br />!!!! OpenSIPS configuration<br /><br />In this example we take the OpenSIPS default config file that provides user registration and authentication against the DB and extends the script for adding the following media oriented services:<br /><br /># voicemail<br />## leaving a message - if the called user is not registered on OpenSIPS, the call will be forwarded by OpenSIPS (by adding '''VMR_''' prefix) to Asterisk<br />## listening messages -if a subscriber calls to the *1111 number, OpenSIPS will rewrite it to '''VM_pickup''' and send it to Asterisk<br /># announcements <br />## service number *2111 for listening the current time message - OpenSIPS will rewrite it to '''AN_time''' and send it to Asterisk<br />## service number *2112 for listening the current date message - OpenSIPS will rewrite it to '''AN_date''' and send it to Asterisk<br />## service number *2113 for accessing the echo service - OpenSIPS will rewrite it to '''AN_echo''' and send it to Asterisk<br /># conference<br />## service number *3XXX for dialling into the conference room XXX - OpenSIPS will rewrite it to '''CR_XXX''' and send it to Asterisk<br /><br />In ''/etc/opensips/opensips.cfg'' place (see the ASTERISK_HOOKS markers to find the script parts relevant to Asterisk integration):<br />[@<br /><br />####### Global Parameters #########<br /><br />debug=3<br />log_stderror=no<br />log_facility=LOG_LOCAL0<br /><br />fork=yes<br />children=4<br /><br />/* uncomment the following lines to enable debugging */<br />#debug=6<br />#fork=no<br />#log_stderror=yes<br /><br />port=5060<br /><br />/* uncomment and configure the following line if you want opensips to <br />   bind on a specific interface/port/proto (default bind on all available) */<br />#listen=udp:192.168.1.2:5060<br /><br /><br />####### Modules Section ########<br /><br />#set module path<br />mpath=&quot;/lib/opensips/modules/&quot;<br /><br />loadmodule &quot;db_mysql.so&quot;<br />loadmodule &quot;signaling.so&quot;<br />loadmodule &quot;sl.so&quot;<br />loadmodule &quot;tm.so&quot;<br />loadmodule &quot;rr.so&quot;<br />loadmodule &quot;maxfwd.so&quot;<br />loadmodule &quot;usrloc.so&quot;<br />loadmodule &quot;registrar.so&quot;<br />loadmodule &quot;textops.so&quot;<br />loadmodule &quot;mi_fifo.so&quot;<br />loadmodule &quot;uri_db.so&quot;<br />loadmodule &quot;uri.so&quot;<br />loadmodule &quot;xlog.so&quot;<br />loadmodule &quot;acc.so&quot;<br />loadmodule &quot;auth.so&quot;<br />loadmodule &quot;auth_db.so&quot;<br />loadmodule &quot;domain.so&quot;<br /><br /># ----------------- setting module-specific parameters ---------------<br /><br /><br /># ----- mi_fifo params -----<br />modparam(&quot;mi_fifo&quot;, &quot;fifo_name&quot;, &quot;/tmp/opensips_fifo&quot;)<br /><br /># ----- rr params -----<br /># do not append from tag to the RR (no need for this script)<br />modparam(&quot;rr&quot;, &quot;append_fromtag&quot;, 0)<br /><br /># ----- usrloc params -----<br />modparam(&quot;usrloc&quot;, &quot;db_mode&quot;,   2)<br />modparam(&quot;usrloc&quot;, &quot;db_url&quot;,<br />	&quot;mysql://opensips:opensipsrw@localhost/opensips&quot;)<br /><br /># ----- uri_db params -----<br />modparam(&quot;uri_db&quot;, &quot;use_uri_table&quot;, 0)<br />modparam(&quot;uri_db&quot;, &quot;db_url&quot;, &quot;&quot;)<br /><br /># ----- acc params -----<br />/* what sepcial events should be accounted ? */<br />modparam(&quot;acc&quot;, &quot;early_media&quot;, 1)<br />modparam(&quot;acc&quot;, &quot;report_cancels&quot;, 1)<br />/* account triggers (flags) */<br />modparam(&quot;acc&quot;, &quot;failed_transaction_flag&quot;, 3)<br />modparam(&quot;acc&quot;, &quot;log_flag&quot;, 1)<br />modparam(&quot;acc&quot;, &quot;log_missed_flag&quot;, 2)<br />/* uncomment the following lines to enable DB accounting also */<br />modparam(&quot;acc&quot;, &quot;db_flag&quot;, 1)<br />modparam(&quot;acc&quot;, &quot;db_missed_flag&quot;, 2)<br /><br /># ----- auth_db params -----<br />modparam(&quot;auth_db&quot;, &quot;calculate_ha1&quot;, yes)<br />modparam(&quot;auth_db&quot;, &quot;password_column&quot;, &quot;password&quot;)<br />modparam(&quot;auth_db&quot;, &quot;db_url&quot;,<br />	&quot;mysql://opensips:opensipsrw@localhost/opensips&quot;)<br />modparam(&quot;auth_db&quot;, &quot;load_credentials&quot;, &quot;&quot;)<br /><br /># ----- domain params -----<br />modparam(&quot;domain&quot;, &quot;db_url&quot;,<br />	&quot;mysql://opensips:opensipsrw@localhost/opensips&quot;)<br />modparam(&quot;domain&quot;, &quot;db_mode&quot;, 1)   # Use caching<br /><br /># ----- multi-module params -----<br />/* uncomment the following line if you want to enable multi-domain support<br />   in the modules (dafault off) */<br />modparam(&quot;alias_db|auth_db|usrloc|uri_db&quot;, &quot;use_domain&quot;, 1)<br /><br /><br />####### Routing Logic ########<br /><br /><br /># main request routing logic<br /><br />route{<br /><br />	if (!mf_process_maxfwd_header(&quot;10&quot;)) {<br />		send_reply(&quot;483&quot;,&quot;Too Many Hops&quot;);<br />		exit;<br />	}<br /><br />	if (has_totag()) {<br />		# sequential request withing a dialog should<br />		# take the path determined by record-routing<br />		if (loose_route()) {<br />			if (is_method(&quot;BYE&quot;)) {<br />				setflag(1); # do accounting ...<br />				setflag(3); # ... even if the transaction fails<br />			} else if (is_method(&quot;INVITE&quot;)) {<br />				# even if in most of the cases is useless, do RR for<br />				# re-INVITEs alos, as some buggy clients do change route set<br />				# during the dialog.<br />				record_route();<br />			}<br />			# route it out to whatever destination was set by loose_route()<br />			# in $du (destination URI).<br />			route(1);<br />		} else {<br />			if ( is_method(&quot;ACK&quot;) ) {<br />				if ( t_check_trans() ) {<br />					# non loose-route, but stateful ACK; must be an ACK after <br />					# a 487 or e.g. 404 from upstream server<br />					t_relay();<br />					exit;<br />				} else {<br />					# ACK without matching transaction -&gt;<br />					# ignore and discard<br />					exit;<br />				}<br />			}<br />			send_reply(&quot;404&quot;,&quot;Not here&quot;);<br />		}<br />		exit;<br />	}<br /><br />	#initial requests<br /><br />	# CANCEL processing<br />	if (is_method(&quot;CANCEL&quot;)) {<br />		if (t_check_trans())<br />			t_relay();<br />		exit;<br />	}<br /><br />	t_check_trans();<br /><br />	# authenticate if from local subscriber<br />	if (!(method==&quot;REGISTER&quot;) &amp;&amp; is_from_local()) {<br />		if (!proxy_authorize(&quot;&quot;, &quot;subscriber&quot;)) {<br />			proxy_challenge(&quot;&quot;, &quot;0&quot;);<br />			exit;<br />		}<br />		if (!check_from()) {<br />			send_reply(&quot;403&quot;,&quot;Forbidden auth ID&quot;);<br />			exit;<br />		}<br />	<br />		consume_credentials();<br />		# caller authenticated<br />	}<br /><br />	# preloaded route checking<br />	if (loose_route()) {<br />		xlog(&quot;L_ERR&quot;,<br />		&quot;Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]&quot;);<br />		if (!is_method(&quot;ACK&quot;))<br />			send_reply(&quot;403&quot;,&quot;Preload Route denied&quot;);<br />		exit;<br />	}<br /><br />	# record routing<br />	if (!is_method(&quot;REGISTER|MESSAGE&quot;))<br />		record_route();<br /><br />	# account only INVITEs<br />	if (is_method(&quot;INVITE&quot;)) {<br />		setflag(1); # do accounting<br />	}<br /><br />	# if not a targetting a local SIP domain, just send it out<br />	# based on DNS (calls to foreign SIP domains)<br />	if (!is_uri_host_local()) {<br />		append_hf(&quot;P-hint: outbound\r\n&quot;); <br />		route(1);<br />	}<br /><br />	# requests for my domain<br /><br />	if (is_method(&quot;REGISTER&quot;)) {<br />		# authenticate the REGISTER requests<br />		if (!www_authorize(&quot;&quot;, &quot;subscriber&quot;)) {<br />			www_challenge(&quot;&quot;, &quot;0&quot;);<br />			exit;<br />		}<br />		if (!check_to()) {<br />			send_reply(&quot;403&quot;,&quot;Forbidden auth ID&quot;);<br />			exit;<br />		}<br /><br />		if (!save(&quot;location&quot;))<br />			sl_reply_error();<br /><br />		exit;<br />	}<br /><br />	if ($rU==NULL) {<br />		# request with no Username in RURI<br />		send_reply(&quot;484&quot;,&quot;Address Incomplete&quot;);<br />		exit;<br />	}<br /><br />	# ASTERISK HOOK - BEGIN<br />	# media service number? (digits starting with *)<br />	if ($rU=~&quot;^\*[1-9]+&quot;) {<br />		# we do provide access to media services only to our<br />		# subscribers, who were previously authenticated <br />		if (!is_from_local()) {<br />			send_reply(&quot;403&quot;,&quot;Forbidden access to media service&quot;);<br />			exit;<br />		}<br />		#identify the services and translate to Asterisk extensions<br />		if ($rU==&quot;*1111&quot;) {<br />			# access to own voicemail IVR<br />			$ru = &quot;sip:VM_pickup@ASTERISK_IP:ASTERISK_PORT&quot;;<br />		} else<br />		if ($rU==&quot;*2111&quot;) {<br />			# access to the &quot;say time&quot; announcement <br />			$ru = &quot;sip:AN_time@ASTERISK_IP:ASTERISK_PORT&quot;;<br />		} else<br />		if ($rU==&quot;*2112&quot;) {<br />			# access to the &quot;say date&quot; announcement <br />			$ru = &quot;sip:AN_date@ASTERISK_IP:ASTERISK_PORT&quot;;<br />		} else<br />		if ($rU==&quot;*2113&quot;) {<br />			# access to the &quot;echo&quot; service<br />			$ru = &quot;sip:AN_echo@ASTERISK_IP:ASTERISK_PORT&quot;;<br />		} else<br />		if ($rU=~&quot;\*3[0-9]{3}&quot;) {<br />			# access to the conference service <br />			# remove the &quot;*3&quot; prefix and place the &quot;CR_&quot; prefix<br />			strip(2);<br />			prefix(&quot;CR_&quot;);<br />			rewritehostport(&quot;ASTERISK_IP:ASTERISK_PORT&quot;);<br />		} else {<br />			# unknown service<br />			$ru = &quot;sip:AN_notavailable@ASTERISK_IP:ASTERISK_PORT&quot;;<br />		}<br />		# after setting the proper RURI (to point to corresponding ASTERISK extension),<br />		# simply forward the call<br />		t_relay();<br />		exit;<br />	}<br />	# ASTERISK HOOK - END<br /><br />	# do lookup<br />	if (!lookup(&quot;location&quot;)) {<br />		# ASTERISK HOOK - BEGIN<br />		# callee is not registered, so different to Voicemail<br />		# First add the VM recording prefix to the RURI<br />		prefix(&quot;VMR_&quot;);<br />		# forward to the call to Asterisk (replace below with real IP and port)<br /> 		rewritehostport(&quot;ASTERISK_IP:ASTERISK_PORT&quot;);<br />		route(1);<br />		# ASTERISK HOOK - END<br />		exit;<br />	}<br /><br />	# when routing via usrloc, log the missed calls also<br />	setflag(2);<br /><br />	# arm a failure route in order to catch failed calls<br />	# targeting local subscribers; if we fail to deliver<br />	# the call to the user, we send the call to voicemail<br />	t_on_failure(&quot;1&quot;);<br /><br />	route(1);<br />}<br /><br /><br />route[1] {<br />	if (!t_relay()) {<br />		sl_reply_error();<br />	};<br />	exit;<br />}<br /><br /><br />failure_route[1] {<br />	if (t_was_cancelled()) {<br />		exit;<br />	}<br /><br />	# if the failure code is &quot;408 - timeout&quot; or &quot;486 - busy&quot;,<br />	# forward the calls to voicemail recording<br />	if (t_check_status(&quot;486|408&quot;)) {<br />		# ASTERISK HOOK - BEGIN<br />		# First revert the RURI to get the original user in RURI<br />		# Then add the VM recording prefix to the RURI<br />		revert_uri();<br />		prefix(&quot;VMR_&quot;);<br />		# forward to the call to Asterisk (replace below with real IP and port)<br /> 		rewritehostport(&quot;ASTERISK_IP:ASTERISK_PORT&quot;);<br />		t_relay();<br />		# ASTERISK HOOK - END<br />		exit;<br />	}<br />}<br />@]<br /><br />----<br />!!!! How to use it<br /><br />Add a SIP domain in the OpenSIPS server (note that the sip domain most point -via DNS- to your opensips server; also for a SIP domain, you can use the IP address of the SIP server too):<br />[@<br />$ mysql -h'localhost' -u'opensips' -p'opensipsrw' opensips<br /> &gt; insert into domain (domain) values (&quot;test.com&quot;);<br /><br />$ opensipsctl fifo domain_reload<br />@]<br /><br />Create some subscribers with your OpenSIPS platform (alice@test.com with SIP password '1234'):<br />[@<br />$ opensipsctl add alice@test.com 1234<br />$ opensipsctl add bob@test.com 4321<br />@]<br /><br />If you want to change the voicemail pin (for subscriber alice@test.com):<br />[@<br />$ mysql -h'localhost' -u'opensips' -p'opensipsrw' opensips<br /> &gt; update subscriber set vm_password=&quot;6745&quot; where username=&quot;alice&quot; and domain=&quot;test.com&quot;;<br />@]<br /><br />!!!!! Test voicemail<br />Register your '''alice''' subscriber (ex: using twinkle soft client) to your server. Keep '''bob''' unregistered.<br /><br />From '''alice''' dial '''bob''' address -  you should get the prompt for leaving a voicemail messages/recording.<br /><br />Register '''bob''' also and dial '''*1111''' - you should get the voicemail IVR and listen the recording left by '''alice'''.<br /><br /><br />!!!!! Test announcements<br />Form a registered subscriber, simply dial the service numbers as configured in OpenSIPS (see the beginning of the previous chapter).<br /><br />!!!!! Test conference <br /><br />Add a conference room to your system:<br />[@<br />$ mysql -h'localhost' -u'asterisk' -p'asterisk_pwd' asterisk<br /> &gt; insert into meetme (confno, pin, adminpin) values (&quot;761&quot;,&quot;1122&quot;,&quot;4322&quot;);<br />@]<br /><br />From a registered SIP user, dial '''*3761''' (to dial in conf room 761) and at IVR prompt type '''1122''' access pin.</div></div></div>
      <div class='diffrestore'><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=edit&restore=diff:1366821818:1366821818:&preview=y  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=edit&restore=diff:1366821818:1366821818:&preview=y%27" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=edit&restore=diff:1366821818:1366821818:&preview=y">Restore</a></div></div></div>
  
<!--PageRightFmt--><!--/PageRightFmt--></td>
</tr></table>
<!--PageFooterFmt-->
  <div id='wikifoot'>
  <hr class="bottomline" /></td>
    <div class='footnav'>
	
      <a rel="nofollow" href="Tutorials-OpenSIPSAsteriskIntegration-1-8-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=edit">Edit</a> |
      <a rel="nofollow" href="Tutorials-OpenSIPSAsteriskIntegration-1-8-action=diff.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=diff">History</a> |
      <a rel="nofollow" href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=print  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=print%27" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSAsteriskIntegration-1-8?action=print" target='_blank'>Print</a> |
      <a href="RecentChanges.htm" tppabs="http://www.opensips.org/Documentation/RecentChanges">Recent Changes</a> |
      <a href="javascript:if(confirm(%27http://www.opensips.org/Site/Search  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Site/Search%27" tppabs="http://www.opensips.org/Site/Search">Search</a></div>
    <div class='lastmod'>Page last modified on May 16, 2013, at 06:08 PM</div></div>
<!--HTMLFooter-->
</div>
</body>
</html>
