<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title>openSIPS | Documentation / Tutorials-WebSocket-2-1 | History</title>
  <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel='stylesheet' href="opensips.css" tppabs="http://www.opensips.org/pub/skins/opensips/opensips.css" type='text/css' />
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 4px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
  .editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }

  .diffbox { width:570px; border-left:1px #999999 solid; margin-top:1.33em; }
  .diffauthor { font-weight:bold; }
  .diffchangesum { font-weight:bold; }
  .difftime { font-family:verdana,sans-serif; font-size:66%; 
    background-color:#dddddd; }
  .difftype { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; font-weight:bold; }
  .diffadd { border-left:5px #99ff99 solid; padding-left:5px; }
  .diffdel { border-left:5px #ffff99 solid; padding-left:5px; }
  .diffrestore { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; margin:1.5em 0px; }
  .diffmarkup { font-family:monospace; }  
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script>
  <link href="commentboxplus.css" tppabs="http://www.opensips.org/pub/commentboxplus/commentboxplus.css" rel='stylesheet' type='text/css' />
  <link rel='stylesheet' href="wsplus.css" tppabs="http://www.opensips.org/pub/wsplus/wsplus.css" 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url("csshover.htc")/*tpa=http://www.opensips.org/pub/wsplus/csshover.htc*/; }
    .rollover * { visibility: visible; }
  </style><![endif]-->
  <meta name='robots' content='noindex,nofollow' />

  <link rel="icon" type="image/png" href="http://opensips.org/favicon.png">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','analytics.js'/*tpa=http://www.google-analytics.com/analytics.js*/,'ga');

  ga('create', 'UA-47615177-1', 'http://www.opensips.org/Documentation/opensips.org');
  ga('send', 'pageview');

	function resizeIframe(obj) {
	    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
		  }

  </script>

</head>
<body>
<div id="main">
<!--PageHeaderFmt-->
  <div id='wikilogo'>
  <img class="motto" src="motto.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/motto.jpg" width="328" height="40" alt="The new breed of communication engine.">
  <a href="javascript:if(confirm(%27http://www.opensips.org/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/%27" tppabs="http://www.opensips.org/"><img class="logo" src="logo2.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/logo2.jpg"
    alt='openSIPS' border='0' /></a>
 </div>
 <div id='wikihead'>
 <table border=0>
  <tr valign=top><td width=250>
   
  </td></tr>
  <tr><td width=250>
   <form action="http://www.opensips.org/">
   
    <input type='hidden' name='n' value='Documentation.Tutorials-WebSocket-2-1' />
    <input type='hidden' name='action' value='search' />

    <input type='text' name='q' id='formsubmit' value='' class='inputbox searchbox' />
	<input type='submit' id='formbutton' class='inputbutton searchbutton' value=' ' /></form>
  </td></tr>
  </table>
 </div>

<!--/PageHeaderFmt-->
<div id="osTopNav" >
	<div id="osTopNavLeft">
	</div>

	<div id="osTopNavRight">
	</div>

	<ul id="osTopNavList">
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/About/About  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/About/About%27" tppabs="http://www.opensips.org/About/About" title="About">About</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Downloads/Downloads  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Downloads/Downloads%27" tppabs="http://www.opensips.org/Downloads/Downloads" title="Download">Downloads</a>
		</li>
		<li>
			<a href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals" title="Documentation">Documentation</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Community/Foundation-Main  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Community/Foundation-Main%27" tppabs="http://www.opensips.org/Community/Foundation-Main" title="Community">Community</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Development/Development  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Development/Development%27" tppabs="http://www.opensips.org/Development/Development" title="Development">Development</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Support/Contact  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Support/Contact%27" tppabs="http://www.opensips.org/Support/Contact" title="Support">Support</a>
		</li>
	</ul>
</div>
<!--PageMenuFmt-->
<!--/PageMenuFmt-->
  <table width='100%' align="center" cellpadding='0' cellspacing='0' id='wikimid'>
    <tr>
<!--PageLeftFmt-->
      <td valign='top' bgcolor="#E2F8DA" id='wikileft'>
        <p class='sidehead'> <span  style='color: #185662;'> Documentation</span>
</p><ul><li><a class='wikilink' title='Manuals' href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals">Manuals</a>
</li><li><a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Advanced Tutorials</a>
</li><li><a class='wikilink' title='TipsFAQ' href="TipsFAQ.htm" tppabs="http://www.opensips.org/Documentation/TipsFAQ">Tips &amp; FAQ</a>
</li><li><a class='wikilink' title='Migration' href="Migration.htm" tppabs="http://www.opensips.org/Documentation/Migration">Version Migration</a>
</li><li><a class='wikilink' title='Webinars' href="Webinars.htm" tppabs="http://www.opensips.org/Documentation/Webinars">OpenSIPS Webinars</a>
</li><li><a class='wikilink' title='Troubleshooting' href="Troubleshooting.htm" tppabs="http://www.opensips.org/Documentation/Troubleshooting">Troubleshooting</a>
</li><li><a class='wikilink' title='Tools' href="Tools.htm" tppabs="http://www.opensips.org/Documentation/Tools">OpenSIPS Tools</a>
</li><li><a class='wikilink' title='Development-Tutorials' href="Development-Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Development-Tutorials">Devel Tutorial</a>
</li></ul><div class='vspace'></div>
</td>
<!--/PageLeftFmt-->
      <td id='wikibody' valign='top'>
<!--PageTitleFmt-->
        
<!--PageText-->
<div id='wikitext'>
<h2 class='wikiaction'>Documentation.Tutorials-WebSocket-2-1 History</h2>
  <p><a href="Tutorials-WebSocket-2-1-action=diff&source=y&minor=n.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-WebSocket-2-1?action=diff&source=y&minor=n">Hide minor edits</a> - <a href="Tutorials-WebSocket-2-1-action=diff&source=n&minor=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-WebSocket-2-1?action=diff&source=n&minor=y">Show changes to output</a></p>
  <div id='wikidiff'>
      <div class='diffbox'><div class='difftime'>March 17, 2015, at 08:43 PM 
        by <span class='diffauthor' title='50.198.204.238'>etamme</span> - added note about offer answer model</div>
        <div class='difftype'>Changed line 138 from:</div>
        <div class='diffdel'><div class='diffmarkup'>The following configuration file is a minimal working example of a Residential script that can handle clients connections over both UDP and Websocket transports.</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>The following configuration file is a minimal working example of a Residential script that can handle clients connections over both UDP and Websocket transports.  This example assumes that the SDP offer is present in the INVITE from the UAC and the SDP answer is in the 200 OK from the UAS.</div></div></div>
      <div class='diffrestore'><a href="Tutorials-WebSocket-2-1-action=edit&restore=diff-1426621401-1426621302-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-WebSocket-2-1?action=edit&restore=diff:1426621401:1426621302:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>March 17, 2015, at 08:41 PM 
        by <span class='diffauthor' title='50.198.204.238'>etamme</span> - changed startup scripts link</div>
        <div class='difftype'>Changed line 24 from:</div>
        <div class='diffdel'><div class='diffmarkup'>After installing the kernel module and the additional libraries, the rtpengine daemon has to be configured. This can be done from @@/etc/default/ngcp-rtpengine-daemon@@ if installed from debs, or from the command line if the daemon is started manually. On systemd based OSes, Eric Tamme created some [[https://github.com/etamme/federated-sip/wiki|start scripts]].</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>After installing the kernel module and the additional libraries, the rtpengine daemon has to be configured. This can be done from @@/etc/default/ngcp-rtpengine-daemon@@ if installed from debs, or from the command line if the daemon is started manually. On systemd based OSes, Eric Tamme created some [[https://github.com/etamme/federated-sip/tree/2.1-config/scripts|startup scripts]].</div></div></div>
      <div class='diffrestore'><a href="Tutorials-WebSocket-2-1-action=edit&restore=diff-1426621302-1426615350-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-WebSocket-2-1?action=edit&restore=diff:1426621302:1426615350:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>March 17, 2015, at 07:02 PM 
        by <span class='diffauthor' title='89.120.101.121'>razvancrainea</span> - </div>
        <div class='difftype'>Changed lines 86-87 from:</div>
        <div class='diffdel'><div class='diffmarkup'>    if (is_method(&quot;REGISTER&quot;))<br />    {</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>    if (is_method(&quot;REGISTER&quot;)) {</div></div>
        <div class='difftype'>Deleted line 236:</div>
        <div class='diffdel'><div class='diffmarkup'></div></div>
        <div class='difftype'>Deleted line 247:</div>
        <div class='diffdel'><div class='diffmarkup'></div></div>
        <div class='difftype'>Changed lines 303-304 from:</div>
        <div class='diffdel'><div class='diffmarkup'>	if (is_method(&quot;PUBLISH|SUBSCRIBE&quot;))<br />	{</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>	if (is_method(&quot;PUBLISH|SUBSCRIBE&quot;)) {</div></div>
        <div class='difftype'>Changed lines 315-316 from:</div>
        <div class='diffdel'><div class='diffmarkup'>	if (is_method(&quot;REGISTER&quot;))<br />	{</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>	if (is_method(&quot;REGISTER&quot;)) {<br /></div></div>
        <div class='difftype'>Deleted line 344:</div>
        <div class='diffdel'><div class='diffmarkup'></div></div>
        <div class='difftype'>Deleted line 359:</div>
        <div class='diffdel'><div class='diffmarkup'></div></div>
        <div class='difftype'>Deleted line 375:</div>
        <div class='diffdel'><div class='diffmarkup'></div></div></div>
      <div class='diffrestore'><a href="Tutorials-WebSocket-2-1-action=edit&restore=diff-1426615350-1426615284-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-WebSocket-2-1?action=edit&restore=diff:1426615350:1426615284:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>March 17, 2015, at 07:01 PM 
        by <span class='diffauthor' title='89.120.101.121'>razvancrainea</span> - </div>
        <div class='difftype'>Added lines 1-401:</div>
        <div class='diffadd'><div class='diffmarkup'>!!!!! Documentation -&gt; [[Documentation.Tutorials | Tutorials ]] -&gt; [[ http://www.opensips.org/html/docs/modules/2.1.x/proto_ws.html | {+WebSocket Transport+} ]] using OpenSIPS <br />This page has been visited {$PageCount} times.<br />(:toc-float Table of Content:)<br />----<br /><br />!!! Tutorial Overview<br /><br />[[http://tools.ietf.org/html/rfc6455|WebSocket]] is a protocol that provides full-duplex communication between web clients and servers over TCP connections. Using the WebSocket protocol, browsers can connect to web servers and exchange data, regardless the type or nature of the application protocol. [[https://tools.ietf.org/html/rfc7118|RFC 7118]] leveraged this protocol in order to allow browsers to make VoIP calls using the SIP protocol.<br /><br />This document describes how to use '''OpenSIPS''' as the core component of a SIP platform that connects both SIP clients (over UDP, TCP or TLS) as well as browser based clients (using SIP over WebSockets). While OpenSIPS handles the SIP signalling part, media is handled by [[https://github.com/sipwise/rtpengine|RTPengine]], a high performance media proxy that is able to handle both RTP and SRTP media streams, as well as bridging between them.<br /><br />This tutorial is inspired from <br /><br />!!! Setup<br /><br />!!!! RTPengine<br /><br />!!!!! Installation<br /><br />The RTPengine consists of two main components: a kernel module used to efficiently route the RTP packets directly in kernel, and a daemon used to communicate with OpenSIPS. You can find more details [[https://github.com/sipwise/rtpengine#overview|here]]. Both components can be installed from debs (on Debian based systems) or directly from sources. Simply follow the [[https://github.com/sipwise/rtpengine#compiling-and-installing|official documentation]] to install RTPengine.<br /><br />!!!!! Usage<br /><br />After installing the kernel module and the additional libraries, the rtpengine daemon has to be configured. This can be done from @@/etc/default/ngcp-rtpengine-daemon@@ if installed from debs, or from the command line if the daemon is started manually. On systemd based OSes, Eric Tamme created some [[https://github.com/etamme/federated-sip/wiki|start scripts]].<br /><br />The interesting parameters we are using are as follows:<br /><br />* @@-i@@: the listening interface for RTP/SRTP<br />* @@-n@@: the listening IP and port that is used by OpenSIPS to communicate with the RTPengine<br />* @@-c@@: the IP and port of the CLI - this is used to gather statistics for the RTP/SRTP sessions<br />* @@-m, -M@@: both take an integer as argument and together define the local port range from which rtpengine will allocate UDP ports for media traffic relay. Default to 30000 and 40000 respectively.<br />* @@-L@@: indicates the debugging level<br /><br />You can find all the parameters available [[https://github.com/sipwise/rtpengine#userspace-daemon|here]].<br /><br />Here is an example that runs @@rtpengine@@ from cli that talks with OpenSIPS over localhost and RTP using the 1.1.1.1 IP:<br /><br />[@<br />./rtpengine -p /var/run/rtpengine.pid --i eth0/1.1.1.1 -n 127.0.0.1:60000 -c 127.0.0.0.1:60001 -m 50000 -M 55000 -E -L 7<br />@]<br /><br />!!!!! Troubleshoot<br /><br />First make sure the @@rtpengine@@ daemon is started:<br />[@<br />ps -ef | grep rtpengine<br />@]<br /><br />If the @@rtpengine@@ daemon does not start, make sure the @@xt_RTPENGINE@@ kernel module is loaded:<br />[@<br />lsmod | grep xt_RTPENGINE<br />@]<br /><br />If the module is not loaded, make sure the @@ip_tables@@ and @@x_tables@@ kernel modules are loaded. Also, check the logs for the last errors of the system<br />[@<br />dmesg<br />@]<br /><br />!!!! OpenSIPS<br /><br />In order to use WebSocket in OpenSIPS, one has to load the [[http://www.opensips.org/html/docs/modules/2.1.x/proto_ws|proto_ws]] into its configuration file and define a listener for the WebSocket protocol.<br />[@<br />listen=ws:127.0.0.1:8080<br />...<br />loadmodule &quot;proto_ws.so&quot;<br />@]<br /><br />Next, the [[http://www.opensips.org/html/docs/modules/2.1.x/rtpengine|rtpengine]] module has to be loaded and configured to communicate with the @@rtpengine@@ daemon.<br />[@<br />loadmodule &quot;rtpengine.so&quot;<br />modparam(&quot;rtpengine&quot;, &quot;rtpengine_sock&quot;, &quot;udp:127.0.0.1:60000&quot;)<br />@]<br /><br />Note that the [[http://www.opensips.org/html/docs/modules/2.1.x/rtpengine#rtpengine.p.rtpengine_sock|rtpengine_sock]] parameter should be the same as the @@-n@@ parameter sent to the @@rtpengine@@ daemon, and OpenSIPS should have IP connectivity to that socket.<br /><br />Next, the routing logic has to be changed in order to treat different the clients that use DTLS-SRTP, from the ones that use plain RTP and enable bridging if necessary. To do that, one can check if the request message was received over the WebSocket protocol. This can be achieved using the following code:<br /><br />[@<br />if (proto == WS)<br />    setflag(SRC_WS);<br />@]<br /><br />In case the request is a REGISTER, we want to store this information in the ''location'' table, so that we know then the user is called. To do that, we can set a branch flag before calling the [[http://www.opensips.org/html/docs/modules/2.1.x/registrar.html#id294034|save()]] function. This way, when the [[http://www.opensips.org/html/docs/modules/2.1.x/registrar.html#id294366|lookup()]] method returns, we will be able to determine whether the client uses WebSocket or not.<br /><br />[@<br />    if (is_method(&quot;REGISTER&quot;))<br />    {<br />        if (isflagset(SRC_WS))<br />            setbflag(DST_WS);<br /><br />        fix_nated_register();<br />        if (!save(&quot;location&quot;))                                                                                                                                 <br />            sl_reply_error();<br /><br />        exit;<br />    }<br />@]<br /><br />When a call is placed, based on the two flags (@@STR_WS@@ and @@DST_WS@@) we can determine what our caller and callee can &quot;speak&quot; (either RTP or DTLS-SRTP) and instruct the @@rtpengine@@ daemon how to handle the call. We can do that by tuning the parameters passed to the  [[http://www.opensips.org/html/docs/modules/2.1.x/rtpengine#rtpengine.f.rtpengine_offer|rtpengine_offer()]] function.<br />[@<br />    if (isflagset(SRC_WS) &amp;&amp; isbflagset(DST_WS))<br />        $var(rtpengine_flags) = &quot;ICE=force-relay DTLS=passive&quot;;<br />    else if (isflagset(SRC_WS) &amp;&amp; !isbflagset(DST_WS))<br />        $var(rtpengine_flags) = &quot;RTP/AVP replace-session-connection replace-origin ICE=remove&quot;;<br />    else if (!isflagset(SRC_WS) &amp;&amp; isbflagset(DST_WS))<br />        $var(rtpengine_flags) = &quot;UDP/TLS/RTP/SAVPF ICE=force&quot;;<br />    else if (!isflagset(SRC_WS) &amp;&amp; !isbflagset(DST_WS))<br />        $var(rtpengine_flags) = &quot;RTP/AVP replace-session-connection replace-origin ICE=remove&quot;;<br /><br />    rtpengine_offer(&quot;$var(rtpengine_flags)&quot;);<br />@]<br /><br />The [[http://www.opensips.org/html/docs/modules/2.1.x/rtpengine#rtpengine.f.rtpengine_answer|rtpengine_answer()]] function logic should look like this:<br /><br />[@<br />    if (isflagset(SRC_WS) &amp;&amp; isbflagset(DST_WS))<br />        $var(rtpengine_flags) = &quot;ICE=force-relay DTLS=passive&quot;;<br />    else if (isflagset(SRC_WS) &amp;&amp; !isbflagset(DST_WS))<br />        $var(rtpengine_flags) = &quot;UDP/TLS/RTP/SAVPF ICE=force&quot;;<br />    else if (!isflagset(SRC_WS) &amp;&amp; isbflagset(DST_WS))<br />        $var(rtpengine_flags) = &quot;RTP/AVP replace-session-connection replace-origin ICE=remove&quot;;<br />    else if (!isflagset(SRC_WS) &amp;&amp; !isbflagset(DST_WS))<br />        $var(rtpengine_flags) = &quot;RTP/AVP replace-session-connection replace-origin ICE=remove&quot;;<br /><br />    rtpengine_answer(&quot;$var(rtpengine_flags)&quot;);<br />@]<br /><br />Now, all we have to do is to close the RTP/SRTP session when the call is ended. To do that, we use the [[http://www.opensips.org/html/docs/modules/2.1.x/rtpengine#rtpengine.f.rtpengine_delete|rtpengine_delete()]] function:<br /><br />[@<br />    if (is_method(&quot;BYE|CANCEL&quot;)) {                                                                                                                      <br />        rtpengine_delete();<br />@]<br /><br />Having done all these settings should provide a full setup for interconnecting SIP clients over both UDP, TCP, etc. protocols, as well as browser based SIP clients over WebSocket.<br /><br />!!! Configuration file<br /><br />The following configuration file is a minimal working example of a Residential script that can handle clients connections over both UDP and Websocket transports.<br /><br />[@<br />#<br /># OpenSIPS residential configuration script<br />#     by OpenSIPS Solutions &lt;team@opensips-solutions.com&gt;<br />#<br /># Please refer to the Core CookBook at:<br />#      http://www.opensips.org/Resources/DocsCookbooks<br /># for a explanation of possible statements, functions and parameters.<br />#<br /><br /><br />####### Global Parameters #########<br /><br />debug=3<br />log_stderror=no<br />log_facility=LOG_LOCAL0<br /><br />fork=yes<br />children=4<br />auto_aliases=no<br /><br />listen=udp:127.0.0.0:5060 # TODO: update with your local IP and port<br />listen=ws:127.0.0.0:8080 # TODO: update with your local IP and port<br /><br />####### Modules Section ########<br /><br /># set module path<br />mpath=&quot;/usr/local/lib/opensips/modules/&quot;<br /><br />#### SIGNALING module<br />loadmodule &quot;signaling.so&quot;<br /><br />#### StateLess module<br />loadmodule &quot;sl.so&quot;<br /><br />#### Transaction Module<br />loadmodule &quot;tm.so&quot;<br />modparam(&quot;tm&quot;, &quot;fr_timeout&quot;, 5)<br />modparam(&quot;tm&quot;, &quot;fr_inv_timeout&quot;, 30)<br />modparam(&quot;tm&quot;, &quot;restart_fr_on_each_reply&quot;, 0)<br />modparam(&quot;tm&quot;, &quot;onreply_avp_mode&quot;, 1)<br /><br />#### Record Route Module<br />loadmodule &quot;rr.so&quot;<br />modparam(&quot;rr&quot;, &quot;append_fromtag&quot;, 0)<br /><br />#### MAX ForWarD module<br />loadmodule &quot;maxfwd.so&quot;<br /><br />#### SIP MSG OPerationS module<br />loadmodule &quot;sipmsgops.so&quot;<br /><br />#### FIFO Management Interface<br />loadmodule &quot;mi_fifo.so&quot;<br />modparam(&quot;mi_fifo&quot;, &quot;fifo_name&quot;, &quot;/tmp/opensips_fifo&quot;)<br />modparam(&quot;mi_fifo&quot;, &quot;fifo_mode&quot;, 0666)<br /><br />#### URI module<br />loadmodule &quot;uri.so&quot;<br />modparam(&quot;uri&quot;, &quot;use_uri_table&quot;, 0)<br /><br />#### USeR LOCation module<br />loadmodule &quot;usrloc.so&quot;<br />modparam(&quot;usrloc&quot;, &quot;nat_bflag&quot;, &quot;NAT&quot;)<br />modparam(&quot;usrloc&quot;, &quot;db_mode&quot;,   0)<br /><br />#### REGISTRAR module<br />loadmodule &quot;registrar.so&quot;<br /><br />#### RTPengine protocol<br />loadmodule &quot;rtpengine.so&quot;<br />modparam(&quot;rtpengine&quot;, &quot;rtpengine_sock&quot;, &quot;udp:127.0.0.0:60000&quot;)<br /><br />#### Nathelper protocol<br />loadmodule &quot;nathelper.so&quot;<br />modparam(&quot;registrar|nathelper&quot;, &quot;received_avp&quot;, &quot;$avp(rcv)&quot;)<br /><br />#### UDP protocol<br />loadmodule &quot;proto_udp.so&quot;<br /><br />#### WebSocket protocol<br />loadmodule &quot;proto_ws.so&quot;<br /><br /><br />####### Routing Logic ########<br /><br /># main request routing logic<br />route{<br />	if (!mf_process_maxfwd_header(&quot;10&quot;)) {<br />		sl_send_reply(&quot;483&quot;,&quot;Too Many Hops&quot;);<br />		exit;<br />	}<br /><br />	if (has_totag()) {<br />		# sequential requests within a dialog should<br />		# take the path determined by record-routing<br />		if (loose_route()) {<br /><br />			if (is_method(&quot;INVITE&quot;)) {<br />				# even if in most of the cases is useless, do RR for<br />				# re-INVITEs alos, as some buggy clients do change route set<br />				# during the dialog.<br />				record_route();<br />			}<br /><br />			# route it out to whatever destination was set by loose_route()<br />			# in $du (destination URI).<br />			route(relay);<br />		} else {<br /><br />			if ( is_method(&quot;ACK&quot;) ) {<br />				if ( t_check_trans() ) {<br />					# non loose-route, but stateful ACK; must be an ACK after<br />					# a 487 or e.g. 404 from upstream server<br />					t_relay();<br />					exit;<br />				} else {<br />					# ACK without matching transaction -&gt;<br />					# ignore and discard<br />					exit;<br />				}<br />			}<br />			sl_send_reply(&quot;404&quot;,&quot;Not here&quot;);<br />		}<br />		exit;<br />	}<br /><br />	# CANCEL processing<br />	if (is_method(&quot;CANCEL&quot;)) {<br />		if (t_check_trans())<br />			t_relay();<br />		exit;<br />	}<br /><br />	t_check_trans();<br /><br />	if (!is_method(&quot;REGISTER&quot;)) {<br />		if (from_uri!=myself) {<br />			# if caller is not local, then called number must be local<br />			if (!uri==myself) {<br />				send_reply(&quot;403&quot;,&quot;Rely forbidden&quot;);<br />				exit;<br />			}<br />		}<br />	}<br /><br />	# preloaded route checking<br />	if (loose_route()) {<br />		xlog(&quot;L_ERR&quot;,<br />		&quot;Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]&quot;);<br />		if (!is_method(&quot;ACK&quot;))<br />			sl_send_reply(&quot;403&quot;,&quot;Preload Route denied&quot;);<br />		exit;<br />	}<br /><br />	# record routing<br />	if (!is_method(&quot;REGISTER|MESSAGE&quot;))<br />		record_route();<br /><br />	if (!uri==myself) {<br />		append_hf(&quot;P-hint: outbound\r\n&quot;);<br />		route(relay);<br />	}<br /><br />	# requests for my domain<br />	if (is_method(&quot;PUBLISH|SUBSCRIBE&quot;))<br />	{<br />		sl_send_reply(&quot;503&quot;, &quot;Service Unavailable&quot;);<br />		exit;<br />	}<br /><br />	# check if the clients are using WebSockets<br />	if (proto == WS)<br />		setflag(SRC_WS);<br /><br />	# consider the client is behind NAT - always fix the contact<br />	fix_nated_contact();<br /><br />	if (is_method(&quot;REGISTER&quot;))<br />	{<br />		# indicate that the client supports DTLS<br />		# so we know when he is called<br />		if (isflagset(SRC_WS))<br />			setbflag(DST_WS);<br /><br />		fix_nated_register();<br />		if (!save(&quot;location&quot;))<br />			sl_reply_error();<br /><br />		exit;<br />	}<br /><br />	if ($rU==NULL) {<br />		# request with no Username in RURI<br />		sl_send_reply(&quot;484&quot;,&quot;Address Incomplete&quot;);<br />		exit;<br />	}<br /><br />	# do lookup with method filtering<br />	if (!lookup(&quot;location&quot;,&quot;m&quot;)) {<br />		t_newtran();<br />		t_reply(&quot;404&quot;, &quot;Not Found&quot;);<br />		exit;<br />	}<br /><br />	route(relay);<br />}<br /><br /><br />route[relay] {<br />	# for INVITEs enable some additional helper routes<br />	if (is_method(&quot;INVITE&quot;)) {<br />		t_on_branch(&quot;handle_nat&quot;);<br />		t_on_reply(&quot;handle_nat&quot;);<br />	} else if (is_method(&quot;BYE|CANCEL&quot;)) {<br />		rtpengine_delete();<br />	}<br /><br />	if (!t_relay()) {<br />		send_reply(&quot;500&quot;,&quot;Internal Error&quot;);<br />	};<br />	exit;<br />}<br /><br /><br />branch_route[handle_nat] {<br /><br />	if (!is_method(&quot;INVITE&quot;) || !has_body(&quot;application/sdp&quot;))<br />		return;<br /><br />	if (isflagset(SRC_WS) &amp;&amp; isbflagset(DST_WS))<br />		$var(rtpengine_flags) = &quot;ICE=force-relay DTLS=passive&quot;;<br />	else if (isflagset(SRC_WS) &amp;&amp; !isbflagset(DST_WS))<br />		$var(rtpengine_flags) = &quot;RTP/AVP replace-session-connection replace-origin ICE=remove&quot;;<br />	else if (!isflagset(SRC_WS) &amp;&amp; isbflagset(DST_WS))<br />		$var(rtpengine_flags) = &quot;UDP/TLS/RTP/SAVPF ICE=force&quot;;<br />	else if (!isflagset(SRC_WS) &amp;&amp; !isbflagset(DST_WS))<br />		$var(rtpengine_flags) = &quot;RTP/AVP replace-session-connection replace-origin ICE=remove&quot;;<br /><br />	rtpengine_offer(&quot;$var(rtpengine_flags)&quot;);<br />}<br /><br /><br />onreply_route[handle_nat] {<br /><br />	fix_nated_contact();<br />	if (!has_body(&quot;application/sdp&quot;))<br />		return;<br /><br />	if (isflagset(SRC_WS) &amp;&amp; isbflagset(DST_WS))<br />		$var(rtpengine_flags) = &quot;ICE=force-relay DTLS=passive&quot;;<br />	else if (isflagset(SRC_WS) &amp;&amp; !isbflagset(DST_WS))<br />		$var(rtpengine_flags) = &quot;UDP/TLS/RTP/SAVPF ICE=force&quot;;<br />	else if (!isflagset(SRC_WS) &amp;&amp; isbflagset(DST_WS))<br />		$var(rtpengine_flags) = &quot;RTP/AVP replace-session-connection replace-origin ICE=remove&quot;;<br />	else if (!isflagset(SRC_WS) &amp;&amp; !isbflagset(DST_WS))<br />		$var(rtpengine_flags) = &quot;RTP/AVP replace-session-connection replace-origin ICE=remove&quot;;<br /><br />	rtpengine_answer(&quot;$var(rtpengine_flags)&quot;);<br />}<br />@]</div></div></div>
      <div class='diffrestore'><a href="Tutorials-WebSocket-2-1-action=edit&restore=diff-1426615284-1426615284-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-WebSocket-2-1?action=edit&restore=diff:1426615284:1426615284:&preview=y">Restore</a></div></div></div>
  
<!--PageRightFmt--><!--/PageRightFmt--></td>
</tr></table>
<!--PageFooterFmt-->
  <div id='wikifoot'>
  <hr class="bottomline" /></td>
    <div class='footnav'>
	
      <a rel="nofollow" href="Tutorials-WebSocket-2-1-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-WebSocket-2-1?action=edit">Edit</a> |
      <a rel="nofollow" href="Tutorials-WebSocket-2-1-action=diff.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-WebSocket-2-1?action=diff">History</a> |
      <a rel="nofollow" href="Tutorials-WebSocket-2-1-action=print.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-WebSocket-2-1?action=print" target='_blank'>Print</a> |
      <a href="RecentChanges.htm" tppabs="http://www.opensips.org/Documentation/RecentChanges">Recent Changes</a> |
      <a href="javascript:if(confirm(%27http://www.opensips.org/Site/Search  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Site/Search%27" tppabs="http://www.opensips.org/Site/Search">Search</a></div>
    <div class='lastmod'>Page last modified on March 17, 2015, at 08:43 PM</div></div>
<!--HTMLFooter-->
</div>
</body>
</html>
