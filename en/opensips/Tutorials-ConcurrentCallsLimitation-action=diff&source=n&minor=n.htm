<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title>openSIPS | Documentation / Tutorials-ConcurrentCallsLimitation | History</title>
  <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel='stylesheet' href="opensips.css" tppabs="http://www.opensips.org/pub/skins/opensips/opensips.css" type='text/css' />
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 4px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
  .editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }

  .diffbox { width:570px; border-left:1px #999999 solid; margin-top:1.33em; }
  .diffauthor { font-weight:bold; }
  .diffchangesum { font-weight:bold; }
  .difftime { font-family:verdana,sans-serif; font-size:66%; 
    background-color:#dddddd; }
  .difftype { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; font-weight:bold; }
  .diffadd { border-left:5px #99ff99 solid; padding-left:5px; }
  .diffdel { border-left:5px #ffff99 solid; padding-left:5px; }
  .diffrestore { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; margin:1.5em 0px; }
  .diffmarkup { font-family:monospace; }  
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script>
  <link href="commentboxplus.css" tppabs="http://www.opensips.org/pub/commentboxplus/commentboxplus.css" rel='stylesheet' type='text/css' />
  <link rel='stylesheet' href="wsplus.css" tppabs="http://www.opensips.org/pub/wsplus/wsplus.css" 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url("csshover.htc")/*tpa=http://www.opensips.org/pub/wsplus/csshover.htc*/; }
    .rollover * { visibility: visible; }
  </style><![endif]-->
  <meta name='robots' content='noindex,nofollow' />

  <link rel="icon" type="image/png" href="http://opensips.org/favicon.png">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','analytics.js'/*tpa=http://www.google-analytics.com/analytics.js*/,'ga');

  ga('create', 'UA-47615177-1', 'http://www.opensips.org/Documentation/opensips.org');
  ga('send', 'pageview');

	function resizeIframe(obj) {
	    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
		  }

  </script>

</head>
<body>
<div id="main">
<!--PageHeaderFmt-->
  <div id='wikilogo'>
  <img class="motto" src="motto.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/motto.jpg" width="328" height="40" alt="The new breed of communication engine.">
  <a href="javascript:if(confirm(%27http://www.opensips.org/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/%27" tppabs="http://www.opensips.org/"><img class="logo" src="logo2.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/logo2.jpg"
    alt='openSIPS' border='0' /></a>
 </div>
 <div id='wikihead'>
 <table border=0>
  <tr valign=top><td width=250>
   
  </td></tr>
  <tr><td width=250>
   <form action="http://www.opensips.org/">
   
    <input type='hidden' name='n' value='Documentation.Tutorials-ConcurrentCallsLimitation' />
    <input type='hidden' name='action' value='search' />

    <input type='text' name='q' id='formsubmit' value='' class='inputbox searchbox' />
	<input type='submit' id='formbutton' class='inputbutton searchbutton' value=' ' /></form>
  </td></tr>
  </table>
 </div>

<!--/PageHeaderFmt-->
<div id="osTopNav" >
	<div id="osTopNavLeft">
	</div>

	<div id="osTopNavRight">
	</div>

	<ul id="osTopNavList">
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/About/About  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/About/About%27" tppabs="http://www.opensips.org/About/About" title="About">About</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Downloads/Downloads  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Downloads/Downloads%27" tppabs="http://www.opensips.org/Downloads/Downloads" title="Download">Downloads</a>
		</li>
		<li>
			<a href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals" title="Documentation">Documentation</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Community/Foundation-Main  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Community/Foundation-Main%27" tppabs="http://www.opensips.org/Community/Foundation-Main" title="Community">Community</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Development/Development  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Development/Development%27" tppabs="http://www.opensips.org/Development/Development" title="Development">Development</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Support/Contact  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Support/Contact%27" tppabs="http://www.opensips.org/Support/Contact" title="Support">Support</a>
		</li>
	</ul>
</div>
<!--PageMenuFmt-->
<!--/PageMenuFmt-->
  <table width='100%' align="center" cellpadding='0' cellspacing='0' id='wikimid'>
    <tr>
<!--PageLeftFmt-->
      <td valign='top' bgcolor="#E2F8DA" id='wikileft'>
        <p class='sidehead'> <span  style='color: #185662;'> Documentation</span>
</p><ul><li><a class='wikilink' title='Manuals' href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals">Manuals</a>
</li><li><a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Advanced Tutorials</a>
</li><li><a class='wikilink' title='TipsFAQ' href="TipsFAQ.htm" tppabs="http://www.opensips.org/Documentation/TipsFAQ">Tips &amp; FAQ</a>
</li><li><a class='wikilink' title='Migration' href="Migration.htm" tppabs="http://www.opensips.org/Documentation/Migration">Version Migration</a>
</li><li><a class='wikilink' title='Webinars' href="Webinars.htm" tppabs="http://www.opensips.org/Documentation/Webinars">OpenSIPS Webinars</a>
</li><li><a class='wikilink' title='Troubleshooting' href="Troubleshooting.htm" tppabs="http://www.opensips.org/Documentation/Troubleshooting">Troubleshooting</a>
</li><li><a class='wikilink' title='Tools' href="Tools.htm" tppabs="http://www.opensips.org/Documentation/Tools">OpenSIPS Tools</a>
</li><li><a class='wikilink' title='Development-Tutorials' href="Development-Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Development-Tutorials">Devel Tutorial</a>
</li></ul><div class='vspace'></div>
</td>
<!--/PageLeftFmt-->
      <td id='wikibody' valign='top'>
<!--PageTitleFmt-->
        
<!--PageText-->
<div id='wikitext'>
<h2 class='wikiaction'>Documentation.Tutorials-ConcurrentCallsLimitation History</h2>
  <p><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=diff&source=n&minor=y  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=diff&source=n&minor=y%27" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=diff&source=n&minor=y">Show minor edits</a> - <a href="Tutorials-ConcurrentCallsLimitation-action=diff&source=y&minor=n.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=diff&source=y&minor=n">Show changes to markup</a></p>
  <div id='wikidiff'>
      <div class='diffbox'><div class='difftime'>August 17, 2015, at 06:40 PM 
        by <span class='diffauthor' title='78.96.148.62'>78.96.148.62</span> - </div>
        <div class='difftype'>Added lines 4-5:</div>
        <div class='diffadd'><p>This scripting is valid for OpenSIPS versions <strong>1.8 up to 2.1</strong> .
</p>
</div></div>
      <div class='diffrestore'><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1439829651:1439829599:&preview=y  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1439829651:1439829599:&preview=y%27" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1439829651:1439829599:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>August 17, 2015, at 06:39 PM 
        by <span class='diffauthor' title='78.96.148.62'>78.96.148.62</span> - </div>
        <div class='difftype'>Changed line 1 from:</div>
        <div class='diffdel'><h5>Documentation -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; Concurrent calls limitation</h5>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><h5>Documentation -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; Concurrent calls limitation 1.8</h5>
</div>
        <div class='difftype'>Changed lines 6-8 from:</div>
        <div class='diffdel'><p>Using the new 'dialog' module released with the upcoming 1.5x branch, it is now possible to easily impose channel limits within existing routing configurations. The example included below is a sample route block that integrates outbound channel limits with call control prepaid account support. Note that the example requires an AVP variable 'channels' to be set as user preference and can be adapted for both outbound and inbound channel limits using the existing profile architecture of the dialog module. 
</p>
<div class='vspace'></div>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><p>OpenSIPS server can implement concurrent calls limitation by using the <em>call profiles</em> support provided by the <em>dialog</em> module.  The call profiles are a simple mechanism that allows to group certain calls and to count them. The grouping can be extended by using <em>labels</em> (values inside a group). This allows a better granularity when comes to counting calls. 
</p>
<p class='vspace'>Different keys can be used to group calls (like the incoming IP address, the caller user, the outbound GW, etc). Once we create a profile for such a group of call, when handling the call in the OpenSIPS script, we add the call to such a group, eventually with an extra label (where the label is the actual value of the incoming IP or of the caller or of the GW).
</p>
<p class='vspace'>In the below example we create a generic route to implement the limitation of concurrent calls from the same caller. The Route takes two parameters, the caller SIP username and the value of the limit. This Route is to be used when calls are created (when initial INVITEs are handled) after the dialog was created in script.  
</p>
<div class='vspace'></div>
</div>
        <div class='difftype'>Deleted lines 18-20:</div>
        <div class='diffdel'><ol><li>Example route block:
</li><li>  this example should be called before the t_relay() function of an outbound invite
</li><li>
</li></ol>
</div>
        <div class='difftype'>Changed lines 20-24 from:</div>
        <div class='diffdel'><ol><li>Request route 'callcontrol' with channel limit
</li></ol>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><ol><li>This route is to be called for initial INVITEs, after 
</li><li>  the dialog was created
</li><li>Parameters:
</li><li>   * the caller URI (string)
</li><li>   * the limit (integer)
</li></ol>
</div>
        <div class='difftype'>Changed lines 26-27 from:</div>
        <div class='diffdel'><p>route[39]
</p>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><p>route[do_limit]
</p>
</div>
        <div class='difftype'>Changed lines 28-94 from:</div>
        <div class='diffdel'><pre>	## have we done our checking on this call?
	if(!isflagset(31))
	{
		# user has max channel limit set as preference
		if(is_avp_set("$avp(s:channels)/n") &amp;&amp; avp_check("$avp(s:channels)", "gt/i:0"))
		{
			# get current calls for uuid
			get_profile_size("caller","$avp(s:caller_uuid)","$var(calls)");	

			# check within limit
			if($avp(s:channels) &gt; $var(calls))
			{
				xlog("L_INFO", "Call control: user '$avp(s:caller_uuid)' currently has 
				   '$var(calls)' of '$avp(s:channels)' active calls before this one\n");
				$var(setprofile) = 1;
			}
			else
			{
				xlog("L_INFO", "Call control: user channel limit exceeded [$var(calls)/$avp(s:channels)]\n");
				send_reply("487", "Request Terminated: Channel limit exceeded\n");
				exit;
			}
		}
		else
		{
			$var(setprofile) = 0;
		}

		call_control();

       	 	switch ($retcode) 
		{
        		case 2:
            			# Call with no limit
        		case 1:
            			# Call with a limit under callcontrol management (either prepaid or postpaid)
            			break;
        		case -1:
            			# Not enough credit (prepaid call)
            			xlog("L_INFO", "Call control: not enough credit for prepaid call\n");
            			acc_rad_request("402");
            			sl_send_reply("402", "Not enough credit");
            			exit;
            			break;
        		case -2:
           			# Locked by call in progress (prepaid call)
             			xlog("L_INFO", "Call control: prepaid call locked by another call in progress\n");
             			acc_rad_request("403");
             			sl_send_reply("403", "Call locked by another call in progress");
             			exit;
             			break;
        		default:
            			# Internal error (message parsing, communication, ...)
            			xlog("L_INFO", "Call control: internal server error\n");
            			acc_rad_request("500");
            			sl_send_reply("500", "Internal server error");
            			exit;
        	}

		if($var(setprofile) &gt; 0)
		{
			create_dialog();
			set_dlg_profile("caller","$avp(s:caller_uuid)");
		}

		## mark checking done
		setflag(31);
</pre>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><pre>	# first add to the profile, just to avoid "test and set" false results
	set_dlg_profile("caller","$param(1)");


	# do the actual test - see how many calls the user has so far
	get_profile_size("caller","$param(1)","$var(calls)");
	xlog("User $param(1) has $var(calls) ongoing calls so far, limit is $param(2)\n");

	# check within limit
	if( $var(calls)&gt;$param(2) )
	{	
		xlog("do_limit: user $param(1) exceeded number of calls [$var(calls)/$param(2)]\n");
		send_reply("487", "Request Terminated: Channel limit exceeded\n");
		exit;
		# terminating this call will automatically remove the call from the profile
</pre>
</div>
        <div class='difftype'>Added lines 44-45:</div>
        <div class='diffadd'><pre>	# call was added to the profile without exceeding the limit, simply continue
</pre>
</div>
        <div class='difftype'>Added lines 47-54:</div>
        <div class='diffadd'><p>....
....
route {
</p><pre>	.....
	# initial INVITES
	route(do_limit,$fu, 10);
	.....
</pre><p>}
</p>
</div>
        <div class='difftype'>Deleted lines 58-63:</div>
        <div class='diffdel'><p><a name='comment1' id='comment1'></a>(:nl:)&gt;&gt;messagehead&lt;&lt;
</p><h5><a class='createlinktext' rel='nofollow' 
    href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Ramesh?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Ramesh?action=edit%27" tppabs="http://www.opensips.org/Profiles/Ramesh?action=edit">Ramesh</a><a rel='nofollow' 
    class='createlink' href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Ramesh?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Ramesh?action=edit%27" tppabs="http://www.opensips.org/Profiles/Ramesh?action=edit">?</a>  &mdash;  <span style='font-size:83%'>22 October 2012, 20:35</span>  </h5>
<div class='messageitem' > 
<p>Prepaid cards do not build your credit and don't corvnet to regular credit cards.  Prepaid cards are more like gift cards.  You put money on the card and when it's used up, you have to add more.What you need is a secured card   you pay a deposit which is held as collateral against the line of credit.  You use the card and get a monthly statement and are required to make payments just like a regular credit card.  If you use the card and pay in full every month, you should be able to corvnet it to a regular account in about a year.,
</p></div>
</div></div>
      <div class='diffrestore'><a href="Tutorials-ConcurrentCallsLimitation-action=edit&restore=diff-1439829599-1368720564-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1439829599:1368720564:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>May 16, 2013, at 06:09 PM 
        by <span class='diffauthor' title='109.99.235.212'>109.99.235.212</span> - </div>
        <div class='difftype'>Changed line 1 from:</div>
        <div class='diffdel'><h2><a class='wikilink' title='Index' href="Index.htm" tppabs="http://www.opensips.org/Documentation/Index">Documentation</a> -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; <a class='selflink' href="Tutorials-ConcurrentCallsLimitation.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation">Concurrent calls limitation</a></h2>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><h5>Documentation -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; Concurrent calls limitation</h5>
</div>
        <div class='difftype'>Changed line 6 from:</div>
        <div class='diffdel'><div class='indent'>Using the new 'dialog' module released with the upcoming 1.5x branch, it is now possible to easily impose channel limits within existing routing configurations. The example included below is a sample route block that integrates outbound channel limits with call control prepaid account support. Note that the example requires an AVP variable 'channels' to be set as user preference and can be adapted for both outbound and inbound channel limits using the existing profile architecture of the dialog module. 
</div>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><p>Using the new 'dialog' module released with the upcoming 1.5x branch, it is now possible to easily impose channel limits within existing routing configurations. The example included below is a sample route block that integrates outbound channel limits with call control prepaid account support. Note that the example requires an AVP variable 'channels' to be set as user preference and can be adapted for both outbound and inbound channel limits using the existing profile architecture of the dialog module. 
</p>
</div></div>
      <div class='diffrestore'><a href="Tutorials-ConcurrentCallsLimitation-action=edit&restore=diff-1368720564-1368101004-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1368720564:1368101004:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>May 09, 2013, at 02:03 PM 
        by <span class='diffauthor' title='79.118.227.150'>79.118.227.150</span> - </div>
        <div class='difftype'>Added line 2:</div>
        <div class='diffadd'><hr />
</div>
        <div class='difftype'>Changed line 4 from:</div>
        <div class='diffdel'><hr />
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'></div></div>
      <div class='diffrestore'><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1368101004:1368100971:&preview=y  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1368101004:1368100971:&preview=y%27" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1368101004:1368100971:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>May 09, 2013, at 02:02 PM 
        by <span class='diffauthor' title='79.118.227.150'>79.118.227.150</span> - </div>
        <div class='difftype'>Changed line 1 from:</div>
        <div class='diffdel'><h2>Resources -&gt; <a class='wikilink' title='Documentation' href="javascript:if(confirm(%27http://www.opensips.org/Resources/Documentation  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Resources/Documentation%27" tppabs="http://www.opensips.org/Resources/Documentation">Documentation</a> -&gt; <a class='wikilink' title='DocsTutorials' href="javascript:if(confirm(%27http://www.opensips.org/Resources/DocsTutorials  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Resources/DocsTutorials%27" tppabs="http://www.opensips.org/Resources/DocsTutorials">Tutorials</a> -&gt; Concurrent calls limitation</h2>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><h2><a class='wikilink' title='Index' href="Index.htm" tppabs="http://www.opensips.org/Documentation/Index">Documentation</a> -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; <a class='selflink' href="Tutorials-ConcurrentCallsLimitation.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation">Concurrent calls limitation</a></h2>
</div>
        <div class='difftype'>Changed line 103 from:</div>
        <div class='diffdel'><p>(:commentboxchrono:)
</p>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><p>(:commentboxchrono:)
</p>
</div></div>
      <div class='diffrestore'><a href="Tutorials-ConcurrentCallsLimitation-action=edit&restore=diff-1368100971-1366822070-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1368100971:1366822070:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>April 24, 2013, at 06:47 PM 
        by <span class='diffauthor' title='213.233.101.41'>213.233.101.41</span> - </div>
        <div class='difftype'>Added lines 1-103:</div>
        <div class='diffadd'><h2>Resources -&gt; <a class='wikilink' title='Documentation' href="javascript:if(confirm(%27http://www.opensips.org/Resources/Documentation  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Resources/Documentation%27" tppabs="http://www.opensips.org/Resources/Documentation">Documentation</a> -&gt; <a class='wikilink' title='DocsTutorials' href="javascript:if(confirm(%27http://www.opensips.org/Resources/DocsTutorials  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Resources/DocsTutorials%27" tppabs="http://www.opensips.org/Resources/DocsTutorials">Tutorials</a> -&gt; Concurrent calls limitation</h2>
<p>This page has been visited 6537 times.
</p><hr />
<div class='vspace'></div><div class='indent'>Using the new 'dialog' module released with the upcoming 1.5x branch, it is now possible to easily impose channel limits within existing routing configurations. The example included below is a sample route block that integrates outbound channel limits with call control prepaid account support. Note that the example requires an AVP variable 'channels' to be set as user preference and can be adapted for both outbound and inbound channel limits using the existing profile architecture of the dialog module. 
</div><div class='vspace'></div><pre class='escaped'>
....
# define the profile
modparam("dialog", "profiles_with_value", "caller")
....

# Example route block:
#   this example should be called before the t_relay() function of an outbound invite
#
########################################################################
# Request route 'callcontrol' with channel limit
########################################################################

route[39]
{
	## have we done our checking on this call?
	if(!isflagset(31))
	{
		# user has max channel limit set as preference
		if(is_avp_set("$avp(s:channels)/n") &amp;&amp; avp_check("$avp(s:channels)", "gt/i:0"))
		{
			# get current calls for uuid
			get_profile_size("caller","$avp(s:caller_uuid)","$var(calls)");	

			# check within limit
			if($avp(s:channels) &gt; $var(calls))
			{
				xlog("L_INFO", "Call control: user '$avp(s:caller_uuid)' currently has 
				   '$var(calls)' of '$avp(s:channels)' active calls before this one\n");
				$var(setprofile) = 1;
			}
			else
			{
				xlog("L_INFO", "Call control: user channel limit exceeded [$var(calls)/$avp(s:channels)]\n");
				send_reply("487", "Request Terminated: Channel limit exceeded\n");
				exit;
			}
		}
		else
		{
			$var(setprofile) = 0;
		}

		call_control();

       	 	switch ($retcode) 
		{
        		case 2:
            			# Call with no limit
        		case 1:
            			# Call with a limit under callcontrol management (either prepaid or postpaid)
            			break;
        		case -1:
            			# Not enough credit (prepaid call)
            			xlog("L_INFO", "Call control: not enough credit for prepaid call\n");
            			acc_rad_request("402");
            			sl_send_reply("402", "Not enough credit");
            			exit;
            			break;
        		case -2:
           			# Locked by call in progress (prepaid call)
             			xlog("L_INFO", "Call control: prepaid call locked by another call in progress\n");
             			acc_rad_request("403");
             			sl_send_reply("403", "Call locked by another call in progress");
             			exit;
             			break;
        		default:
            			# Internal error (message parsing, communication, ...)
            			xlog("L_INFO", "Call control: internal server error\n");
            			acc_rad_request("500");
            			sl_send_reply("500", "Internal server error");
            			exit;
        	}

		if($var(setprofile) &gt; 0)
		{
			create_dialog();
			set_dlg_profile("caller","$avp(s:caller_uuid)");
		}

		## mark checking done
		setflag(31);
	}
}
</pre>
<div class='vspace'></div><hr />
<p class='vspace'>(:nl:)&gt;&gt;messagehead&lt;&lt;
</p><h5><a class='createlinktext' rel='nofollow' 
    href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Ramesh?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Ramesh?action=edit%27" tppabs="http://www.opensips.org/Profiles/Ramesh?action=edit">Ramesh</a><a rel='nofollow' 
    class='createlink' href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Ramesh?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Ramesh?action=edit%27" tppabs="http://www.opensips.org/Profiles/Ramesh?action=edit">?</a>  &mdash;  <span style='font-size:83%'>22 October 2012, 20:35</span>  </h5>
<div class='messageitem' > 
<p>Prepaid cards do not build your credit and don't corvnet to regular credit cards.  Prepaid cards are more like gift cards.  You put money on the card and when it's used up, you have to add more.What you need is a secured card   you pay a deposit which is held as collateral against the line of credit.  You use the card and get a monthly statement and are required to make payments just like a regular credit card.  If you use the card and pay in full every month, you should be able to corvnet it to a regular account in about a year.,
</p></div>
<p class='vspace'>(:commentboxchrono:)
</p>
</div></div>
      <div class='diffrestore'><a href="Tutorials-ConcurrentCallsLimitation-action=edit&restore=diff-1366822070-1366822070-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit&restore=diff:1366822070:1366822070:&preview=y">Restore</a></div></div></div>
  
<!--PageRightFmt--><!--/PageRightFmt--></td>
</tr></table>
<!--PageFooterFmt-->
  <div id='wikifoot'>
  <hr class="bottomline" /></td>
    <div class='footnav'>
	
      <a rel="nofollow" href="Tutorials-ConcurrentCallsLimitation-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=edit">Edit</a> |
      <a rel="nofollow" href="Tutorials-ConcurrentCallsLimitation-action=diff.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=diff">History</a> |
      <a rel="nofollow" href="Tutorials-ConcurrentCallsLimitation-action=print.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-ConcurrentCallsLimitation?action=print" target='_blank'>Print</a> |
      <a href="RecentChanges.htm" tppabs="http://www.opensips.org/Documentation/RecentChanges">Recent Changes</a> |
      <a href="javascript:if(confirm(%27http://www.opensips.org/Site/Search  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Site/Search%27" tppabs="http://www.opensips.org/Site/Search">Search</a></div>
    <div class='lastmod'>Page last modified on August 17, 2015, at 06:40 PM</div></div>
<!--HTMLFooter-->
</div>
</body>
</html>
