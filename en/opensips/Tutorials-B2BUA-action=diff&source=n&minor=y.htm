<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title>openSIPS | Documentation / Tutorials-B2BUA | History</title>
  <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel='stylesheet' href="opensips.css" tppabs="http://www.opensips.org/pub/skins/opensips/opensips.css" type='text/css' />
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 4px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
  .editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }

  .diffbox { width:570px; border-left:1px #999999 solid; margin-top:1.33em; }
  .diffauthor { font-weight:bold; }
  .diffchangesum { font-weight:bold; }
  .difftime { font-family:verdana,sans-serif; font-size:66%; 
    background-color:#dddddd; }
  .difftype { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; font-weight:bold; }
  .diffadd { border-left:5px #99ff99 solid; padding-left:5px; }
  .diffdel { border-left:5px #ffff99 solid; padding-left:5px; }
  .diffrestore { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; margin:1.5em 0px; }
  .diffmarkup { font-family:monospace; }  
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script>
  <link href="commentboxplus.css" tppabs="http://www.opensips.org/pub/commentboxplus/commentboxplus.css" rel='stylesheet' type='text/css' />
  <link rel='stylesheet' href="wsplus.css" tppabs="http://www.opensips.org/pub/wsplus/wsplus.css" 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url("csshover.htc")/*tpa=http://www.opensips.org/pub/wsplus/csshover.htc*/; }
    .rollover * { visibility: visible; }
  </style><![endif]-->
  <meta name='robots' content='noindex,nofollow' />

  <link rel="icon" type="image/png" href="http://opensips.org/favicon.png">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','analytics.js'/*tpa=http://www.google-analytics.com/analytics.js*/,'ga');

  ga('create', 'UA-47615177-1', 'http://www.opensips.org/Documentation/opensips.org');
  ga('send', 'pageview');

	function resizeIframe(obj) {
	    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
		  }

  </script>

</head>
<body>
<div id="main">
<!--PageHeaderFmt-->
  <div id='wikilogo'>
  <img class="motto" src="motto.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/motto.jpg" width="328" height="40" alt="The new breed of communication engine.">
  <a href="javascript:if(confirm(%27http://www.opensips.org/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/%27" tppabs="http://www.opensips.org/"><img class="logo" src="logo2.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/logo2.jpg"
    alt='openSIPS' border='0' /></a>
 </div>
 <div id='wikihead'>
 <table border=0>
  <tr valign=top><td width=250>
   
  </td></tr>
  <tr><td width=250>
   <form action="http://www.opensips.org/">
   
    <input type='hidden' name='n' value='Documentation.Tutorials-B2BUA' />
    <input type='hidden' name='action' value='search' />

    <input type='text' name='q' id='formsubmit' value='' class='inputbox searchbox' />
	<input type='submit' id='formbutton' class='inputbutton searchbutton' value=' ' /></form>
  </td></tr>
  </table>
 </div>

<!--/PageHeaderFmt-->
<div id="osTopNav" >
	<div id="osTopNavLeft">
	</div>

	<div id="osTopNavRight">
	</div>

	<ul id="osTopNavList">
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/About/About  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/About/About%27" tppabs="http://www.opensips.org/About/About" title="About">About</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Downloads/Downloads  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Downloads/Downloads%27" tppabs="http://www.opensips.org/Downloads/Downloads" title="Download">Downloads</a>
		</li>
		<li>
			<a href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals" title="Documentation">Documentation</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Community/Foundation-Main  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Community/Foundation-Main%27" tppabs="http://www.opensips.org/Community/Foundation-Main" title="Community">Community</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Development/Development  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Development/Development%27" tppabs="http://www.opensips.org/Development/Development" title="Development">Development</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Support/Contact  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Support/Contact%27" tppabs="http://www.opensips.org/Support/Contact" title="Support">Support</a>
		</li>
	</ul>
</div>
<!--PageMenuFmt-->
<!--/PageMenuFmt-->
  <table width='100%' align="center" cellpadding='0' cellspacing='0' id='wikimid'>
    <tr>
<!--PageLeftFmt-->
      <td valign='top' bgcolor="#E2F8DA" id='wikileft'>
        <p class='sidehead'> <span  style='color: #185662;'> Documentation</span>
</p><ul><li><a class='wikilink' title='Manuals' href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals">Manuals</a>
</li><li><a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Advanced Tutorials</a>
</li><li><a class='wikilink' title='TipsFAQ' href="TipsFAQ.htm" tppabs="http://www.opensips.org/Documentation/TipsFAQ">Tips &amp; FAQ</a>
</li><li><a class='wikilink' title='Migration' href="Migration.htm" tppabs="http://www.opensips.org/Documentation/Migration">Version Migration</a>
</li><li><a class='wikilink' title='Webinars' href="Webinars.htm" tppabs="http://www.opensips.org/Documentation/Webinars">OpenSIPS Webinars</a>
</li><li><a class='wikilink' title='Troubleshooting' href="Troubleshooting.htm" tppabs="http://www.opensips.org/Documentation/Troubleshooting">Troubleshooting</a>
</li><li><a class='wikilink' title='Tools' href="Tools.htm" tppabs="http://www.opensips.org/Documentation/Tools">OpenSIPS Tools</a>
</li><li><a class='wikilink' title='Development-Tutorials' href="Development-Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Development-Tutorials">Devel Tutorial</a>
</li></ul><div class='vspace'></div>
</td>
<!--/PageLeftFmt-->
      <td id='wikibody' valign='top'>
<!--PageTitleFmt-->
        
<!--PageText-->
<div id='wikitext'>
<h2 class='wikiaction'>Documentation.Tutorials-B2BUA History</h2>
  <p><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-B2BUA?action=diff&source=n&minor=n  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-B2BUA?action=diff&source=n&minor=n%27" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=diff&source=n&minor=n">Hide minor edits</a> - <a href="Tutorials-B2BUA-action=diff&source=y&minor=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=diff&source=y&minor=y">Show changes to markup</a></p>
  <div id='wikidiff'>
      <div class='diffbox'><div class='difftime'>May 16, 2013, at 06:00 PM 
        by <span class='diffauthor' title='109.99.235.212'>109.99.235.212</span> - </div>
        <div class='difftype'>Changed line 1 from:</div>
        <div class='diffdel'><h2>Documentation -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; B2BUA</h2>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><h5>Documentation -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; B2BUA</h5>
</div></div>
      <div class='diffrestore'><a href="Tutorials-B2BUA-action=edit&restore=diff-1368720019-1368719972-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit&restore=diff:1368720019:1368719972:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>May 16, 2013, at 05:59 PM 
        by <span class='diffauthor' title='109.99.235.212'>109.99.235.212</span> - </div>
        <div class='difftype'>Changed lines 1-2 from:</div>
        <div class='diffdel'><h2><a class='createlinktext' rel='nofollow' 
    href="Documentation-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Documentation?action=edit">Documentation</a><a rel='nofollow' 
    class='createlink' href="Documentation-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Documentation?action=edit">?</a> -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; <a class='selflink' href="Tutorials-B2BUA.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA">B2BUA</a></h2>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><h2>Documentation -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; B2BUA</h2>
</div>
        <div class='difftype'>Changed line 343 from:</div>
        <div class='diffdel'><p>You can find <a class='createlinktext' rel='nofollow' 
    href="B2bConfigExample-action=edit.htm" tppabs="http://www.opensips.org/Documentation/B2bConfigExample?action=edit">here</a><a rel='nofollow' 
    class='createlink' href="B2bConfigExample-action=edit.htm" tppabs="http://www.opensips.org/Documentation/B2bConfigExample?action=edit">?</a> a configuration file example that loads the two scenarios presented in this tutorial and enables the <strong>prepaid</strong> service for a certain user. Also the mi_fifo module is loaded here and it will be possible to send MI commands to instantiate the <strong>marketing</strong> scenario.
</p>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><p>You can find <a class='wikilink' title='Tutorials-B2BUAConfigExample' href="Tutorials-B2BUAConfigExample.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUAConfigExample">here</a> a configuration file example that loads the two scenarios presented in this tutorial and enables the <strong>prepaid</strong> service for a certain user. Also the mi_fifo module is loaded here and it will be possible to send MI commands to instantiate the <strong>marketing</strong> scenario.
</p>
</div></div>
      <div class='diffrestore'><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit&restore=diff:1368719972:1368184602:&preview=y  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit&restore=diff:1368719972:1368184602:&preview=y%27" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit&restore=diff:1368719972:1368184602:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>May 10, 2013, at 01:16 PM 
        by <span class='diffauthor' title='109.99.235.212'>109.99.235.212</span> - </div>
        <div class='difftype'>Changed line 1 from:</div>
        <div class='diffdel'><h2><a class='createlinktext' rel='nofollow' 
    href="Documentation-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Documentation?action=edit">Documentation.Documentation</a><a rel='nofollow' 
    class='createlink' href="Documentation-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Documentation?action=edit">?</a> -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; <a class='selflink' href="Tutorials-B2BUA.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA">B2BUA</a></h2>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><h2><a class='createlinktext' rel='nofollow' 
    href="Documentation-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Documentation?action=edit">Documentation</a><a rel='nofollow' 
    class='createlink' href="Documentation-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Documentation?action=edit">?</a> -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; <a class='selflink' href="Tutorials-B2BUA.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA">B2BUA</a></h2>
</div></div>
      <div class='diffrestore'><a href="Tutorials-B2BUA-action=edit&restore=diff-1368184602-1368184574-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit&restore=diff:1368184602:1368184574:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>May 10, 2013, at 01:16 PM 
        by <span class='diffauthor' title='109.99.235.212'>109.99.235.212</span> - </div>
        <div class='difftype'>Changed lines 1-2 from:</div>
        <div class='diffdel'><h2>Resources -&gt; <a class='wikilink' title='Documentation' href="javascript:if(confirm(%27http://www.opensips.org/Resources/Documentation  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Resources/Documentation%27" tppabs="http://www.opensips.org/Resources/Documentation">Documentation</a> -&gt; <a class='wikilink' title='DocsTutorials' href="javascript:if(confirm(%27http://www.opensips.org/Resources/DocsTutorials  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Resources/DocsTutorials%27" tppabs="http://www.opensips.org/Resources/DocsTutorials">Tutorials</a>-&gt; B2BUA</h2>
</div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><h2><a class='createlinktext' rel='nofollow' 
    href="Documentation-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Documentation?action=edit">Documentation.Documentation</a><a rel='nofollow' 
    class='createlink' href="Documentation-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Documentation?action=edit">?</a> -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; <a class='selflink' href="Tutorials-B2BUA.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA">B2BUA</a></h2>
</div></div>
      <div class='diffrestore'><a href="Tutorials-B2BUA-action=edit&restore=diff-1368184574-1366818736-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit&restore=diff:1368184574:1366818736:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>April 24, 2013, at 05:52 PM 
        by <span class='diffauthor' title='109.99.235.212'>109.99.235.212</span> - </div>
        <div class='difftype'>Added lines 1-361:</div>
        <div class='diffadd'><h2>Resources -&gt; <a class='wikilink' title='Documentation' href="javascript:if(confirm(%27http://www.opensips.org/Resources/Documentation  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Resources/Documentation%27" tppabs="http://www.opensips.org/Resources/Documentation">Documentation</a> -&gt; <a class='wikilink' title='DocsTutorials' href="javascript:if(confirm(%27http://www.opensips.org/Resources/DocsTutorials  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Resources/DocsTutorials%27" tppabs="http://www.opensips.org/Resources/DocsTutorials">Tutorials</a>-&gt; B2BUA</h2>
<hr />
<div class='vspace'></div><h1>Back-to-Back User Agent</h1>
<p  style='text-align: right;'> <strong>written by Anca Vamanu</strong>
</p>
<p class='vspace'>(:toc Table of Content:)
</p>
<p class='vspace'><a name='Overview' id='Overview'></a>
</p><h2>Overview</h2>
<p>OpenSIPS has many features but in the way it behaves when a media session is established, it is not more than a proxy, meaning that it only takes the messages from one side and pass them on the other side. However, this has proven not to be enough as to provide certain services it is required for the server to be aware of the state of the sessions, monitor and control them. A Back-to-Back User Agent is exactly this, a entity in the SIP network which has the ability to control or start media sessions. The name comes from the behavior, since in fact what is required is for the B2BUA to stand in the middle and establish two dialogs with both end points that will eventually exchange media. 
</p>
<p class='vspace'>B2BUA in OpenSIPS is an implementation of the behavior of a B2BUA as defined in RFC 3261 that offers the possibility to build certain services on top of it. It consists of two modules:
</p><ul><li>b2b_entities - the bottom half, implementing the behavior of UAC and UAS (B2BUA)
</li><li>b2b_logic    - the upper half, implementing a logic for analyzing and applying services scenarios to achieve the desired B2BUA specific services.
</li></ul><p class='vspace'>The picture bellow shows the architecture of the B2BUA implementation.
</p>
<p class='vspace'>http://www.opensips.org/images/B2BUA_architecture.jpg
</p>
<p class='vspace'>The reason for which the architecture has two parts is to allow extensions and integration with other system that might implement their own logic interpretor. Instead of the b2b_logic module, another module with a different logic interpretor or scenario source can be placed there and use the interface that the b2b_entities module offers to build quickly a new B2BUA implementation. The b2b_entities role in the processing is an independent one that is required in any B2B implementation and it is therefore encoded in a separate module. It offer an upper level library that will make the implementation of another logic interpreter and applier much easier. The separation enhances and encourages extension and integration with other systems. 
</p>
<p class='vspace'>The two parts composing B2BUA in OpenSIPS are bound to each other in a control-notify relationship. The b2b_logic module controls the b2b_entities by sending commands and telling it what messages to send and the b2b_entities modules notifies the b2b_logic module when a request or a reply is received for a dialog that the B2B is handling. 
</p>
<div class='vspace'></div><h3>Server Entity and Client Entity </h3>
<p>The name represents in fact the type if transaction entity that is created at the beginning. So there will be a 
</p><ul><li>b2b server entity if it is created when a message is received and has to reply to it 
</li><li>b2b client entity if the entity will have to start a dialog by sending an initial message
</li></ul><div class='vspace'></div><h3>Scenario Instantiation</h3>
<p>The services are defined in documents called scenarios. A scenario instantiation is an application of a scenario that is currently in progress. The b2b_logic module might be told to initialize a scenario in two ways: from the script, by calling a function that the module exports when an initial request is received, or by sending an external command. When receiving one of this two events, the b2b_logic module will create a record(corresponding to the red small boxes in the drawing) with the information for that scenario instantiation. Also at this moment, the b2b_logic module tells the b2b_entities module to create the entities(server and/or clients) that it requires. The record mainly stores a relation to the scenario document that it must follow, the state of the scenario application and the identifiers for the entities in b2b_entities module.
</p>
<div class='vspace'></div><h3>Communication with the exterior</h3>
<p>As can be seen in the picture, the b2b_entities module is the bottom half part of B2BUA and it deals with the actual network message exchange. To achieve this it uses directly the functions provided by the <strong>tm</strong> module for sending requests and replies and for receiving replies. Also the tm module announce it when a reply for a request that it has sent is received. For requests inside dialog, the b2b_entities module registers a prescript function that catches this requests. In the current implementation, this requests don't go into the script because the prescript function returns '0'. As mentioned earlier, when receiving a reply or request that is matched to a known dialog, the b2b_entities module does no further action but notifies the b2b_logic module about this event. The b2b_logic module which is the upper half, will then decide what actions should be taken and sends back control commands to the b2b_entities module. 
</p>
<p class='vspace'><a name='Initiating_B2B_services' id='Initiating_B2B_services'></a>
</p><h2>Initiating B2B services</h2>
<p>There are two ways to trigger a B2B service.
</p><ul><li>from script
</li><li>with an MI command
</li></ul><p class='vspace'>The function that can be called from the script has the name <strong>b2b_init_request</strong> and has 6 parameters:
</p>
<p class='vspace'><strong>b2b_init_request</strong> ( scenario_name, param1, param2, param3, param4, param5)
</p>
<p class='vspace'><span  style='color: #ff7f00;'> NOTE: This function has to be called on the initial Invite only ( the B2BUA must be in the middle of the call from the beginning). </span>
</p>
<p class='vspace'>The first parameter is the name of the scenario to be instantiated. So it is the job of the script writer to decide when a certain scenario should be applied . The next arguments are parameters needed by the scenario. As it shall be seen later, a scenario can require some values to be given as parameters in contrast to hard coding them, making the scenario configurable. 
</p>
<p class='vspace'>The MI command has the name <strong>b2b_trigger_scenario</strong> and takes exactly the same parameters as the script function.
</p>
<p class='vspace'><span  style='color: #ff7f00;'> Ex: </span><span  style='color: black;'><strong>Fifo MI command</strong></span>
</p><div class='frame lfloat frame lfloat' style='color: black;' > 
<p>:b2b_trigger_scenario:fifo_reply<br clear='all' />
marketing<br clear='all' />
sip:bob@opensips.org<br clear='all' />
sip:322@opensips.org:5070<br clear='all' />
sip:alice@opensips.org
_empty_line_
</p></div>
<p class='vspace'><br clear='all' />
<br clear='all' />
There is one predefined service that works without any scenario definition and for any type of dialog. This is <strong>topology hiding</strong> service. The functionality is obvious from the name and what this service does is to hide the network topology from the parties that establish a dialog. To achieve this, the B2BUA poses itself in the middle and established dialogs with both parties. Then all it will do next will be to translate a receipt request or reply into the dialog from the other side and forward it to the peer entity.
</p>
<p class='vspace'>This service can only be selected from the script, because it has sense only when a dialog is initiated. It does not require any parameter. The id for this scenario is <strong>top hiding</strong>.
</p>
<p class='vspace'><span  style='color: #ff7f00;'> Ex:</span><span  style='color: black;'> <strong>Calling top hiding service</strong></span>
</p><div class='frame lfloat' > 
<pre><span style="color: #008;">if</span><span style="color: #660;">(</span><span style="color: #000;">is_method</span><span style="color: #660;">(</span><span style="color: #080;">"INVITE"</span><span style="color: #660;">)</span><span style="color: #000;"> </span><span style="color: #660;">&amp;&amp;</span><span style="color: #000;"> src_ip</span><span style="color: #660;">==</span><span style="color: #080;">"10.10.10.10"</span><span style="color: #660;">)</span><span style="color: #000;"><br>&nbsp; &nbsp;b2b_init_request</span><span style="color: #660;">(</span><span style="color: #080;">"top hiding"</span><span style="color: #660;">);</span></pre>
</div>
<p><br clear='all' />
Other services must be defined in scenario documents and loaded at startup by providing the path towards them as module parameters as presented in the following chapter.
</p>
<p class='vspace'><a name='Loading_scenarios' id='Loading_scenarios'></a>
</p><h2>Loading scenarios</h2>
<p>The scenario documents are loaded at startup and their paths in the system must be provided through module parameters that belong to the b2b_logic module. There are two parameters, one of each type of scenario: <strong>scenario_script</strong> and <strong>scenario_extern</strong>. 
</p>
<p class='vspace'><span  style='color: #ff7f00;'> Ex:</span><span  style='color: black;'> <strong>Loading B2BUA scenarios</strong></span>
</p><div class='frame lfloat' > 
<pre><span style="color: #000;">modparam</span><span style="color: #660;">(</span><span style="color: #080;">"b2b_logic"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #080;">"script_scenario"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #080;">"/usr/local/opensips/etc/b2bua/scenario_script.xml"</span><span style="color: #660;">)</span><span style="color: #000;"><br>modparam</span><span style="color: #660;">(</span><span style="color: #080;">"b2b_logic"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #080;">"extern_scenario"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #080;">"/usr/local/opensips/etc/b2bua/scenario_extern.xml"</span><span style="color: #660;">)</span></pre>
</div>
<p><br clear='all' />
</p>
<p class='vspace'><a name='B2BUA_scenario_format' id='B2BUA_scenario_format'></a>
</p><h2>Scenario format</h2>
<p>The scenarios are defined as XML documents because of their adaptability and because they are easy to understand and write. 
</p>
<p class='vspace'>A scenario is a predefined behavior that will be interpreted by the B2B Logic. The decision when the the scenario will be applied must be taken by the server administrator in the configuration file or triggered by an extern application with an MI command.
</p>
<p class='vspace'>The scenario is not rigid, but configurable through some parameters that will have to be provided to the B2B logic when requesting the instantiation of a certain scenario.
</p>
<div class='vspace'></div><h3>Scenario root</h3>
<p>The <strong>root</strong> element has the tag 'scenario'. 
<br clear='all' />
<span  style='color: #ff7f00;'> Ex: </span><span  style='color: black;'><strong>Scenario root node example</strong></span>
</p><div class='frame lfloat' > 
<pre><span style="color: #660;">&lt;</span><span style="color: #008;">scenario</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #080;">"prepaid"</span><span style="color: #000;"> </span><span style="color: #606;">name</span><span style="color: #660;">=</span><span style="color: #080;">"MS start and end"</span><span style="color: #000;"> </span><span style="color: #606;">param</span><span style="color: #660;">=</span><span style="color: #080;">"2"</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"script"</span><span style="color: #660;">&gt;</span></pre>
</div>
<p><br clear='all' />
</p>
<p class='vspace'>It has three parameters:
</p>
<div class='vspace'></div><ul><li><strong>id –</strong> the identifier for the scenario. It will be provided to the logic when desiring to instantiate the scenario.
</li><li><strong>name</strong> – a more explicit name. It has meaning only for the reader, with no importance for the B2BUA.
</li><li><strong>param</strong> – the number of parameters the scenario requires. 
</li><li><strong>type</strong> – the type of the scenario. It can be <em>script</em> or <em>extern.</em> This parameter as the name parameter is not meaningful to the B2BUA but to the reader. 
</li></ul><p class='vspace'>A B2B scenario document has two parts:
</p>
<div class='vspace'></div><ul><li>a <strong>init</strong> section 
</li><li>a <strong>rules</strong> section
</li></ul><div class='vspace'></div><h3>Init section</h3>
<p>The <strong>init</strong> section provides indications about the entities that must be created at the beginning of the scenario. The <strong>init</strong> node has as a subnode a <strong>bridging</strong> node meaning that the entities created there will eventually be connected in a media session.
</p>
<p class='vspace'>There can be two types of entities:
</p>
<div class='vspace'></div><ul><li><strong>server entity</strong> – for the first transaction the entity will behave as a UAS. This can be created only if there is a INVITE message that the entity will have to deal with. Server entities can appear only in scrip scenarios.
</li><li><strong>client entity</strong> - a entity that has to start a dialog and send an initial message to a SIP endpoint.
</li></ul><p class='vspace'>Some parameters must be defined for the entities. Both server and client entities must be given an <strong>id</strong> that will be used to identify the entity later in the script. For the server entity no other parameters need to be defined.
</p>
<p class='vspace'>For the client entities it is compulsory to define the destination where the messages will be sent. For this a <strong>destination</strong> sub node must be defined. The syntax of the destination node is:
</p>
<p class='vspace'>The destination value can be provided in more ways 
<br clear='all' />
<span  style='color: #ff7f00;'> Ex: </span><span  style='color: black;'><strong>Scenario destination node example</strong></span>
</p><div class='frame lfloat' > 
<pre><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"_value_type_"</span><span style="color: #660;">&gt;</span><span style="color: #000;">_value_</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span></pre>
</div>
<p><br clear='all' />
<br clear='all' />
<span  style='color: #ff7f00;'> Table: </span><span  style='color: black;'><strong>Scenario destination node structure</strong></span>
</p>
<table border='1' ><tr ><td >Value source</td><td >Value type</td><td >Example</td></tr>
<tr ><td  align='left'>Inline URI</td><td  align='left'>"uri"</td><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"uri"</span><span style="color: #660;">&gt;</span><span style="color: #000;">sip:ms@opensips.org</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span></pre></td></tr>
<tr ><td >Parameter.The value node content is a number and represents the number of the parameter.</td><td >"param"</td><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span></pre></td></tr>
<tr ><td >Initial destination.Used when the bridging is based on a received message. The destination will be that from the message.</td><td >"initial"</td><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"initial"</span><span style="color: #660;">&gt;&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span></pre></td></tr>
<tr ><td  align='left'>Header body.Take the URI from the body of a header. The first header with that name will be used.</td><td  align='left'>"header"</td><td  align='right'><pre><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"header"</span><span style="color: #660;">&gt;</span><span style="color: #000;">Refer-To</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span></pre></td></tr>
</table>
<p class='vspace'>The client entity can also have a <strong>type</strong> subnode. The only defined value for this node is <strong>'message</strong>'. If type node with message value is present, it means that the client will be created using the info from received SIP message: the body, the caller URI, some SIP headers(Accept, Supported, Content-Type). Defining this node does not mean that the destination will be taken from this message and still a destination node must be defined. 
</p>
<p class='vspace'>In addition to the bridging node, you can also define a state node. The meaning of states in the b2b scenario is that of labels in the evolution of the scenario that can be used as conditions when defining rules. A <strong>state </strong>node in the <strong>init</strong> node specifies the state that the scenario instantiation will enter after the init part will be executed. 
</p>
<p class='vspace'>Below there are two examples of scenario init parts, one that creates entities based on a received message and in 
which the dialog is initiated by the b2bua that puts two entities in contact.
</p>
<p class='vspace'><br clear='all' />
<span  style='color: #ff7f00;'> Table: </span><span  style='color: black;'><strong>Scenario init node examples</strong></span>
</p>
<table border='1' ><tr ><td ><strong>Script scenario</strong></td><td ><strong>Extern Scenario</strong></td></tr>
<tr ><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">server</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">server1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">server</span><span style="color: #660;">&gt;</span><span style="color: #000;"> <br><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;">message</span><span style="color: #660;">&lt;/</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">lifetime</span><span style="color: #660;">&gt;</span><span style="color: #000;">120</span><span style="color: #660;">&lt;/</span><span style="color: #008;">lifetime</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span><span style="color: #000;"> </span></pre></td><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;">2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">lifetime</span><span style="color: #660;">&gt;</span><span style="color: #000;">300</span><span style="color: #660;">&lt;/</span><span style="color: #008;">lifetime</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp;<br>&nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span></pre></td></tr>
</table>
<div class='vspace'></div><h3>Rules section</h3>
<p>The rules have two parts:
</p>
<div class='vspace'></div><ul><li>condition
</li><li>action
</li></ul><p class='vspace'>The condition part decides whether a rule should be applied for the current event. The events are represented by the receipt of a SIP request or SIP reply. The action part may define a request or reply to be sent out.
</p>
<p class='vspace'>In the scenario document, the rules node has two children, requests and replies, separating the two types of events. Then both replies and requests have children with names of the possible requests inside dialog: 'invite', 'ack', 'bye' and for each more rules can be defined.
</p>
<p class='vspace'><span  style='color: #ff7f00;'> Ex: </span><span  style='color: black;'><strong>Scenario rules node structure</strong></span>
<br clear='all' />
</p><div class='frame lfloat' > 
<pre><span style="color: #660;">&lt;</span><span style="color: #008;">rules</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">request</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">bye</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">rule</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #000;"> ”</span><span style="color: #606;">1</span><span style="color: #000;">”</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; ...<br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">rule</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">rule</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #000;"> ”</span><span style="color: #606;">2</span><span style="color: #000;">”</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; ...<br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">rule</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">bye</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">request</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">rules</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span></pre>
</div>
<p><br clear='all' />
</p>
<div class='vspace'></div><h4>Rules condition part</h4>
<p>The extra conditions that can be defined for a rule filter the scenario state and the direction of the message. 
</p>
<p class='vspace'>A condition will be matched if the scenario instantiation is in the same state as the state specified in the condition. 
</p>
<p class='vspace'>The direction of a message is specified with a <strong>sender</strong> node. The sender can be a certain entity specified with a type and an id, or a entity category, being sufficient to specify only the type.
</p>
<p class='vspace'><br clear='all' />
<span  style='color: #ff7f00;'> Ex: </span><span  style='color: black;'><strong>Scenario condition node</strong></span>
</p><div class='frame lfloat' > 
<pre><span style="color: #660;">&lt;</span><span style="color: #008;">condition</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">sender</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;">client</span><span style="color: #660;">&lt;/</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">sender</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">condition</span><span style="color: #660;">&gt;</span></pre>
</div>
<p><br clear='all' />
</p>
<div class='vspace'></div><h4>Rules action part</h4>
<p>In this first version there are four possible actions, with the possibility to extend them in the future. The actions are described in the table bellow. 
</p>
<p class='vspace'><br clear='all' />
<span  style='color: #ff7f00;'> Table: </span><span  style='color: black;'><strong>Scenario rules node structure</strong></span>
</p>
<div class='vspace'></div>
<table border='1' ><tr ><td ><strong>Node name</strong></td><td ><strong>Description</strong></td><td ><strong>Example</strong></td></tr>
<tr ><td >send_reply</td><td >This node tells the B2BUA to send a reply to the sender of the current message. A code and reason sub node must be defined.</td><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;">200</span><span style="color: #660;">&lt;/</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;">OK</span><span style="color: #660;">&lt;/</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span></pre></td></tr>
<tr ><td >delete_entity</td><td >The delete_entity node specifies to the B2B Logic that the current entity which has received the message can be deleted.</td><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">delete_entity</span><span style="color: #660;">/&gt;</span></pre></td></tr>
<tr ><td >bridge</td><td >A bridge action means putting two end points in contact. The syntax is the same as the one for the bridge node in the init part. The only difference here is that the entities can be also existing ones. To refer to an existing entity, you must use the same "id". If a new entity has to be created, a <strong>&lt;destination&gt;</strong> node must be present. To force the creation of a new entity, insert a <strong>&lt;new/&gt;</strong> subnode for the client. The client node also allows a <strong>&lt;lifetime&gt;</strong> subnode. It defines the maximum duration of the media session and it is used to track blocked scenario instantiations. If the lifetime expires, the B2BUA will send BYE messages to both ends and delete the record. This parameter is not compulsory and should be defined when a maximum lifetime value is known(most likely in the case of recorded messages played by media servers).</td><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client3</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp;3</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">lifetime</span><span style="color: #660;">&gt;</span><span style="color: #000;">79800</span><span style="color: #660;">&lt;/</span><span style="color: #008;">lifetime</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span></pre></td></tr>
<tr ><td >state</td><td >Specifies the state the scenario instantiation will enter after the action will be executed.</td><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span></pre></td></tr>
<tr ><td >end_dialog_leg</td><td >This node tells the B2BUA to end the call that has just received an event ( request or reply). The B2BUA will send a BYE request to the party.</td><td ><pre><span style="color: #660;">&lt;</span><span style="color: #008;">end_dialog_leg</span><span style="color: #660;">/&gt;</span></pre></td></tr>
</table>
<p class='vspace'>Bellow is an action example:
<br clear='all' />
<span  style='color: #ff7f00;'> Ex: </span><span  style='color: black;'><strong>Scenario action node</strong></span>
</p><div class='frame lfloat' > 
<pre><span style="color: #660;">&lt;</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;">200</span><span style="color: #660;">&lt;/</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;">OK</span><span style="color: #660;">&lt;/</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">delete_entity</span><span style="color: #660;">/&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">server1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"initial"</span><span style="color: #660;">&gt;</span><span style="color: #000;">server1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span></pre>
</div>
<p><br clear='all' />
</p>
<p class='vspace'><a name='Scenario_examples' id='Scenario_examples'></a>
</p><h2>Scenario Examples</h2>
<h3>Topology Hiding</h3>
<p>No scenario document must be defined for this usage case. This is a built in mechanism and it
can be requested to the B2B Logic by specifying the name "top hiding".
The functionality is a simple pass through with the creation of a new dialog on the other side
and transferring all the messages received on one side to the other side taking care only to
change the dialog information.
</p>
<div class='vspace'></div><h4>Scenario Schema</h4>
<p>Here is the theoretical expected message trace:
</p>
<p class='vspace'>http://www.opensips.org/images/top_hiding_schema.jpeg
</p>
<div class='vspace'></div><h3>Prepaid</h3>
<p>This scenario can be used by a company for prepaid users to announce them at the beginning of the call what their credit is and at the end of the call what their remaining credit is. 
</p>
<p class='vspace'>What must happen at session level is:
</p>
<div class='vspace'></div><ol><li>the caller is connected to a media server
</li><li>the caller is connected to the callee
</li><li>if the callee hangs up the phone before the caller, the caller is connected to a media server (the same or other).
</li></ol><p class='vspace'>In B2BUA terms, this is a script scenario that can be instantiating by specifying the id <strong>prepaid</strong>. It requires 2 parameters:
</p><ul><li>the location of the first media server
</li><li>the location of the second media server
</li></ul><div class='vspace'></div><h4>Scenario Schema</h4>
<p>To establish this sessions the SIP message flow has to look like this( it is assumed that the
same media server is used):
</p>
<p class='vspace'>http://www.opensips.org/images/ppaid.jpeg
</p>
<div class='vspace'></div><h4>Scenario Document</h4>
<p>The full scenario document is printed bellow:
</p><div class='frame lfloat' > 
<pre><span style="color: #660;">&lt;?</span><span style="color: #000;">xml version</span><span style="color: #660;">=</span><span style="color: #080;">"1.0"</span><span style="color: #660;">?&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;</span><span style="color: #008;">scenario</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #080;">"prepaid"</span><span style="color: #000;"> </span><span style="color: #606;">name</span><span style="color: #660;">=</span><span style="color: #080;">"MS start and end"</span><span style="color: #000;"> </span><span style="color: #606;">param</span><span style="color: #660;">=</span><span style="color: #080;">"2"</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"script"</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">server</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">server1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">server</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;">message</span><span style="color: #660;">&lt;/</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">rules</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">request</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">bye</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">rule</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #080;">"1"</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">condition</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">sender</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;">client</span><span style="color: #660;">&lt;/</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">sender</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">condition</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;">200</span><span style="color: #660;">&lt;/</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;">OK</span><span style="color: #660;">&lt;/</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">delete_entity</span><span style="color: #660;">/&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">server1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"initial"</span><span style="color: #660;">&gt;</span><span style="color: #000;">server1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">rule</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">rule</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #080;">"2"</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">condition</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">sender</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;">client</span><span style="color: #660;">&lt;/</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">sender</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">condition</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;">200</span><span style="color: #660;">&lt;/</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;">OK</span><span style="color: #660;">&lt;/</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">delete_entity</span><span style="color: #660;">/&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">server1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client3</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;">2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">3</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">rule</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">bye</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">request</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">rules</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">scenario</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span></pre>
</div>
<p><br clear='all' />
</p>
<div class='vspace'></div><h3>Marketing</h3>
<p>The last test case is called “Marketing”, because it suits very well to the requirements of a marketing campaign through phone. The company might choose a list of potential costumers to call and announce about a new product/offer/discount. The message will be a recorded one, but the costumer will also be offered the possibility to talk to a human operator. If the costumer does not hung up the phone before the recorded message ends, it will be connected to a human operator. This is also a good means to filter the interested costumers and make the process more efficient with less resources used. 
</p>
<p class='vspace'>The OpenSIPS B2BUA must connect two end points, start the call from the middle. It is different from the other examples, since the call is initiated by the B2BUA and it is triggered by a MI command. 
</p>
<p class='vspace'>The id which must be mentioned to start this service is 'marketing'. It requires 3 parameters
</p><ul><li>the URI of the possible costumer
</li><li>the URI of the media server
</li><li>the URI of the human operator
</li></ul><div class='vspace'></div><h4>Scenario Schema</h4>
<p>Below is the theoretical message flow that should occur for this functionality to be achieved.
</p>
<p class='vspace'>http://www.opensips.org/images/marketing.jpeg
</p>
<div class='vspace'></div><h4>Scenario Document</h4>
<p>The scenario document that describes this service is:
</p><div class='frame lfloat' > 
<pre><span style="color: #660;">&lt;?</span><span style="color: #000;">xml version</span><span style="color: #660;">=</span><span style="color: #080;">"1.0"</span><span style="color: #660;">?&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;</span><span style="color: #008;">scenario</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #080;">"marketing"</span><span style="color: #000;"> </span><span style="color: #606;">name</span><span style="color: #660;">=</span><span style="color: #080;">"MS start conditional"</span><span style="color: #000;"> </span><span style="color: #606;">param</span><span style="color: #660;">=</span><span style="color: #080;">"3"</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"extern"</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;">2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br><br>&nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">rules</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">request</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">bye</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">rule</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #080;">"1"</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">condition</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">sender</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;">client</span><span style="color: #660;">&lt;/</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">sender</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">condition</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;">200</span><span style="color: #660;">&lt;/</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;">OK</span><span style="color: #660;">&lt;/</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">delete_entity</span><span style="color: #660;">/&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client3</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"param"</span><span style="color: #660;">&gt;</span><span style="color: #000;">3</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;">2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">state</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">rule</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">bye</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">request</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">rules</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">scenario</span><span style="color: #660;">&gt;</span></pre>
</div>
<p><br clear='all' />
</p>
<div class='vspace'></div><h3>REFER Scenario</h3>
<p>The B2BUA component can also be configured to handle blind transfers(with REFER SIP message). This is useful when in the platform there are devices that do not accept the REFER method. The scenario for this case is very simple and has one rule for when a REFER is received. This rule tells the B2BUA to end the call with the user agent that sent the refer message and to bridge the peer with the user specified in the 'Refer-To' header.
</p>
<div class='vspace'></div><h4>Scenario Document</h4>
<p>The scenario document that describes this service is:
</p><div class='frame lfloat' > 
<pre><span style="color: #660;">&lt;?</span><span style="color: #000;">xml version</span><span style="color: #660;">=</span><span style="color: #080;">"1.0"</span><span style="color: #660;">?&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;</span><span style="color: #008;">scenario</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #080;">"refer"</span><span style="color: #000;"> </span><span style="color: #606;">name</span><span style="color: #660;">=</span><span style="color: #080;">"Handle refer at server"</span><span style="color: #000;"> </span><span style="color: #606;">param</span><span style="color: #660;">=</span><span style="color: #080;">"0"</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"script"</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">server</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">server1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">server</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;">message</span><span style="color: #660;">&lt;/</span><span style="color: #008;">type</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"initial"</span><span style="color: #660;">&gt;</span><span style="color: #000;">server1</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">init</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br><br>&nbsp; </span><span style="color: #660;">&lt;</span><span style="color: #008;">rules</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">request</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">refer</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">rule</span><span style="color: #000;"> </span><span style="color: #606;">id</span><span style="color: #660;">=</span><span style="color: #080;">"1"</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;">202</span><span style="color: #660;">&lt;/</span><span style="color: #008;">code</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;">Accepted</span><span style="color: #660;">&lt;/</span><span style="color: #008;">reason</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">send_reply</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">end_dialog_leg</span><span style="color: #660;">/&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">peer</span><span style="color: #660;">/&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;">client2</span><span style="color: #660;">&lt;/</span><span style="color: #008;">id</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;</span><span style="color: #008;">value</span><span style="color: #000;"> </span><span style="color: #606;">type</span><span style="color: #660;">=</span><span style="color: #080;">"header"</span><span style="color: #660;">&gt;</span><span style="color: #000;">Refer-To</span><span style="color: #660;">&lt;/</span><span style="color: #008;">value</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">destination</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">client</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">bridge</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">action</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">rule</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: #660;">&lt;/</span><span style="color: #008;">refer</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; &nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">request</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br>&nbsp; </span><span style="color: #660;">&lt;/</span><span style="color: #008;">rules</span><span style="color: #660;">&gt;</span><span style="color: #000;"><br></span><span style="color: #660;">&lt;/</span><span style="color: #008;">scenario</span><span style="color: #660;">&gt;</span></pre>
</div>
<p><br clear='all' />
</p>
<p class='vspace'><a name='Configuration_file_example' id='Configuration_file_example'></a>
</p><h2>Configuration file</h2>
<p><span  style='color: #ff7f00;'> You must note that, a call that is handled by the B2B will not have the normal ‘proxy like’ interaction with the script.</span>
</p>
<p class='vspace'>Once you ask b2b to handle a call, you <strong>won't see the future in-dialog request in the normal route</strong>. The reason is that in the normal route you do proxy operations - changes on the message, routing decisions, but for the b2b calls those requests will have the b2b as an endpoint. The b2b will then generate new messages that will be sent on the other side. It will not forward the received ones. Those new generated can be accessed in local_route.
</p>
<p class='vspace'>If the scenario is called from script on an initial Invite, you must take care to drop this request after calling b2b_init_request() function on it ( call 'exit', don't call t_relay() on it ).
</p>
<p class='vspace'>When using b2b all the changes that you want to perform on a message must be done in local_route on the new generated request that will be sent out.
</p>
<p class='vspace'>Because sometimes it is required to also access the received requests, you can define a special route <strong>b2b_request route</strong> where you can do 'read-only' operation on the request, like accounting or logging.
Also, you can define a special <strong>b2b_reply route</strong> where you can see the received replies.
</p>
<p class='vspace'>As a conclusion, when a call is handled by the b2bua, SIP messages for that call will be accessible in:
</p><ul><li><strong>b2b_request route</strong> : the received requests. This request will not be forwarded so doing changes on the message will have no effect. This route is useful for logging and accounting.
</li><li><strong>b2b_reply route</strong>  : the received replies. The same as with the requests, it has no effect to do changes on it.
</li><li><strong>local_route</strong> : the SIP requests that are sent out by the b2bua. Here changes on the message can be performed.
</li></ul><p class='vspace'><span  style='color: #ff7f00;'> Also, note that <strong>dialog</strong> module does not work with B2BUA. The reason is that this module was designed to handle proxy dialogs. </span>
</p>
<div class='vspace'></div><h3>Writing the configuration file</h3>
<p>There are some requirements for a configuration file that enables the B2BUA services.
</p>
<div class='vspace'></div><ul><li>load modules <strong>b2b_entities</strong> and <strong>b2b_logic</strong>
</li><li>set module parameters
<ul><li>compulsory: the <strong>server_address</strong> parameter in b2b_entities
</li><li>optional:
<ul><li><strong>script_scenario</strong> and <strong>extern_scenario</strong> in b2b_logic for loading service scenarios
</li><li>parameters for the hash tables - server_hsize and client_hsize in b2b_entities module and <strong>hash_size</strong> in b2b_logic module
</li></ul></li></ul><div class='vspace'></div></li><li>load a MI module if you need to support triggering B2BUA scenarios with extern commands. Depending on the transport you require, either mi_fifo or mi_xmlrpc or mi_datagram. 
</li><li>built the filters and call the script scenario instantiating function 
</li></ul><p class='vspace'>Also please note that you need to configure the tm module to pass provisional replies. For this you need to set the module parameter:
</p>
<div class='vspace'></div><div class='frame lfloat frame lfloat' style='color: blue;' > 
<pre><span style="color: #000;">modparam</span><span style="color: #660;">(</span><span style="color: #080;">"tm"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #080;">"pass_provisional_replies"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #066;">1</span><span style="color: #660;">)</span></pre>
</div>
<p><br clear='all' />
</p>
<div class='vspace'></div><h3>Example</h3>
<p>You can find <a class='createlinktext' rel='nofollow' 
    href="B2bConfigExample-action=edit.htm" tppabs="http://www.opensips.org/Documentation/B2bConfigExample?action=edit">here</a><a rel='nofollow' 
    class='createlink' href="B2bConfigExample-action=edit.htm" tppabs="http://www.opensips.org/Documentation/B2bConfigExample?action=edit">?</a> a configuration file example that loads the two scenarios presented in this tutorial and enables the <strong>prepaid</strong> service for a certain user. Also the mi_fifo module is loaded here and it will be possible to send MI commands to instantiate the <strong>marketing</strong> scenario.
</p>
<div class='vspace'></div><h3>Script routes</h3>
<h4>Special B2B route</h4>
<p>The requests and replies that are received by the B2BUA server, belonging to the dialogs it is handling will not go into the script as normal request do. The reason for this is that this are not normal requests where the server is a proxy, but the server is an endpoint in the dialog and therefore they should not go through the same routes. However, it is normal for this request to be seen from the script and allow the script writer to do the processing it desires based on them. For this, it is possible to define two special B2B routes - one for requests and one for replies. The routes are of type <strong>route</strong> and have their name defined in the modules parameters <strong>script_req_route</strong> and <strong>script_reply_route</strong>.
</p>
<div class='vspace'></div><div class='frame lfloat frame lfloat' style='color: blue;' > 
<pre><span style="color: #000;">modparam</span><span style="color: #660;">(</span><span style="color: #080;">"b2b_entities"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #080;">"script_req_route"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #080;">"b2b_request"</span><span style="color: #660;">)</span><span style="color: #000;"><br>modparam</span><span style="color: #660;">(</span><span style="color: #080;">"b2b_entities"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #080;">"script_reply_route"</span><span style="color: #660;">,</span><span style="color: #000;"> </span><span style="color: #080;">"b2b_reply"</span><span style="color: #660;">)</span><span style="color: #000;"><br><br>route</span><span style="color: #660;">[</span><span style="color: #000;">b2b_request</span><span style="color: #660;">]</span><span style="color: #000;"> </span><span style="color: #660;">{</span><span style="color: #000;"><br>&nbsp; xlog</span><span style="color: #660;">(</span><span style="color: #080;">"b2b_request ($ci)\n"</span><span style="color: #660;">);</span><span style="color: #000;"><br></span><span style="color: #660;">}</span><span style="color: #000;"><br><br><br>route</span><span style="color: #660;">[</span><span style="color: #000;">b2b_reply</span><span style="color: #660;">]</span><span style="color: #000;"> </span><span style="color: #660;">{</span><span style="color: #000;"><br>&nbsp; xlog</span><span style="color: #660;">(</span><span style="color: #080;">"b2b_reply ($ci)\n"</span><span style="color: #660;">);</span><span style="color: #000;"><br></span><span style="color: #660;">}</span></pre>
</div>
<p><br clear='all' />
</p>
<div class='vspace'></div><h4>Failure route not available for B2B</h4>
<p>It is impossible to have a <strong>t_on_failure()</strong> mechanism  (which is transaction specific) on a B2BUA scenario (where you have multiple dialogs, with multiple transactions) - for complex scenarios, with multiple dialogs, you cannot say for which transaction to trigger the failure route for. The "topo hiding" scenario is a very simple B2BUA scenario, but you cannot have a general "on_failure" concept for all b2bua scenarios.
</p>
<p class='vspace'>A solution is to consider that b2bua is a separate instance (logically speaking) which selects types/classes of destinations. A proxy instance will responsible for routing inside the class of destinations.
</p>
<p class='vspace'>For ex: in a scenario we can sent in the first place the call to Media Server for some announcement and later to PSTN GW. In a first step, the b2bua scenario will sent to proxy the call with RURI pointing to "a class"
of media servers - the proxy will select the proper media server and do the failover between the media servers, totally transparent for the b2bua. In a similar way, on the second step, the b2bua scenario will indicate to proxy that it wants to have the call to be sent to PSTN GW (as type of destination) - the proxy will do lcr, drouting,  failover between the GW.
</p>
</div></div>
      <div class='diffrestore'><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit&restore=diff:1366818736:1366818736:&preview=y  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit&restore=diff:1366818736:1366818736:&preview=y%27" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit&restore=diff:1366818736:1366818736:&preview=y">Restore</a></div></div></div>
  
<!--PageRightFmt--><!--/PageRightFmt--></td>
</tr></table>
<!--PageFooterFmt-->
  <div id='wikifoot'>
  <hr class="bottomline" /></td>
    <div class='footnav'>
	
      <a rel="nofollow" href="Tutorials-B2BUA-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=edit">Edit</a> |
      <a rel="nofollow" href="Tutorials-B2BUA-action=diff.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=diff">History</a> |
      <a rel="nofollow" href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-B2BUA?action=print  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-B2BUA?action=print%27" tppabs="http://www.opensips.org/Documentation/Tutorials-B2BUA?action=print" target='_blank'>Print</a> |
      <a href="RecentChanges.htm" tppabs="http://www.opensips.org/Documentation/RecentChanges">Recent Changes</a> |
      <a href="javascript:if(confirm(%27http://www.opensips.org/Site/Search  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Site/Search%27" tppabs="http://www.opensips.org/Site/Search">Search</a></div>
    <div class='lastmod'>Page last modified on May 16, 2013, at 06:00 PM</div></div>
<!--HTMLFooter-->
</div>
</body>
</html>
