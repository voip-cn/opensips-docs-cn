<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title>openSIPS | Documentation / Tutorials-Presence-PuaXmppConfig | History</title>
  <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel='stylesheet' href="opensips.css" tppabs="http://www.opensips.org/pub/skins/opensips/opensips.css" type='text/css' />
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 4px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
  .editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }

  .diffbox { width:570px; border-left:1px #999999 solid; margin-top:1.33em; }
  .diffauthor { font-weight:bold; }
  .diffchangesum { font-weight:bold; }
  .difftime { font-family:verdana,sans-serif; font-size:66%; 
    background-color:#dddddd; }
  .difftype { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; font-weight:bold; }
  .diffadd { border-left:5px #99ff99 solid; padding-left:5px; }
  .diffdel { border-left:5px #ffff99 solid; padding-left:5px; }
  .diffrestore { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; margin:1.5em 0px; }
  .diffmarkup { font-family:monospace; }  
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script>
  <link href="commentboxplus.css" tppabs="http://www.opensips.org/pub/commentboxplus/commentboxplus.css" rel='stylesheet' type='text/css' />
  <link rel='stylesheet' href="wsplus.css" tppabs="http://www.opensips.org/pub/wsplus/wsplus.css" 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url("csshover.htc")/*tpa=http://www.opensips.org/pub/wsplus/csshover.htc*/; }
    .rollover * { visibility: visible; }
  </style><![endif]-->
  <meta name='robots' content='noindex,nofollow' />

  <link rel="icon" type="image/png" href="http://opensips.org/favicon.png">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','analytics.js'/*tpa=http://www.google-analytics.com/analytics.js*/,'ga');

  ga('create', 'UA-47615177-1', 'http://www.opensips.org/Documentation/opensips.org');
  ga('send', 'pageview');

	function resizeIframe(obj) {
	    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
		  }

  </script>

</head>
<body>
<div id="main">
<!--PageHeaderFmt-->
  <div id='wikilogo'>
  <img class="motto" src="motto.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/motto.jpg" width="328" height="40" alt="The new breed of communication engine.">
  <a href="javascript:if(confirm(%27http://www.opensips.org/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/%27" tppabs="http://www.opensips.org/"><img class="logo" src="logo2.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/logo2.jpg"
    alt='openSIPS' border='0' /></a>
 </div>
 <div id='wikihead'>
 <table border=0>
  <tr valign=top><td width=250>
   
  </td></tr>
  <tr><td width=250>
   <form action="http://www.opensips.org/">
   
    <input type='hidden' name='n' value='Documentation.Tutorials-Presence-PuaXmppConfig' />
    <input type='hidden' name='action' value='search' />

    <input type='text' name='q' id='formsubmit' value='' class='inputbox searchbox' />
	<input type='submit' id='formbutton' class='inputbutton searchbutton' value=' ' /></form>
  </td></tr>
  </table>
 </div>

<!--/PageHeaderFmt-->
<div id="osTopNav" >
	<div id="osTopNavLeft">
	</div>

	<div id="osTopNavRight">
	</div>

	<ul id="osTopNavList">
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/About/About  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/About/About%27" tppabs="http://www.opensips.org/About/About" title="About">About</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Downloads/Downloads  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Downloads/Downloads%27" tppabs="http://www.opensips.org/Downloads/Downloads" title="Download">Downloads</a>
		</li>
		<li>
			<a href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals" title="Documentation">Documentation</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Community/Foundation-Main  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Community/Foundation-Main%27" tppabs="http://www.opensips.org/Community/Foundation-Main" title="Community">Community</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Development/Development  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Development/Development%27" tppabs="http://www.opensips.org/Development/Development" title="Development">Development</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Support/Contact  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Support/Contact%27" tppabs="http://www.opensips.org/Support/Contact" title="Support">Support</a>
		</li>
	</ul>
</div>
<!--PageMenuFmt-->
<!--/PageMenuFmt-->
  <table width='100%' align="center" cellpadding='0' cellspacing='0' id='wikimid'>
    <tr>
<!--PageLeftFmt-->
      <td valign='top' bgcolor="#E2F8DA" id='wikileft'>
        <p class='sidehead'> <span  style='color: #185662;'> Documentation</span>
</p><ul><li><a class='wikilink' title='Manuals' href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals">Manuals</a>
</li><li><a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Advanced Tutorials</a>
</li><li><a class='wikilink' title='TipsFAQ' href="TipsFAQ.htm" tppabs="http://www.opensips.org/Documentation/TipsFAQ">Tips &amp; FAQ</a>
</li><li><a class='wikilink' title='Migration' href="Migration.htm" tppabs="http://www.opensips.org/Documentation/Migration">Version Migration</a>
</li><li><a class='wikilink' title='Webinars' href="Webinars.htm" tppabs="http://www.opensips.org/Documentation/Webinars">OpenSIPS Webinars</a>
</li><li><a class='wikilink' title='Troubleshooting' href="Troubleshooting.htm" tppabs="http://www.opensips.org/Documentation/Troubleshooting">Troubleshooting</a>
</li><li><a class='wikilink' title='Tools' href="Tools.htm" tppabs="http://www.opensips.org/Documentation/Tools">OpenSIPS Tools</a>
</li><li><a class='wikilink' title='Development-Tutorials' href="Development-Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Development-Tutorials">Devel Tutorial</a>
</li></ul><div class='vspace'></div>
</td>
<!--/PageLeftFmt-->
      <td id='wikibody' valign='top'>
<!--PageTitleFmt-->
        
<!--PageText-->
<div id='wikitext'>
<h2 class='wikiaction'>Documentation.Tutorials-Presence-PuaXmppConfig History</h2>
  <p><a href="Tutorials-Presence-PuaXmppConfig-action=diff&source=y&minor=n.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-Presence-PuaXmppConfig?action=diff&source=y&minor=n">Hide minor edits</a> - <a href="Tutorials-Presence-PuaXmppConfig-action=diff&source=n&minor=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-Presence-PuaXmppConfig?action=diff&source=n&minor=y">Show changes to output</a></p>
  <div id='wikidiff'>
      <div class='diffbox'><div class='difftime'>July 02, 2014, at 01:50 PM 
        by <span class='diffauthor' title='89.120.101.121'>89.120.101.121</span> - </div>
        <div class='difftype'>Deleted lines 188-192:</div>
        <div class='diffdel'><div class='diffmarkup'><br />		# make pua_usrloc send PUBLISH for phones which do not support<br />		# presence filter after User-Agent header<br />		if ( $hdr(&quot;User-Agent&quot;)!~&quot;X-Lite&quot; )<br />			pua_set_publish();</div></div></div>
      <div class='diffrestore'><a href="Tutorials-Presence-PuaXmppConfig-action=edit&restore=diff-1404301844-1404300487-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-Presence-PuaXmppConfig?action=edit&restore=diff:1404301844:1404300487:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>July 02, 2014, at 01:28 PM 
        by <span class='diffauthor' title='89.120.101.121'>89.120.101.121</span> - </div>
        <div class='difftype'>Deleted line 35:</div>
        <div class='diffdel'><div class='diffmarkup'>alias=&quot;sip.domain.com&quot;</div></div></div>
      <div class='diffrestore'><a href="Tutorials-Presence-PuaXmppConfig-action=edit&restore=diff-1404300487-1404300363-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-Presence-PuaXmppConfig?action=edit&restore=diff:1404300487:1404300363:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>July 02, 2014, at 01:26 PM 
        by <span class='diffauthor' title='89.120.101.121'>89.120.101.121</span> - </div>
        <div class='difftype'>Changed lines 1-5 from:</div>
        <div class='diffdel'><div class='diffmarkup'>[[Documentation/Tutorials-PUAExtensions#pua_xmpp | &lt;-Back]]<br /><br />[[http://opensips.org/uploads/Resources/opensips_xmpp.cfg| Download]]<br /><br />&lt;pre&gt;&lt;span style=&quot;color: #800;&quot;&gt;# OpenSIPS SIP-XMPP Gateway&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;debug&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;log_stderror&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;no&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;log_facility&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;LOG_LOCAL0&lt;br&gt;&lt;br&gt;fork&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;yes&lt;br&gt;children&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;listen&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;udp&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;10.10.10.10&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;5060&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;alias&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ------------------ module loading ----------------------------------&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;mpath&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;/usr/local/lib/opensips/modules/&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;db_mysql.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;textops.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;maxfwd.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;rr.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sl.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;tm.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;signaling.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;usrloc.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;registrar.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;mi_fifo.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;uri.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;pua.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;pua_xmpp.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence_xml.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ----------------- setting module-specific parameters ---------------&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;usrloc|presence|presence_xml|pua&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;db_url&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;mysql://opensips:opensipsrw@localhost/opensips&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence|pua_xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;server_address&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:sa@10.10.10.10:5060&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence_xml&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;force_active&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;pua_xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence_server&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:sa@10.10.10.10:5060&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp_domain&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# the name that OpenSIPS will register with as a component to the jabber server&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp_host&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# the location of the jabber server&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip_domain&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# the domain of the sip users visible to the xmpp users &lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;backend&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;component&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;outbound_proxy&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:10.10.10.10:5060&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;mi_fifo&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;fifo_name&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;/tmp/opensips_fifo&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;usrloc&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;db_mode&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;route &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;mf_process_maxfwd_header&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;10&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;483&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Too Many Hops&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;has_totag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# sequential request withing a dialog should&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# take the path determined by record-routing&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;loose_route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;BYE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setflag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# do accounting ...&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setflag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ... even if the transaction fails&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;INVITE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# even if in most of the cases is useless, do RR for&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# re-INVITEs alos, as some buggy clients do change route set&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# during the dialog.&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; record_route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# route it out to whatever destination was set by loose_route()&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# in $du (destination URI).&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;/* uncomment the following lines if you want to enable presence */&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;SUBSCRIBE|NOTIFY&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;# in-dialog subscribe requests&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;ACK&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; t_check_trans&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# non loose-route, but stateful ACK; must be an ACK after &lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# a 487 or e.g. 404 from upstream server&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_relay&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ACK without matching transaction -&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ignore and discard&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;404&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Not here&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;#initial requests&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# CANCEL processing&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;CANCEL&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;t_check_trans&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_relay&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; t_check_trans&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# authenticate if from local subscriber (uncomment to enable auth)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# authenticate all initial non-REGISTER request that pretend to be&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# generated by local subscriber (domain from FROM URI is local)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!(method==&quot;REGISTER&quot;) &amp;amp;&amp;amp; from_uri==myself) /*no multidomain version*/&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!(method==&quot;REGISTER&quot;) &amp;amp;&amp;amp; is_from_local()) &amp;nbsp;/*multidomain version*/&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;if (!proxy_authorize(&quot;&quot;, &quot;subscriber&quot;)) {&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp; &amp;nbsp; &amp;nbsp;proxy_challenge(&quot;&quot;, &quot;0&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp; &amp;nbsp; &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;if (!db_check_from()) {&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp; &amp;nbsp; &amp;nbsp;sl_send_reply(&quot;403&quot;,&quot;Forbidden auth ID&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp; &amp;nbsp; &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;consume_credentials();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;# caller authenticated&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# preloaded route checking&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;loose_route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; xlog&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;L_ERR&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;ACK&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;403&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Preload Route denied&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# handle initial presence messages&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;myself &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;||&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+gmail.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;||&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+@xmpp.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# detect if it's for an XMPP user&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;PUBLISH|SUBSCRIBE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;};&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# handle xmpp messages&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;MESSAGE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+gmail.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;||&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+@xmpp.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;t_newtran&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_reply_error&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;xmpp_send_message&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;200&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Accepted&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;404&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Not found&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;};&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# record routing&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;REGISTER|MESSAGE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; record_route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# account only INVITEs&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;INVITE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setflag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# do accounting&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;myself&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## replace with following line if multi-domain support is used&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!is_uri_host_local())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; append_hf&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;P-hint: outbound\r\n&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# if you have some interdomain connections via TLS&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if($rd==&quot;tls_domain1.net&quot;) {&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;t_relay(&quot;tls:domain1.net&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##} else if($rd==&quot;tls_domain2.net&quot;) {&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;t_relay(&quot;tls:domain2.net&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# requests for my domain&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;REGISTER&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# authenticate the REGISTER requests (uncomment to enable auth)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!www_authorize(&quot;&quot;, &quot;subscriber&quot;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;www_challenge(&quot;&quot;, &quot;0&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!db_check_to()) &lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;sl_send_reply(&quot;403&quot;,&quot;Forbidden auth ID&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;save&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;location&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_reply_error&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;$rU&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;NULL&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# request with no Username in RURI&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;484&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Address Incomplete&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# apply DB based aliases (uncomment to enable)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##alias_db_lookup(&quot;dbaliases&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# do lookup with method filtering&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;lookup&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;location&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;m&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;switch&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;$retcode&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_newtran&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;404&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Not Found&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;405&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Method Not Allowed&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# when routing via usrloc, log the missed calls also&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; setflag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# send it out now; use stateful forwarding as it works reliably&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# even for UDP2TCP&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;t_relay&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_reply_error&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;};&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# create new transaction to catch retransmissions&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;t_newtran&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_reply_error&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# if it is Notify - for xmpp gateway&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;NOTIFY&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;200&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;OK&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pua_xmpp_notify&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# handle presence specific messages&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;PUBLISH&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handle_publish&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;SUBSCRIBE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handle_subscribe&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;$hdr&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #606;&quot;&gt;Event&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)==&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+gmail.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;||&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+@xmpp.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pua_xmpp_req_winfo&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;$ruri&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;$hdr(Expires)&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/pre&gt;</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>!!!!! Documentation -&gt; [[Documentation.Tutorials | Tutorials ]] -&gt; [[Documentation/Tutorials-Presence | Presence]] -&gt; [[Documentation/Tutorials-PUAExtensions#pua_xmpp|Presence User Agent Extensions]] -&gt; SIMPLE SIP-to-XMPP gateway<br /><br />\\<br /><br /><br />[@<br />#<br /># OpenSIPS 1.11.x configuration file<br />#<br /># SIP to XMPP Gateway + SIP Presence Server<br />#<br /><br /># ----------- global configuration parameters ------------------------<br /><br />debug=3<br />fork=yes<br />log_stderror=no<br /><br />check_via=no<br />dns=no<br />rev_dns=no<br /><br />listen=udp:10.10.10.10:5060<br />children=2<br /><br />alias=&quot;sip.domain.com&quot;<br /><br /># ------------------ module loading ----------------------------------<br />mpath=&quot;/usr/local/opensips/lib/modules/&quot;<br /><br />loadmodule &quot;db_mysql.so&quot;<br />loadmodule &quot;sl.so&quot;<br />loadmodule &quot;signaling.so&quot;<br />loadmodule &quot;tm.so&quot;<br />loadmodule &quot;maxfwd.so&quot;<br />alias=&quot;sip.domain.com&quot;<br />loadmodule &quot;textops.so&quot;<br />loadmodule &quot;sipmsgops.so&quot;<br />loadmodule &quot;rr.so&quot;<br />loadmodule &quot;mi_fifo.so&quot;<br />loadmodule &quot;usrloc.so&quot;<br />loadmodule &quot;registrar.so&quot;<br />loadmodule &quot;presence.so&quot;<br />loadmodule &quot;presence_xml.so&quot;<br />loadmodule &quot;xmpp.so&quot;<br />loadmodule &quot;pua.so&quot;<br />loadmodule &quot;pua_xmpp.so&quot;<br /><br /># Uncomment this if you want digest authentication<br />#loadmodule &quot;auth.so&quot;<br />#loadmodule &quot;auth_db.so&quot;<br /><br /># ----------------- setting module-specific parameters ---------------<br />modparam(&quot;mi_fifo&quot;,&quot;fifo_name&quot;,&quot;/tmp/opensips_fifo&quot;)<br /><br /># -- usrloc params --<br />modparam(&quot;usrloc&quot;,&quot;db_mode&quot;,2)<br />modparam(&quot;usrloc&quot;,&quot;db_url&quot;,&quot;mysql://opensips:opensipsrw@localhost/opensips&quot;)<br /><br /># -- auth params --<br /># Uncomment if you are using auth module<br />#modparam(&quot;auth_db&quot;, &quot;calculate_ha1&quot;, yes)<br />#modparam(&quot;auth_db&quot;, &quot;password_column&quot;, &quot;password&quot;)<br /><br /># -- presence params --<br />modparam(&quot;presence|presence_xml&quot;,&quot;db_url&quot;,&quot;mysql://opensips:opensipsrw@localhost/opensips&quot;)<br />modparam(&quot;presence&quot;,&quot;server_address&quot;,&quot;sip:sa@10.10.10.10:5060&quot;)<br />modparam(&quot;presence_xml&quot;,&quot;force_active&quot;,1)<br /><br /># -- pua and pua_xmpp parameters --<br />modparam(&quot;pua&quot;,&quot;db_url&quot;,&quot;mysql://opensips:opensipsrw@localhost/opensips&quot;)<br />modparam(&quot;pua_xmpp&quot;,&quot;default_domain&quot;,&quot;10.10.10.10&quot;)<br /><br /># -- xmpp parameters --<br /># the name that OpenSIPS will register with as a component to the jabber server<br />modparam(&quot;xmpp&quot;, &quot;xmpp_domain&quot;, &quot;sip.domain.com&quot;)<br /># the location of the jabber server<br />modparam(&quot;xmpp&quot;, &quot;xmpp_host&quot;, &quot;xmpp.domain.com&quot;)<br /># the domain of the sip users visible to the xmpp users <br />modparam(&quot;xmpp&quot;, &quot;sip_domain&quot;, &quot;sip.domain.com&quot;)<br />modparam(&quot;xmpp&quot;, &quot;backend&quot;, &quot;component&quot;)<br />modparam(&quot;xmpp&quot;, &quot;outbound_proxy&quot;, &quot;sip:10.10.10.10:5060&quot;)<br /><br /><br /># -------------------------  request routing logic -------------------<br /><br /># main routing logic<br />route{<br /><br />	# initial sanity checks<br />	if(!mf_process_maxfwd_header(&quot;10&quot;)) {<br />		send_reply(&quot;483&quot;,&quot;Too Many Hops&quot;);<br />		exit;<br />	}<br /><br />	if (has_totag()) {<br />		# sequential requests within a dialog should<br />		# take the path determined by record-routing<br />		if (loose_route()) {<br />			# route it out to whatever destination was set by loose_route()<br />			# in $du (destination URI).<br />			route(relay);<br />		} else {<br />			if (is_method(&quot;SUBSCRIBE|NOTIFY&quot;) &amp;&amp; uri==myself) {<br />				# in-dialog subscribe requests<br />				route(handle_presence);<br />				exit;<br />			} else if ( is_method(&quot;ACK&quot;) ) {<br />				if ( t_check_trans() ) {<br />					# non loose-route, but stateful ACK; must be an ACK after <br />					# a 487 or e.g. 404 from upstream server<br />					t_relay();<br />					exit;<br />				} else {<br />					# ACK without matching transaction -&gt;<br />					# ignore and discard<br />					exit;<br />				}<br />			}<br />			send_reply(&quot;404&quot;,&quot;Not here&quot;);<br />		}<br />		exit;<br />	}<br /><br />	# CANCEL processing<br />	if (is_method(&quot;CANCEL&quot;)) {<br />		if (t_check_trans())<br />			t_relay();<br />		exit;<br />	}<br /><br />	t_check_trans();<br /><br />	# authenticate if from local subscriber (uncomment to enable auth)<br />	# authenticate all initial non-REGISTER request that pretend to be<br />	# generated by local subscriber (domain from FROM URI is local)<br />	##if (!(method==&quot;REGISTER&quot;) &amp;&amp; from_uri==myself) {<br />	##  if (!proxy_authorize(&quot;&quot;, &quot;subscriber&quot;)) {<br />	##      proxy_challenge(&quot;&quot;, &quot;0&quot;);<br />	##      exit;<br />	##  }<br />	##  if (!db_check_from()) {<br />	##      send_reply(&quot;403&quot;,&quot;Forbidden auth ID&quot;);<br />	##      exit;<br />	##  }<br />	##<br />	##  consume_credentials();<br />	##}<br /><br />	# SIP to XMPP traffic (to an XMPP user)<br />	if ( ($rd=~&quot;.+gmail.com$&quot; || $rd==&quot;xmpp.domain.com&quot;) ) {<br />		# handle initial presence messages<br />		if ( is_method(&quot;PUBLISH|SUBSCRIBE&quot;) )<br />			route(handle_presence);<br /><br />		# handle xmpp messages<br />		if (is_method(&quot;MESSAGE&quot;) ) {<br />			t_newtran();<br />			if (xmpp_send_message()) {<br />				t_reply(&quot;200&quot;, &quot;Accepted&quot;);<br />			} else {<br />				t_reply(&quot;404&quot;, &quot;Not found&quot;);<br />			}<br />			exit;<br />		}<br />	} # SIP 2 XMPP<br /><br />	# record routing<br />	if (!is_method(&quot;REGISTER|MESSAGE&quot;))<br />		record_route();<br /><br />	if (uri!=myself) {<br />		# routing to other SIP domains<br />		route(relay);<br />	}<br /><br />	# SIP 2 SIP presence traffic<br />	if (is_method(&quot;PUBLISH|SUBSCRIBE&quot;)) {<br />		route(handle_presence);<br />		exit;<br />	}<br /><br />	if (is_method(&quot;REGISTER&quot;)) {<br /><br />		# Uncomment this if you want to use digest authentication<br />		#if (!www_authorize(&quot;&quot;, &quot;subscriber&quot;)) {<br />		#  www_challenge(&quot;&quot;, &quot;0&quot;);<br />		#  exit;<br />		#}<br /><br />		# make pua_usrloc send PUBLISH for phones which do not support<br />		# presence filter after User-Agent header<br />		if ( $hdr(&quot;User-Agent&quot;)!~&quot;X-Lite&quot; )<br />			pua_set_publish();<br /><br />		save(&quot;location&quot;);<br />		exit;<br />	}<br /><br />	# native SIP destinations are handled using our USRLOC DB<br />	if(!lookup(&quot;location&quot;)) {<br />		send_reply(&quot;404&quot;,&quot;Not Found&quot;);<br />		exit;<br />	}<br /><br />	route(relay);<br />}<br /><br /><br />route[relay]{<br />	# send it out<br />	if(!t_relay())<br />		sl_reply_error();<br /><br />	exit;<br />}<br /><br /><br />route[handle_presence]<br />{<br />	if(!t_newtran()){<br />		sl_reply_error();<br />		exit;<br />	}<br /><br />	# if it is NOTIFY - for xmpp gateway<br />	if( is_method(&quot;NOTIFY&quot;)) {<br />		t_reply(&quot;200&quot;, &quot;OK&quot;);<br />		pua_xmpp_notify();<br />	} else<br /><br />	if (is_method(&quot;PUBLISH&quot;)) {<br />		handle_publish();<br />	} else<br /><br />	if (is_method(&quot;SUBSCRIBE&quot;)) {<br />		handle_subscribe();<br />		if( $hdr(Event)== &quot;presence&quot; &amp;&amp; <br />		($rd=~&quot;.+gmail.com$&quot; || $rd==&quot;xmpp.domain.com&quot;) )<br />			pua_xmpp_req_winfo(&quot;$ru&quot;, &quot;$hdr(Expires)&quot;);<br />	}<br /><br />	exit;<br />}<br />@]</div></div></div>
      <div class='diffrestore'><a href="Tutorials-Presence-PuaXmppConfig-action=edit&restore=diff-1404300363-1368096453-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-Presence-PuaXmppConfig?action=edit&restore=diff:1404300363:1368096453:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>May 09, 2013, at 12:47 PM 
        by <span class='diffauthor' title='109.99.235.212'>109.99.235.212</span> - </div>
        <div class='difftype'>Added lines 1-5:</div>
        <div class='diffadd'><div class='diffmarkup'>[[Documentation/Tutorials-PUAExtensions#pua_xmpp | &lt;-Back]]<br /><br />[[http://opensips.org/uploads/Resources/opensips_xmpp.cfg| Download]]<br /><br />&lt;pre&gt;&lt;span style=&quot;color: #800;&quot;&gt;# OpenSIPS SIP-XMPP Gateway&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;debug&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;log_stderror&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;no&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;log_facility&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;LOG_LOCAL0&lt;br&gt;&lt;br&gt;fork&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;yes&lt;br&gt;children&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;listen&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;udp&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;10.10.10.10&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;5060&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;alias&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ------------------ module loading ----------------------------------&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;mpath&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;/usr/local/lib/opensips/modules/&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;db_mysql.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;textops.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;maxfwd.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;rr.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sl.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;tm.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;signaling.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;usrloc.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;registrar.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;mi_fifo.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;uri.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;pua.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;pua_xmpp.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;loadmodule &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence_xml.so&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ----------------- setting module-specific parameters ---------------&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;usrloc|presence|presence_xml|pua&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;db_url&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;mysql://opensips:opensipsrw@localhost/opensips&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence|pua_xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;server_address&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:sa@10.10.10.10:5060&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence_xml&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;force_active&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;pua_xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence_server&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:sa@10.10.10.10:5060&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp_domain&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# the name that OpenSIPS will register with as a component to the jabber server&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp_host&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# the location of the jabber server&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip_domain&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# the domain of the sip users visible to the xmpp users &lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;backend&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;component&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;xmpp&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;outbound_proxy&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:10.10.10.10:5060&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;mi_fifo&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;fifo_name&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;/tmp/opensips_fifo&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;modparam&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;usrloc&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;db_mode&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;route &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;mf_process_maxfwd_header&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;10&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;483&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Too Many Hops&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;has_totag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# sequential request withing a dialog should&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# take the path determined by record-routing&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;loose_route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;BYE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setflag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# do accounting ...&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setflag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ... even if the transaction fails&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;INVITE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# even if in most of the cases is useless, do RR for&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# re-INVITEs alos, as some buggy clients do change route set&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# during the dialog.&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; record_route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# route it out to whatever destination was set by loose_route()&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# in $du (destination URI).&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;/* uncomment the following lines if you want to enable presence */&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;SUBSCRIBE|NOTIFY&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;# in-dialog subscribe requests&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;ACK&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; t_check_trans&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;()&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# non loose-route, but stateful ACK; must be an ACK after &lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# a 487 or e.g. 404 from upstream server&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_relay&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ACK without matching transaction -&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# ignore and discard&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;404&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Not here&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;#initial requests&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# CANCEL processing&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;CANCEL&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;t_check_trans&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_relay&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; t_check_trans&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# authenticate if from local subscriber (uncomment to enable auth)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# authenticate all initial non-REGISTER request that pretend to be&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# generated by local subscriber (domain from FROM URI is local)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!(method==&quot;REGISTER&quot;) &amp;amp;&amp;amp; from_uri==myself) /*no multidomain version*/&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!(method==&quot;REGISTER&quot;) &amp;amp;&amp;amp; is_from_local()) &amp;nbsp;/*multidomain version*/&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;if (!proxy_authorize(&quot;&quot;, &quot;subscriber&quot;)) {&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp; &amp;nbsp; &amp;nbsp;proxy_challenge(&quot;&quot;, &quot;0&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp; &amp;nbsp; &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;if (!db_check_from()) {&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp; &amp;nbsp; &amp;nbsp;sl_send_reply(&quot;403&quot;,&quot;Forbidden auth ID&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp; &amp;nbsp; &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;consume_credentials();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;# caller authenticated&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# preloaded route checking&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;loose_route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; xlog&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;L_ERR&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;ACK&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;403&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Preload Route denied&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# handle initial presence messages&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;myself &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;||&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+gmail.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;||&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+@xmpp.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# detect if it's for an XMPP user&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;PUBLISH|SUBSCRIBE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;};&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# handle xmpp messages&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;MESSAGE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+gmail.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;||&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+@xmpp.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;t_newtran&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_reply_error&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;xmpp_send_message&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;200&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Accepted&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;404&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Not found&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;};&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# record routing&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;REGISTER|MESSAGE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; record_route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# account only INVITEs&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;INVITE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; setflag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# do accounting&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;myself&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## replace with following line if multi-domain support is used&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!is_uri_host_local())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; append_hf&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;P-hint: outbound\r\n&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# if you have some interdomain connections via TLS&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if($rd==&quot;tls_domain1.net&quot;) {&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;t_relay(&quot;tls:domain1.net&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##} else if($rd==&quot;tls_domain2.net&quot;) {&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;t_relay(&quot;tls:domain2.net&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# requests for my domain&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;REGISTER&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# authenticate the REGISTER requests (uncomment to enable auth)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!www_authorize(&quot;&quot;, &quot;subscriber&quot;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;www_challenge(&quot;&quot;, &quot;0&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##if (!db_check_to()) &lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;sl_send_reply(&quot;403&quot;,&quot;Forbidden auth ID&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;## &amp;nbsp;exit;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;save&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;location&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_reply_error&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;$rU&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;NULL&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# request with no Username in RURI&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;484&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Address Incomplete&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# apply DB based aliases (uncomment to enable)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;##alias_db_lookup(&quot;dbaliases&quot;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# do lookup with method filtering&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;lookup&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;location&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;m&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;switch&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;$retcode&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_newtran&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;404&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Not Found&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_send_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;405&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;Method Not Allowed&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# when routing via usrloc, log the missed calls also&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; setflag&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# send it out now; use stateful forwarding as it works reliably&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# even for UDP2TCP&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;t_relay&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_reply_error&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;};&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;route&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #066;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# create new transaction to catch retransmissions&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(!&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;t_newtran&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;())&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sl_reply_error&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# if it is Notify - for xmpp gateway&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;NOTIFY&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; t_reply&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;200&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;OK&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pua_xmpp_notify&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #800;&quot;&gt;# handle presence specific messages&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;PUBLISH&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handle_publish&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;is_method&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;SUBSCRIBE&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;))&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handle_subscribe&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;();&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;$hdr&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #606;&quot;&gt;Event&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)==&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;presence&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+gmail.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;||&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; uri&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;=~&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;sip:.+@xmpp.domain.com&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pua_xmpp_req_winfo&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;$ruri&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #080;&quot;&gt;&quot;$hdr(Expires)&quot;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;);&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #008;&quot;&gt;exit&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;;&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #660;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #000;&quot;&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/pre&gt;</div></div></div>
      <div class='diffrestore'><a href="Tutorials-Presence-PuaXmppConfig-action=edit&restore=diff-1368096453-1368096453-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-Presence-PuaXmppConfig?action=edit&restore=diff:1368096453:1368096453:&preview=y">Restore</a></div></div></div>
  
<!--PageRightFmt--><!--/PageRightFmt--></td>
</tr></table>
<!--PageFooterFmt-->
  <div id='wikifoot'>
  <hr class="bottomline" /></td>
    <div class='footnav'>
	
      <a rel="nofollow" href="Tutorials-Presence-PuaXmppConfig-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-Presence-PuaXmppConfig?action=edit">Edit</a> |
      <a rel="nofollow" href="Tutorials-Presence-PuaXmppConfig-action=diff.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-Presence-PuaXmppConfig?action=diff">History</a> |
      <a rel="nofollow" href="Tutorials-Presence-PuaXmppConfig-action=print.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-Presence-PuaXmppConfig?action=print" target='_blank'>Print</a> |
      <a href="RecentChanges.htm" tppabs="http://www.opensips.org/Documentation/RecentChanges">Recent Changes</a> |
      <a href="javascript:if(confirm(%27http://www.opensips.org/Site/Search  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Site/Search%27" tppabs="http://www.opensips.org/Site/Search">Search</a></div>
    <div class='lastmod'>Page last modified on July 02, 2014, at 01:50 PM</div></div>
<!--HTMLFooter-->
</div>
</body>
</html>
