<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title>openSIPS | Documentation / Tutorials-LoadBalancing-1-9 </title>
  <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel='stylesheet' href="opensips.css" tppabs="http://www.opensips.org/pub/skins/opensips/opensips.css" type='text/css' />
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 4px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
  .editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }
 
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script>
  <link href="commentboxplus.css" tppabs="http://www.opensips.org/pub/commentboxplus/commentboxplus.css" rel='stylesheet' type='text/css' />
  <link rel='stylesheet' href="wsplus.css" tppabs="http://www.opensips.org/pub/wsplus/wsplus.css" 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url("csshover.htc")/*tpa=http://www.opensips.org/pub/wsplus/csshover.htc*/; }
    .rollover * { visibility: visible; }
  </style><![endif]-->
  <meta name='robots' content='index,follow' />

  <link rel="icon" type="image/png" href="http://opensips.org/favicon.png">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','analytics.js'/*tpa=http://www.google-analytics.com/analytics.js*/,'ga');

  ga('create', 'UA-47615177-1', 'http://www.opensips.org/Documentation/opensips.org');
  ga('send', 'pageview');

	function resizeIframe(obj) {
	    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
		  }

  </script>

</head>
<body>
<div id="main">
<!--PageHeaderFmt-->
  <div id='wikilogo'>
  <img class="motto" src="motto.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/motto.jpg" width="328" height="40" alt="The new breed of communication engine.">
  <a href="javascript:if(confirm(%27http://www.opensips.org/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/%27" tppabs="http://www.opensips.org/"><img class="logo" src="logo2.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/logo2.jpg"
    alt='openSIPS' border='0' /></a>
 </div>
 <div id='wikihead'>
 <table border=0>
  <tr valign=top><td width=250>
   <p><a class='wikilink' title='Signup' href="javascript:if(confirm(%27http://www.opensips.org/Login/Signup?action=login  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Login/Signup?action=login%27" tppabs="http://www.opensips.org/Login/Signup?action=login">Login</a> | <a class='wikilink' title='Signup' href="javascript:if(confirm(%27http://www.opensips.org/Login/Signup  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Login/Signup%27" tppabs="http://www.opensips.org/Login/Signup">Register</a> 
</p>

  </td></tr>
  <tr><td width=250>
   <form action="http://www.opensips.org/">
   
    <input type='hidden' name='n' value='Documentation.Tutorials-LoadBalancing-1-9' />
    <input type='hidden' name='action' value='search' />

    <input type='text' name='q' id='formsubmit' value='' class='inputbox searchbox' />
	<input type='submit' id='formbutton' class='inputbutton searchbutton' value=' ' /></form>
  </td></tr>
  </table>
 </div>

<!--/PageHeaderFmt-->
<div id="osTopNav" >
	<div id="osTopNavLeft">
	</div>

	<div id="osTopNavRight">
	</div>

	<ul id="osTopNavList">
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/About/About  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/About/About%27" tppabs="http://www.opensips.org/About/About" title="About">About</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Downloads/Downloads  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Downloads/Downloads%27" tppabs="http://www.opensips.org/Downloads/Downloads" title="Download">Downloads</a>
		</li>
		<li>
			<a href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals" title="Documentation">Documentation</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Community/Foundation-Main  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Community/Foundation-Main%27" tppabs="http://www.opensips.org/Community/Foundation-Main" title="Community">Community</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Development/Development  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Development/Development%27" tppabs="http://www.opensips.org/Development/Development" title="Development">Development</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Support/Contact  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Support/Contact%27" tppabs="http://www.opensips.org/Support/Contact" title="Support">Support</a>
		</li>
	</ul>
</div>
<!--PageMenuFmt-->
<!--/PageMenuFmt-->
  <table width='100%' align="center" cellpadding='0' cellspacing='0' id='wikimid'>
    <tr>
<!--PageLeftFmt-->
      <td valign='top' bgcolor="#E2F8DA" id='wikileft'>
        <p class='sidehead'> <span  style='color: #185662;'> Documentation</span>
</p><ul><li><a class='wikilink' title='Manuals' href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals">Manuals</a>
</li><li><a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Advanced Tutorials</a>
</li><li><a class='wikilink' title='TipsFAQ' href="TipsFAQ.htm" tppabs="http://www.opensips.org/Documentation/TipsFAQ">Tips &amp; FAQ</a>
</li><li><a class='wikilink' title='Migration' href="Migration.htm" tppabs="http://www.opensips.org/Documentation/Migration">Version Migration</a>
</li><li><a class='wikilink' title='Webinars' href="Webinars.htm" tppabs="http://www.opensips.org/Documentation/Webinars">OpenSIPS Webinars</a>
</li><li><a class='wikilink' title='Troubleshooting' href="Troubleshooting.htm" tppabs="http://www.opensips.org/Documentation/Troubleshooting">Troubleshooting</a>
</li><li><a class='wikilink' title='Tools' href="Tools.htm" tppabs="http://www.opensips.org/Documentation/Tools">OpenSIPS Tools</a>
</li><li><a class='wikilink' title='Development-Tutorials' href="Development-Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Development-Tutorials">Devel Tutorial</a>
</li></ul><div class='vspace'></div>
</td>
<!--/PageLeftFmt-->
      <td id='wikibody' valign='top'>
<!--PageTitleFmt-->
        
<!--PageText-->
<div id='wikitext'>
<h5>Documentation -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; Load Balancing 1.9</h5>
<hr />
<p>This page has been visited 11968 times.
</p><div class='tocfloat'><p><a name='toc' id='toc'></a><b>Table of Content</b> (<a id="tocidtog" href="javascript:toggle('tocid');">hide</a>)</p><ol class='toc' id='tocid'><li>1.&nbsp;<a href='#toc1'>Load Balancing in <strong>OpenSIPS</strong></a></li><li>2.&nbsp;<a href='#toc2'>Load Balancing - how it works</a><ol class='toc'><li>2.1&nbsp;<a href='#toc3'>Destination set</a></li><li>2.2&nbsp;<a href='#toc4'>Invoking Load-balancing</a></li><li>2.3&nbsp;<a href='#toc5'>The LB logic</a></li><li>2.4&nbsp;<a href='#toc6'>Disabling and Pinging</a></li><li>2.5&nbsp;<a href='#toc7'>RealTime Control over the Load Balancer</a></li></ol></li><li>3.&nbsp;<a href='#toc8'>Study Case: routing the media gateways</a><ol class='toc'><li>3.1&nbsp;<a href='#toc9'>Configuration</a></li><li>3.2&nbsp;<a href='#toc10'>OpenSIPS Scripting</a></li></ol></li><li>4.&nbsp;<a href='#toc11'>Comments</a></li></ol></div>
<hr />
<p class='vspace'>This tutorial applied for OpenSIP versions 1.9
</p>
<div class='vspace'></div><h3><a name='toc1' id='toc1'></a>1.&nbsp; Load Balancing in <strong>OpenSIPS</strong></h3>
<p>The "load-balancing" module comes to provide traffic routing based on load. Shortly, when <strong>OpenSIPS</strong> routes calls to a set of destinations, it is able to keep the load status (as number of ongoing calls) of each destination and to choose to route to the less loaded destination (at that moment).
<strong>OpenSIPS</strong> is aware of the capacity of each destination - it is pre-configured with the maximum load accepted by the destinations. To be more precise, when routing, <strong>OpenSIPS</strong> will consider the less loaded destination not the destination with the smallest number of ongoing calls, but the destination with the largest available slot.
</p>
<p class='vspace'>Also, the "load-balancing" (LB) module is able to receive feedback from the destinations (if they are capable of). This mechanism is used for notifying <strong>OpenSIPS</strong> when the maximum capacity of a destination changed (like a GW with more or less E1 cards).
</p>
<p class='vspace'>The "load-balancing" functionality comes to enhance the "dispatcher" one. The difference comes in having or not load information about the destinations where you are routing to:
</p>
<div class='vspace'></div><ul><li><strong>Dispatcher has no load information</strong> - it just blindly forwards calls to the destinations based on a probabilistic dispersion logic. It gets no feedback about the load of the destination (like how many calls that were sent actually were established or how many are still going).
<div class='vspace'></div></li><li><strong>Load-balancer is load driven</strong> - LB routing logic is based primary on the load information. The LB module is using the DIALOG module in order to keep trace of the load (ongoing calls).
</li></ul><div class='vspace'></div><hr />
<h3><a name='toc2' id='toc2'></a>2.&nbsp; Load Balancing - how it works</h3>
<p>When looking at the LB implementation in <strong>OpenSIPS</strong>, we have 3 aspects:
</p>
<div class='vspace'></div><h4><a name='toc3' id='toc3'></a>2.1&nbsp; Destination set</h4>
<p>A destination is defined by its address (a SIP URI) and its description as capacity.
</p>
<p class='vspace'>Form the LB module perspective, the <strong>destinations are not homogeneous</strong> - they are not alike; and not only from capacity point of view, but also from what kind of <strong>services/resources</strong> they offer. For example, you may have a set of Yate/Asterisk boxes for media-related services -some of them are doing transcoding, other voicemail or conference,  other simple announcement , other PSTN termination. But you may have mixed boxes - one box may do PSTN and voicemail in the same time. So each destination from the set may offer a different set of services/resources.
</p>
<p class='vspace'>So, for each destination, the LB module defines the offered resources, and for each resource, it defines the <strong>capacity / maximum load</strong> as number of concurrent calls the destination can handle for that resource.
</p>
<p class='vspace'>Example:
</p><pre class='escaped'>
4 destinations/boxes in the LB set
    1) offers 30 channels for transcoding and 32 for PSTN
    2) offers 100 voicemail channels and 10 for transcoding
    3) offers 50 voicemail channels and 300 for conference
    4) offers 10 voicemail, 10 conference, 10 transcoding and 32 PSTN

This translated into the following setup:

+----+----------+-------------------------+---------------------------------+
| id | group_id | dst_uri                 | resources                       |
+----+----------+-------------------------+---------------------------------+
|  1 |        1 | sip:yate1.mycluster.net | transc=30; pstn=32              |
|  2 |        1 | sip:yate2.mycluster.net | vm=100; transc=10               |
|  3 |        1 | sip:yate3.mycluster.net | vm=50; conf=300                 |
|  4 |        1 | sip:yate4.mycluster.net | vm=10;conf=10;transc=10;pstn=32 |
+----+----------+-------------------------+---------------------------------+

</pre>
<p class='vspace'>For runtime, the LB module provides MI commands for:
</p><ul><li>reloading the definition of destination sets
</li><li>changing the capacity for a resource for a destination
</li></ul><div class='vspace'></div><h4><a name='toc4' id='toc4'></a>2.2&nbsp; Invoking Load-balancing</h4>
<p>Using the LB functionality is very simple - you just have to pass to the LB module what kind of resources the call requires.
</p>
<p class='vspace'>The resource detection is done in the <strong>OpenSIPS</strong> routing script, based on whatever information is appropriated. For example, looking at the RURI (dialed number) you can see if the call must go to PSTN or if it a voicemail or conference number; also, by looking at the codecs advertised in the SDP, you can figure out if transcoding is or not also required.
</p>
<div class='vspace'></div><pre class='escaped'>

  if (!load_balance("1","transc;pstn")) {
      sl_send_reply("500","Service full");
      exit;
  }

</pre>
<p class='vspace'>The first parameter of the function identifies the LB set to be used (see the group_id column in the above DB snapshot). Second parameter is list of the required resource for the call. A third optional parameter my be passed to instruct the LB engine on how to estimate the load - in absolute value (how many channels are used) or in relative value (how many percentages are used).
</p>
<p class='vspace'>The <strong>load_balance()</strong> will automatically create the dialog state for the call (in order to monitor it) and will also allocate the requested resources for it (from the selected box).<br />The function will set as destination URI ($du) the address of the selected destination/box.
</p>
<p class='vspace'>The resources will be automatically released when the call terminates. 
</p>
<p class='vspace'>The LB module provides an MI function that allows the admin to inspect the current load over the destinations.
</p>
<div class='vspace'></div><h4><a name='toc5' id='toc5'></a>2.3&nbsp; The LB logic</h4>
<p>The logic used by the LB module to select the destination is:
</p><ol><li>gets the <strong>destination set based on the group_id</strong> (first parameter of the <em>load_balance()</em> function)
<div class='vspace'></div></li><li>selects from the set only the <strong>destinations that are able to provide the requested resources</strong> (second parameter of the <em>load_balance()</em> function)
<div class='vspace'></div></li><li>for the selected destinations, it <strong>evaluated the current load</strong> for each requested resource
<div class='vspace'></div></li><li>the winning destination is the one with <strong>the biggest value for the minimum available load</strong> per resources.
</li></ol><div class='vspace'></div><pre class='escaped'>
Example:

4 destinations/boxes in the LB set
    1) offers 30 channels for transcoding and 32 for PSTN
    2) offers 100 voicemail channels and 10 for transcoding
    3) offers 50 voicemail channels and 300 for conference
    4) offers 10 voicemail, 10 conference, 10 transcoding and 32 PSTN

when calling load_balance("1","transc;pstn") -&gt;

1) only boxes (1) and (4) will be selected at as they offer both transcoding and pstn

2) evaluating the load  :
    (1) transcoding - 10 channels used; PSTN - 18 used 
    (4) transcoding - 9 channels used; PSTN - 16 used 

   evaluating available load (capacity-load) :
    (1) transcoding - 20 channels used; PSTN - 14 used 
    (4) transcoding - 1 channels used; PSTN - 16 used 

3) for each box, the minimum available load (through all resources)
    (1) 14 (PSTN)
    (2) 1 (transcoding) 

4) final selected box in (1) as it has the the biggest (=14) available load for the most loaded resource.

</pre>
<p class='vspace'>The selection algorithm tries to avoid the intensive usage of a resource per box.
</p>
<div class='vspace'></div><h4><a name='toc6' id='toc6'></a>2.4&nbsp; Disabling and Pinging</h4>
<p>The Load Balancer modules provides couple of functionalities to help in dealing with failures of the destinations. The actual detection of a failed destination (based on the SIP traffic) is done in the OpenSIPS routing script by looking at the codes of the replies you receive back from the destinations (see the example at the end of tutorial).
</p>
<p class='vspace'>Once a destination is detected at failed, in script, you can mark it as disabled via the <strong>lb_disable()</strong> function - once marked as disabled, the destination will not be used anymore in the LB process (it will not be considered a possible destination when routing calls).
</p>
<p class='vspace'>For a destination to be set back as enabled, there are two options:
</p><ul><li>use the MI command <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id248919%27" tppabs="http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id248919" rel='nofollow'>lb_status</a> to do it manually, from outside OpenSIPS
</li><li>based on probing - the destination must have the SIP probing/pinging enabled - once the destination starts replying with 200 OK replies to the SIP pings (see the <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id250116%27" tppabs="http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id250116" rel='nofollow'>probing_reply_codes</a> option.
</li></ul><p class='vspace'>To enable pinging, you need first to set <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id249996%27" tppabs="http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id249996" rel='nofollow'>probing_interval</a> to a non zero value - how often the pinging should be done. The pinging will be done by periodically sending a <strong>OPTIONS</strong> SIP request to the destination - see <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id250037%27" tppabs="http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id250037" rel='nofollow'>probing_method</a> option.
</p>
<p class='vspace'>To control which and when a destination is pinged, there is the <strong>probe_mode</strong> column in the <strong>load_balancer</strong> table - see <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/db/db-schema-1.9.x.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/db/db-schema-1.9.x.html#AEN3971%27" tppabs="http://www.opensips.org/html/docs/db/db-schema-1.9.x.html#AEN3971" rel='nofollow'>table definition</a>. Possible options are:
</p><ul><li><strong>0</strong> no pinging at any time
</li><li><strong>1</strong> ping only if in disabled state (used for auto re-enabling of destinations)
</li><li><strong>2</strong> ping all the time - it will disable destination if fails to answer to pings and enable it back when starts answering again.
</li></ul><div class='vspace'></div><h4><a name='toc7' id='toc7'></a>2.5&nbsp; RealTime Control over the Load Balancer</h4>
<p>The Load Balancer module provides several MI functions to allow you to do runtime changes and to get realtime information from it.
</p>
<p class='vspace'>Pushing changes at runtime:
</p><ul><li><strong>lb_reload</strong> - force reloading the entire configuration data from DB - see <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id292737%27" tppabs="http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id292737" rel='nofollow'>more..</a>
</li><li><strong>lb_resize</strong> - change the capacity of a resource for a destination - see <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id292759%27" tppabs="http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id292759" rel='nofollow'>more..</a>
</li><li><strong>lb_status</strong> - change the status of a destination (enable/disable) - see <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id248919%27" tppabs="http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id248919" rel='nofollow'>more..</a>
</li></ul><p class='vspace'>For fetching realtime information :
</p><ul><li><strong>lb_list</strong> - list the load on all destinations (per resource) - see <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id292782%27" tppabs="http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id292782" rel='nofollow'>more..</a>
</li><li><strong>lb_status</strong> - see the status of a destination (enable/disable) - see <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id248919%27" tppabs="http://www.opensips.org/html/docs/modules/1.9.x/load_balancer.html#id248919" rel='nofollow'>more..</a>
</li></ul><div class='vspace'></div><hr />
<h3><a name='toc8' id='toc8'></a>3.&nbsp; Study Case: routing the media gateways</h3>
<p class='vspace'>Here is the full configuration and script for performing LB between media peers.
</p>
<div class='vspace'></div><h4><a name='toc9' id='toc9'></a>3.1&nbsp; Configuration</h4>
<p>Let's consider the following case: a cluster of media servers providing voicemail service and PSTN (in and out) service. So the boxes will be able to receive calls for Voicemail or for PSTN termination, but they will be able to send back calls only for PSTN inbound.
</p>
<p class='vspace'>We also want the destinations to be disabled from script (when a failure is detected); The re-enabling of the destinations will be done based on pinging - we do pinging only when the destination is in "failed" status.
</p>
<div class='vspace'></div><pre class='escaped'>
4 destinations/boxes in the LB set
    1) offers 50 channels for voicemail and 32 for PSTN
    2) offers 100 voicemail channels
    3) offers 50 voicemail channels
    4) offers 10 voicemail and 64 PSTN

This translated into the following setup:

+----+----------+-------------------------+-------------------+-----------+
| id | group_id | dst_uri                 | resources         | prob_mode |
+----+----------+-------------------------+-------------------+-----------+
|  1 |        1 | sip:yate1.mycluster.net | vm=50; pstn=32    |         1 |
|  2 |        1 | sip:yate2.mycluster.net | vm=100            |         1 |
|  3 |        1 | sip:yate3.mycluster.net | vm=50             |         1 |
|  4 |        1 | sip:yate4.mycluster.net | vm=10;pstn=64     |         1 |
+----+----------+-------------------------+-------------------+-----------+

</pre>
<div class='vspace'></div><h4><a name='toc10' id='toc10'></a>3.2&nbsp; OpenSIPS Scripting </h4>
<div class='vspace'></div><pre class='escaped'>
debug=1
memlog=1

fork=yes
children=2
log_stderror=no
log_facility=LOG_LOCAL0

disable_tcp=yes
disable_dns_blacklist = yes

auto_aliases=no

check_via=no
dns=off
rev_dns=off

listen=udp:xxx.xxx.xxx.xxx:5060 # REPLACE here with right values 



loadmodule "modules/maxfwd/maxfwd.so"
loadmodule "modules/sl/sl.so"
loadmodule "modules/db_mysql/db_mysql.so"
loadmodule "modules/tm/tm.so"
loadmodule "modules/uri/uri.so"
loadmodule "modules/rr/rr.so"
loadmodule "modules/dialog/dialog.so"
loadmodule "modules/mi_fifo/mi_fifo.so"
loadmodule "modules/mi_xmlrpc/mi_xmlrpc.so"
loadmodule "modules/signaling/signaling.so"
loadmodule "modules/textops/textops.so"
loadmodule "modules/sipmsgops/sipmsgops.so"
loadmodule "modules/load_balancer/load_balancer.so"



modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo")

modparam("dialog", "db_mode", 1)
modparam("dialog", "db_url", "mysql://opensips:opensipsrw@localhost/opensips")

modparam("rr","enable_double_rr",1)
modparam("rr","append_fromtag",1)

modparam("load_balancer", "db_url","mysql://opensips:opensipsrw@localhost/opensips")
# ping every 30 secs the failed destinations
modparam("load_balancer", "probing_interval", 30)
modparam("load_balancer", "probing_from", "sip:pinger@LB_IP:LB_PORT")
# consider positive ping reply the 404 
modparam("load_balancer", "probing_reply_codes", "404")


route{
	if (!mf_process_maxfwd_header("3")) {
		send_reply("483","looping");
		exit;
	}


	if ( has_totag() ) {
		# sequential request -&gt; obey Route indication
		loose_route();
                t_relay();
                exit;
        }

        # handle cancel and re-transmissions
	if ( is_method("CANCEL") ) {
		if ( t_check_trans() )
			t_relay();
		exit;
	}


        # from now on we have only the initial requests
        if (!is_method("INVITE")) {
                send_reply("405","Method Not Allowed");
                exit;
        }

        # initial request
	record_route();

        # not really necessary to create the dialog from script (as the
        # LB functions will do this for us automatically), but we do it
        # if we want to pass some flags to dialog (pinging, bye, etc)
        create_dialog("B");

        # check the direction of call
        if ( lb_is_destination("$si","$sp","1") ) {
                # call comes from our cluster, so it is an PSNT inbound call
                # mark it as load on the corresponding destination
                lb_count_call("$si","$sp","1", "pstn");
                # and route is to our main sip server to send call to end user
                $du = "sip:PROXY_IP:PORXY_PORT"; # REPLACE here with right values 
                t_relay();
                exit;
        }

        # detect resources and store in an AVP
        if ( $rU=~"^VM_" ) {
                # looks like a VoiceMail call
                $avp(lb_res) = "vm";
        } else if ( $rU=~"^[0-9]+$" ) {
                # PSTN call
                $avp(lb_res) = "pstn";
        } else {
                send_reply("404","Destination not found");
                exit;
        }

        # LB function returns negative if no suitable destination (for requested resources) is found,
        # or if all destinations are full
        if ( !load_balance("1","$avp(lb_res)") ) {
             send_reply("500","Service full");
             exit;
        }

	xlog("Selected destination is: $du\n");

        # arm a failure route for be able to catch a failure event and to do 
        # failover to the next available destination
        t_on_failure("LB_failed");

        # send it out
	if (!t_relay()) {
		sl_reply_error();
	}
}

failure_route[LB_failed]
{
        # skip if call was canceled 
	if (t_was_cancelled()) {
		exit;
	}

        # was a destination failure ? (we do not want to do failover
        # if it was a call setup failure, so we look for 500 and 600
        # class replied and for local timeouts)
        if ( t_check_status("[56][0-9][0-9]") ||
        (t_check_status("408") &amp;&amp; t_local_replied("all") ) ) {
                # this is a case for failover
                xlog("REPORT: LB destination $du failed with code $T_reply_code\n");
                # mark failed destination as disabled 
                lb_disable();
                # try to re-route to next available destination
                if ( !load_balance("1","$avp(lb_res)") ) {
                      send_reply("500","Service full");
                      exit;
                }
                xlog("REPORT: re-routing call to $du \n");
                t_relay();
        }
}


</pre>
<div class='vspace'></div><hr />
<h3><a name='toc11' id='toc11'></a>4.&nbsp; Comments</h3>
<p class='vspace'><a name='comment1' id='comment1'></a>
</p><div class='messagehead' > 
<h5><a class='createlinktext' rel='nofollow' 
    href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Chiharu?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Chiharu?action=edit%27" tppabs="http://www.opensips.org/Profiles/Chiharu?action=edit">Chiharu</a><a rel='nofollow' 
    class='createlink' href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Chiharu?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Chiharu?action=edit%27" tppabs="http://www.opensips.org/Profiles/Chiharu?action=edit">?</a>  &mdash;  <span style='font-size:83%'>10 April 2013, 12:35</span>  </h5>
</div><div class='messageitem' > 
<p>Is there anyway to inctaporroe a multiplexer into your pbx so incoming and outgoing calls can seem seemless? Also, the connection between the PBX and the VM system, is it a special propriatary connection or is it simply a twisted pair cable? If itsï»¿ just a twisted pair cable, then if mutiple calls come in, how would the mutiple calls be able to hear the auto attend?Thank you!
</p></div>
<p class='vspace'><a name='comment2' id='comment2'></a>
</p><div class='messagehead' > 
<h5><a class='createlinktext' rel='nofollow' 
    href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Keani?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Keani?action=edit%27" tppabs="http://www.opensips.org/Profiles/Keani?action=edit">Keani </a><a rel='nofollow' 
    class='createlink' href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Keani?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Keani?action=edit%27" tppabs="http://www.opensips.org/Profiles/Keani?action=edit">?</a>  &mdash;  <span style='font-size:83%'>05 October 2013, 10:47</span>  </h5>
</div><div class='messageitem' > 
<p>Hi Guys, 
</p>
<p class='vspace'>I am exactly following step as per this doc for Loadbalancing, but I am unable to send call on my Asterisk server, What could be problem, Will I need to configure any additional config at my asterisk End.
</p></div>
<p class='vspace'><a name='comment3' id='comment3'></a>
</p><div class='messagehead' > 
<h5><a class='createlinktext' rel='nofollow' 
    href="javascript:if(confirm(%27http://www.opensips.org/Profiles/ConfusedByChiharusQuestion?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/ConfusedByChiharusQuestion?action=edit%27" tppabs="http://www.opensips.org/Profiles/ConfusedByChiharusQuestion?action=edit">Confused By Chiharu's Question</a><a rel='nofollow' 
    class='createlink' href="javascript:if(confirm(%27http://www.opensips.org/Profiles/ConfusedByChiharusQuestion?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/ConfusedByChiharusQuestion?action=edit%27" tppabs="http://www.opensips.org/Profiles/ConfusedByChiharusQuestion?action=edit">?</a>  &mdash;  <span style='font-size:83%'>19 November 2013, 16:23</span>  </h5>
</div><div class='messageitem' > 
<p>Chiharu - huh?
</p></div>
<p class='vspace'><a name='comment4' id='comment4'></a>
</p><div class='messagehead' > 
<h5><a class='createlinktext' rel='nofollow' 
    href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Husnain?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Husnain?action=edit%27" tppabs="http://www.opensips.org/Profiles/Husnain?action=edit">Husnain</a><a rel='nofollow' 
    class='createlink' href="javascript:if(confirm(%27http://www.opensips.org/Profiles/Husnain?action=edit  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Profiles/Husnain?action=edit%27" tppabs="http://www.opensips.org/Profiles/Husnain?action=edit">?</a>  &mdash;  <span style='font-size:83%'>04 June 2014, 13:46</span>  </h5>
</div><div class='messageitem' > 
<p>How can I change the group_id from "1" to "2" in failover condition. I have already done it but its not working please guide.
</p></div>
<div class='vspace'></div>
    <div id='message'><form name='cbox' class='inputform' action="http://www.opensips.org/Documentation/Tutorials-LoadBalancing-1-9" method='post' onsubmit='return checkform(this);'>
    <input type='hidden' name='n' value='Documentation.Tutorials-LoadBalancing-1-9' />
    <input type='hidden' name='action' value='comment' />
    <input type='hidden' name='order' value='chrono' /><input type='hidden' name='accesscode' value='979' />
    <input type='hidden' name='csum' value='Comment added' />
    <table width='90%'><tr>
    <th class='prompt' align='right' valign='top'>Add Comment&nbsp;</th>
    <td><textarea class='inputtext commenttext' name='text' id='text' rows=6 cols=40></textarea>
    </td></tr><tr><th class='prompt' align='right' valign='top'>Sign as Author&nbsp;</th>
    <td><input class='inputbox commentauthorbox' type='text' name='author' value='' size='32' /></td></tr>
    <tr><th class='prompt' align='right' valign='top'>Enter code <em class='access'>979</em></th>
    <td><input type='text' size='4' maxlength='3' name='access' value='' class='inputbox' /> <input class='inputbutton commentbutton' type='submit' name='post' value=' Post ' />
    <input class='inputbutton commentbutton' type='reset' value='Reset' /></td></tr></table><br /></form></div>
 <script type='text/javascript' language='JavaScript1.2'>
  function checkform ( form ) {
   if (form.text && form.text.value == "") { window.alert( 'Please enter a comment to post' ); form.text.focus(); return false; }
   if (form.author && form.author.value == "") { window.alert( 'Please enter your name as author' ); form.author.focus(); return false; }
   if (form.access && form.access.value == "") { window.alert( 'Please enter the code number' ); form.access.focus(); return false; }return true ;
  }
  </script>
   
</div>
  
<!--PageRightFmt--><!--/PageRightFmt--></td>
</tr></table>
<!--PageFooterFmt-->
  <div id='wikifoot'>
  <hr class="bottomline" /></td>
    <div class='footnav'>
	
      <a rel="nofollow" href="Tutorials-LoadBalancing-1-9-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-LoadBalancing-1-9?action=edit">Edit</a> |
      <a rel="nofollow" href="Tutorials-LoadBalancing-1-9-action=diff.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-LoadBalancing-1-9?action=diff">History</a> |
      <a rel="nofollow" href="Tutorials-LoadBalancing-1-9-action=print.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-LoadBalancing-1-9?action=print" target='_blank'>Print</a> |
      <a href="RecentChanges.htm" tppabs="http://www.opensips.org/Documentation/RecentChanges">Recent Changes</a> |
      <a href="javascript:if(confirm(%27http://www.opensips.org/Site/Search  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Site/Search%27" tppabs="http://www.opensips.org/Site/Search">Search</a></div>
    <div class='lastmod'>Page last modified on June 04, 2014, at 01:46 PM</div></div>
<!--HTMLFooter-->
</div>
</body>
</html>
