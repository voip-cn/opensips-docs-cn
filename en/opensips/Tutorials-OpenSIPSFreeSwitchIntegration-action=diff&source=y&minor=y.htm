<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title>openSIPS | Documentation / Tutorials-OpenSIPSFreeSwitchIntegration | History</title>
  <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel='stylesheet' href="opensips.css" tppabs="http://www.opensips.org/pub/skins/opensips/opensips.css" type='text/css' />
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 4px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
  .editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }

  .diffbox { width:570px; border-left:1px #999999 solid; margin-top:1.33em; }
  .diffauthor { font-weight:bold; }
  .diffchangesum { font-weight:bold; }
  .difftime { font-family:verdana,sans-serif; font-size:66%; 
    background-color:#dddddd; }
  .difftype { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; font-weight:bold; }
  .diffadd { border-left:5px #99ff99 solid; padding-left:5px; }
  .diffdel { border-left:5px #ffff99 solid; padding-left:5px; }
  .diffrestore { clear:both; font-family:verdana,sans-serif; 
    font-size:66%; margin:1.5em 0px; }
  .diffmarkup { font-family:monospace; }  
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script>
  <link href="commentboxplus.css" tppabs="http://www.opensips.org/pub/commentboxplus/commentboxplus.css" rel='stylesheet' type='text/css' />
  <link rel='stylesheet' href="wsplus.css" tppabs="http://www.opensips.org/pub/wsplus/wsplus.css" 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url("csshover.htc")/*tpa=http://www.opensips.org/pub/wsplus/csshover.htc*/; }
    .rollover * { visibility: visible; }
  </style><![endif]-->
  <meta name='robots' content='noindex,nofollow' />

  <link rel="icon" type="image/png" href="http://opensips.org/favicon.png">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','analytics.js'/*tpa=http://www.google-analytics.com/analytics.js*/,'ga');

  ga('create', 'UA-47615177-1', 'http://www.opensips.org/Documentation/opensips.org');
  ga('send', 'pageview');

	function resizeIframe(obj) {
	    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
		  }

  </script>

</head>
<body>
<div id="main">
<!--PageHeaderFmt-->
  <div id='wikilogo'>
  <img class="motto" src="motto.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/motto.jpg" width="328" height="40" alt="The new breed of communication engine.">
  <a href="javascript:if(confirm(%27http://www.opensips.org/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/%27" tppabs="http://www.opensips.org/"><img class="logo" src="logo2.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/logo2.jpg"
    alt='openSIPS' border='0' /></a>
 </div>
 <div id='wikihead'>
 <table border=0>
  <tr valign=top><td width=250>
   
  </td></tr>
  <tr><td width=250>
   <form action="http://www.opensips.org/">
   
    <input type='hidden' name='n' value='Documentation.Tutorials-OpenSIPSFreeSwitchIntegration' />
    <input type='hidden' name='action' value='search' />

    <input type='text' name='q' id='formsubmit' value='' class='inputbox searchbox' />
	<input type='submit' id='formbutton' class='inputbutton searchbutton' value=' ' /></form>
  </td></tr>
  </table>
 </div>

<!--/PageHeaderFmt-->
<div id="osTopNav" >
	<div id="osTopNavLeft">
	</div>

	<div id="osTopNavRight">
	</div>

	<ul id="osTopNavList">
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/About/About  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/About/About%27" tppabs="http://www.opensips.org/About/About" title="About">About</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Downloads/Downloads  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Downloads/Downloads%27" tppabs="http://www.opensips.org/Downloads/Downloads" title="Download">Downloads</a>
		</li>
		<li>
			<a href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals" title="Documentation">Documentation</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Community/Foundation-Main  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Community/Foundation-Main%27" tppabs="http://www.opensips.org/Community/Foundation-Main" title="Community">Community</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Development/Development  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Development/Development%27" tppabs="http://www.opensips.org/Development/Development" title="Development">Development</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Support/Contact  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Support/Contact%27" tppabs="http://www.opensips.org/Support/Contact" title="Support">Support</a>
		</li>
	</ul>
</div>
<!--PageMenuFmt-->
<!--/PageMenuFmt-->
  <table width='100%' align="center" cellpadding='0' cellspacing='0' id='wikimid'>
    <tr>
<!--PageLeftFmt-->
      <td valign='top' bgcolor="#E2F8DA" id='wikileft'>
        <p class='sidehead'> <span  style='color: #185662;'> Documentation</span>
</p><ul><li><a class='wikilink' title='Manuals' href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals">Manuals</a>
</li><li><a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Advanced Tutorials</a>
</li><li><a class='wikilink' title='TipsFAQ' href="TipsFAQ.htm" tppabs="http://www.opensips.org/Documentation/TipsFAQ">Tips &amp; FAQ</a>
</li><li><a class='wikilink' title='Migration' href="Migration.htm" tppabs="http://www.opensips.org/Documentation/Migration">Version Migration</a>
</li><li><a class='wikilink' title='Webinars' href="Webinars.htm" tppabs="http://www.opensips.org/Documentation/Webinars">OpenSIPS Webinars</a>
</li><li><a class='wikilink' title='Troubleshooting' href="Troubleshooting.htm" tppabs="http://www.opensips.org/Documentation/Troubleshooting">Troubleshooting</a>
</li><li><a class='wikilink' title='Tools' href="Tools.htm" tppabs="http://www.opensips.org/Documentation/Tools">OpenSIPS Tools</a>
</li><li><a class='wikilink' title='Development-Tutorials' href="Development-Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Development-Tutorials">Devel Tutorial</a>
</li></ul><div class='vspace'></div>
</td>
<!--/PageLeftFmt-->
      <td id='wikibody' valign='top'>
<!--PageTitleFmt-->
        
<!--PageText-->
<div id='wikitext'>
<h2 class='wikiaction'>Documentation.Tutorials-OpenSIPSFreeSwitchIntegration History</h2>
  <p><a href="Tutorials-OpenSIPSFreeSwitchIntegration-action=diff&source=y&minor=n.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=diff&source=y&minor=n">Hide minor edits</a> - <a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=diff&source=n&minor=y  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=diff&source=n&minor=y%27" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=diff&source=n&minor=y">Show changes to output</a></p>
  <div id='wikidiff'>
      <div class='diffbox'><div class='difftime'>May 16, 2013, at 06:06 PM 
        by <span class='diffauthor' title='109.99.235.212'>109.99.235.212</span> - </div>
        <div class='difftype'>Changed line 1 from:</div>
        <div class='diffdel'><div class='diffmarkup'>!![[Documentation.Index | Documentation]] -&gt; [[Documentation.Tutorials | Tutorials ]] -&gt; [[Documentation.Tutorials-OpenSIPSFreeSwitchIntegration |  OpenSIPS FreeSwitch Integration]]</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>!!!!!Documentation -&gt; [[Documentation.Tutorials | Tutorials ]] -&gt; OpenSIPS FreeSwitch Integration</div></div></div>
      <div class='diffrestore'><a href="Tutorials-OpenSIPSFreeSwitchIntegration-action=edit&restore=diff-1368720396-1368103621-&preview=y.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=edit&restore=diff:1368720396:1368103621:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>May 09, 2013, at 02:47 PM 
        by <span class='diffauthor' title='79.118.227.150'>79.118.227.150</span> - </div>
        <div class='difftype'>Changed lines 1-2 from:</div>
        <div class='diffdel'><div class='diffmarkup'>!!Resources -&gt; [[Resources.Documentation | Documentation]] -&gt; [[Resources.DocsTutorials | Tutorials]] -&gt; Realtime OpenSIPS - FreeSWITCH Integration</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>!![[Documentation.Index | Documentation]] -&gt; [[Documentation.Tutorials | Tutorials ]] -&gt; [[Documentation.Tutorials-OpenSIPSFreeSwitchIntegration |  OpenSIPS FreeSwitch Integration]]<br />----</div></div>
        <div class='difftype'>Changed line 2055 from:</div>
        <div class='diffdel'><div class='diffmarkup'>Get rich!</div></div>
        <div class='difftype'>to:</div>
        <div class='diffadd'><div class='diffmarkup'>Get rich!</div></div></div>
      <div class='diffrestore'><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=edit&restore=diff:1368103621:1366822450:&preview=y  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=edit&restore=diff:1368103621:1366822450:&preview=y%27" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=edit&restore=diff:1368103621:1366822450:&preview=y">Restore</a></div>
      <div class='diffbox'><div class='difftime'>April 24, 2013, at 06:54 PM 
        by <span class='diffauthor' title='213.233.101.41'>213.233.101.41</span> - </div>
        <div class='difftype'>Added lines 1-2054:</div>
        <div class='diffadd'><div class='diffmarkup'>!!Resources -&gt; [[Resources.Documentation | Documentation]] -&gt; [[Resources.DocsTutorials | Tutorials]] -&gt; Realtime OpenSIPS - FreeSWITCH Integration<br />This page has been visited {$PageCount} times.<br />(:toc-float Table of Content:)<br />----<br /><br />!!! Realtime '''OpenSIPS - FreeSWITCH''' Integration<br />'''Author %purple%Giovanni Maruzzelli &lt;gmaruzz at gmail dot com&gt;%%'''<br /><br />'''This tutorial is made for OpenSIPS 1.8.x and FreeSWITCH 1.2.x'''<br /><br />----<br />!!!! Scope<br /><br />This tutorial can be used as a cut and paste complete and working installation. Please follow strictly all the steps, in the order given.<br /><br />This tutorial presents the concept and implementation of a realtime integration of OpenSIPS SIP server and FreeSWITCH media server.<br /><br />OpenSIPS is used a SIP server - users are registering with it, it routes calls, etc - while the purpose of FreeSWITCH is to provide a full set of media services - like voicemail, conference, announcements, etc.<br /><br />It is a realtime integration because both OpenSIPS and FreeSWITCH are provisioned in the same time when comes to user accounts - when creating a new OpenSIPS user, automatically FreeSWITCH will learn about it an provide and configure all necessary  media services for it.<br /><br />Both OpenSIPS and FreeSWITCH will be provisioned (for user accounts) via a shared mysql database.<br /><br />All FreeSWITCH functionalities will be available to OpenSIPS users by prefixing &quot;*&quot; (eg: star) to the extension dialed. *1234 will be passed to FreeSWITCH as 1234, while **1234 will be passed to FreeSWITCH as *1234<br /><br />----<br />!!!! Setup presentation<br /><br />This tutorial can be used as a cut and paste complete and working installation. Please follow strictly all the steps, in the order given.<br /><br />The following services will be offered by FreeSWITCH by this integrated configuration:<br /><br />* '''voicemail''' - users will get access to their mailbox; authentication will be done by OpenSIPS; while FreeSWITCH will only provide voicemail IVR (with access PIN);<br /> <br />* '''conference'''' - OpenSIPS will detect and forward calls related to conference service (based on prefixes) to FreeSWITCH, which will provide access (pin based) to the conference rooms;<br /><br />* '''all functionalities''' - OpenSIPS users will prefix * to reach the corresponding extension in FreeSWITCH (*1234 will be passed to FreeSWITCH as 1234, while **1234 will be passed to FreeSWITCH as *1234)<br /><br />!!! Installation and First Configuration<br /><br />----<br />!!!! Install Linux<br /><br />Start from a fresh Debian 6 (Squeeze) base install, bring in the latest updates and reboot<br /><br />[@<br />apt-get clean<br />apt-get update<br />apt-get upgrade<br />apt-get dist-upgrade<br />reboot<br />@]<br /><br /><br />----<br />!!!! Install the prerequisites<br /><br />[@<br />apt-get install build-essential \<br />                subversion automake autoconf wget  libtiff4-dev libtool \<br />                libncurses5-dev git-core libcurl4-openssl-dev libjpeg-dev \<br />                mysql-server libmysqlclient-dev mysql-client \<br />                unixodbc-dev unixodbc libmyodbc flex bison libncurses-dev \<br />                build-essential openssl bison flex perl libdbi-perl \<br />                libdbd-mysql-perl libdbd-pg-perl libfrontier-rpc-perl \<br />                libterm-readline-gnu-perl libberkeleydb-perl ncurses-dev \<br />                libpcre3-dev libxml2-dev libxmlrpc-c-dev libpcre3 libxml2 \<br />                perl libdbi-perl libdbd-mysql-perl libfrontier-rpc-perl \<br />                libterm-readline-gnu-perl libberkeleydb-perl apache2 \<br />                libapache2-mod-php5 php5 php5-cli php5-gd php5-mysql php-pear \<br />                php5-xmlrpc<br /><br />@]<br /><br />----<br />!!!! Compile and install OpenSIPS<br /><br />[@<br />cd /usr/src<br />svn co https://opensips.svn.sourceforge.net/svnroot/opensips/branches/1.8 opensips_1_8<br /><br />cd opensips_1_8<br />make menuconfig<br />@]<br /><br />Go to 'Configure Compile Options' and then 'Configure Excluded Modules'. Select the db_mysql, db_unixodbc, dialplan, mi_xmlrpc, presence*, pua*, regex modules with the spacebar key, then hit the 'q' key. Go to 'Configure Install Prefix' and set the prefix to /usr/local/opensips . Hit 'Save Changes' and then compile and install OpenSIPS.<br /><br />----<br />!!!! Create OpenSIPS Database and Configuration File<br /><br />[@<br />cd /usr/local/opensips/etc/opensips/<br />vi opensipsctlrc<br />@]<br /><br />modify like the follow (you'll find in the next section the file ready to be copied and pasted).<br /><br />[@<br /># this parameter.<br />DBENGINE=MYSQL<br /><br />## database host<br />DBHOST=localhost<br /><br />## database name (for ORACLE this is TNS name)<br />DBNAME=opensips<br /><br /># database path used by dbtext or db_berkeley<br /># DB_PATH=&quot;/usr/local/etc/opensips/dbtext&quot;<br /><br />## database read/write user<br />DBRWUSER=opensips<br /><br />## password for database read/write user<br />DBRWPW=&quot;mydbpassword&quot;<br /><br />## database super user (for ORACLE this is 'scheme-creator' user)<br />DBROOTUSER=&quot;root&quot;<br />@]<br /><br />then create the database<br /><br />[@<br />cd ../..<br />cd sbin<br />./opensipsdbctl create<br />@]<br /><br />you can then check database creation success with<br /><br />[@<br />mysql -D opensips -p<br />@]<br /><br />then create the OpenSIPS configuration file<br /><br />[@<br />./osipsconfig<br />@]<br /><br />Go to 'Generate OpenSIPS Script' and then to 'Residential Script', 'Configure Residential Script'.<br />Add ENABLE_TCP, USE_ALIASES, USE_AUTH, USE_DBACC, USE_DBUSRLOC, USE_DIALOG, USE_DIALPLAN, VM_DIVERSION<br /><br />Hit 'q' and then go to 'Generate Residential Script', which will generate a CFG file in your install path, in the /usr/local/opensips/etc/opensips/ folder.<br /><br />Change its name, and edit it (you'll find in the next section the file ready to be copied and pasted).<br /><br />[@<br />cd ../etc/opensips<br />mv opensips_residential_2012-12-19_8\:51\:27.cfg opensips_residential_01.cfg<br /><br />vi opensips_residential_01.cfg<br />@]<br /><br />Follow this guidelines<br /><br />[@<br />#follow CUSTOMIZE ME<br /># modify db password<br /><br /># modify<br />$du = &quot;sip:127.0.0.2:5060&quot;; # CUSTOMIZE ME<br />#to<br />$du = &quot;sip:192.168.1.110:5090&quot;; # CUSTOMIZE ME<br /><br />#modify mpath to /usr/local/opensips/lib64/opensips/modules/<br /><br />#modify from<br />#### URI module<br />loadmodule &quot;uri.so&quot;<br />modparam(&quot;uri&quot;, &quot;use_uri_table&quot;, 0)<br /><br />#to<br />#### URI module<br />loadmodule &quot;uri.so&quot;<br />modparam(&quot;uri&quot;, &quot;use_uri_table&quot;, 0)<br />modparam(&quot;uri&quot;, &quot;db_url&quot;,<br />                &quot;mysql://opensips:mydbpassword@localhost/opensips&quot;) # CUSTOMIZE ME<br /><br />@]<br /><br />(you'll find in the next section the file ready to be copied and pasted)<br /><br /><br />!!!! Install OpenSIPS init files<br /><br />then install and edit OpenSIPS init script<br /><br />[@<br />cd /usr/src/opensips_1_8/<br />cd packaging/<br />cd debian<br />cp opensips.init /etc/init.d/opensips<br />chmod +x /etc/init.d/opensips<br />vi /etc/init.d/opensips<br />@]<br /><br />change the following lines, with the correct location of OpenSIPS executable, comment out those lines for debug, and edit the OPTIONS line as instructed<br /><br />[@<br />DAEMON=/usr/local/opensips/sbin/opensips #CUSTOMIZE<br /><br />#comment out if [ &quot;$1&quot; != &quot;debug&quot; ]; then<br />#comment out check_fork<br />#comment out fi<br /><br /># edit OPTIONS adding -f config-file<br />OPTIONS=&quot;-P $PIDFILE -m $S_MEMORY -M $P_MEMORY -u $USER -g $GROUP -f /usr/local/opensips/etc/opensips/opensips_residential_01.cfg&quot;<br />@]<br /><br />then edit the accessory files<br /><br />[@<br />cp opensips.default /etc/default/opensips<br />vi /etc/default/opensips<br />@]<br /><br />edit it as in<br /><br />[@<br />RUN_OPENSIPS=yes<br />USER=root<br />GROUP=root<br />S_MEMORY=128<br />@]<br /><br />edit the system logger configuration file so to instruct it to convey OpenSIPS info to the right file<br /><br />[@<br />vi /etc/rsyslog.conf<br />@]<br /><br />add at file's end:<br /><br />[@<br />local1.* -/var/log/opensips.log<br />@]<br /><br />then restart the syslogger and OpenSIPS<br /><br />[@<br />/etc/init.d/rsyslog restart<br />/etc/init.d/opensips start<br />@]<br /><br />----<br />!!!! Install OpenSIPS Control Panel<br /><br />This is a web configuration and management tool we will use to manage all our platform, both OpenSIPS and FreeSWITCH (eg we'll manage OpenSIPS, actually, but FreeSWITCH will source its user management data from the same database used by OpenSIPS and managed with OpenSIP-CP).<br /><br />[@<br />cd /var/www<br />svn co https://opensips-cp.svn.sourceforge.net/svnroot/opensips-cp/trunk opensips-cp<br /><br />pear install mdb2<br />pear install mdb2#mysql<br /><br />cd opensips-cp<br />vi config/db.inc.php<br />@]<br /><br />edit it like this:<br /><br />[@<br />//database connection user<br />$config-&gt;db_user = &quot;opensips&quot;; //CUSTOMIZE<br /><br />//database connection password<br />$config-&gt;db_pass = &quot;mydbpassword&quot;; //CUSTOMIZE<br />@]<br /><br />then edit the other config files<br /><br />[@<br />vi config/boxes.global.inc.php<br />@]<br /><br />make it like this:<br /><br />[@<br />//## use fifo<br />//$boxes[$box_id]['mi']['conn']=&quot;127.0.0.1:8000&quot;;<br />$boxes[$box_id]['mi']['conn']=&quot;/tmp/opensips_fifo&quot;;<br /><br />//#comment out with double slashes monit stuff<br />// monit host:port<br />//$boxes[$box_id]['monit']['conn']=&quot;192.168.0.1:2812&quot;;<br />//$boxes[$box_id]['monit']['user']=&quot;admin&quot;;<br />//$boxes[$box_id]['monit']['pass']=&quot;pass&quot;;<br />//$boxes[$box_id]['monit']['has_ssl']=1;<br />@]<br /><br />[@<br />vi config/tools/system/dialog/local.inc.php<br />@]<br /><br />make it like this:<br /><br />[@<br />$box[1]['mi']['conn']=&quot;/tmp/opensips_fifo&quot;;;<br />@]<br /><br />[@<br />vi config/tools/system/dispatcher/local.inc.php<br />@]<br /><br />make it like this:<br /><br />[@<br />$box[1]['mi']['conn']=&quot;/tmp/opensips_fifo&quot;;<br />@]<br /><br />then add an alias to the apache configuration<br /><br />[@<br />vi /etc/apache2/apache2.conf<br />@]<br /><br />add at end of the file:<br />[@<br />Alias /cp /var/www/opensips-cp/web<br />@]<br /><br />then change the ownership of the files, do the logging part and the CDR related editing<br /><br />[@<br />chown www-data.www-data /var/www/opensips-cp/config/access.log<br />pear install log<br /><br />mysql -Dopensips -p &lt; config/tools/admin/add_admin/ocp_admin_privileges.mysql<br />mysql -Dopensips -p -e &quot;INSERT INTO ocp_admin_privileges (username,password,ha1,available_tools,permissions) values<br />       ('admin','admin',md5('admin:admin'),'all','all');&quot;<br />mysql -Dopensips -p &lt; config/tools/system/cdrviewer/cdrs.mysql<br />mysql -Dopensips -p &lt; config/tools/system/cdrviewer/opensips_cdrs.mysql<br />mysql -Dopensips -p &lt; config/tools/system/smonitor/tables.mysql<br /><br />vi /var/www/opensips-cp/cron_job/generate-cdrs_mysql.sh<br />@]<br /><br />edit to look like:<br /><br />[@<br />mysql -h $HOSTNAME -u $USER -p$PASS -e &quot;call opensips_cdrs(); &quot; $DATABASE<br />@]<br /><br />then activate the CDR cronjob<br /><br />[@<br />vi /etc/crontab<br />@]<br /><br />add the following lines to it<br /><br />[@<br />*/3 * * * * root /var/www/opensips-cp/cron_job/generate-cdrs_mysql.sh<br />* * * * *   root   php /var/www/opensips-cp/cron_job/get_opensips_stats.php &gt; /dev/null<br />@]<br /><br />and restart both apache and OpenSIPS<br /><br />[@<br />/etc/init.d/apache2 restart<br />/etc/init.d/opensips restart<br />/etc/init.d/cron restart<br />@]<br /><br />----<br />!!!! FreeSWITCH compile and install<br /><br />Let's install FreeSWITCH and go for a coffee in the while (will take time)<br /><br />[@<br />cd /usr/src<br />git clone -b v1.2.stable git://git.freeswitch.org/freeswitch.git<br />cd freeswitch/<br /><br />./bootstrap.sh &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install &amp;&amp; make hd-sounds-install &amp;&amp; make hd-moh-install &amp;&amp; make samples<br />@]<br /><br />----<br />!!!! FreeSWITCH listening ports<br /><br />Edit the SIP ports for FreeSWITCH<br /><br />[@<br />vi /usr/local/freeswitch/conf/vars.xml<br />@]<br /><br />to be<br /><br />[@<br />&lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;internal_sip_port=5090&quot;/&gt;<br />&lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;external_sip_port=5091&quot;/&gt;<br />@]<br /><br />----<br />!!!! Install OpenSIPS and FreeSWITCH configs and database script, and ODBC configs<br /><br />Back up the original files for your reference<br /><br />[@<br />cp /usr/local/opensips/etc/opensips/opensipsctlrc /usr/local/opensips/etc/opensips/opensipsctlrc.originale<br />cp /usr/local/freeswitch/conf/dialplan/public.xml /usr/local/freeswitch/conf/dialplan/public.xml.original<br />cp /usr/local/freeswitch/conf/vars.xml /usr/local/freeswitch/conf/vars.xml.original<br />cp /usr/local/freeswitch/conf/autoload_configs/modules.conf.xml /usr/local/freeswitch/conf/autoload_configs/modules.conf.xml.original<br />cp /usr/local/freeswitch/conf/autoload_configs/lua.conf.xml /usr/local/freeswitch/conf/autoload_configs/lua.conf.xml.original<br />cp /usr/local/freeswitch/conf/autoload_configs/acl.conf.xml /usr/local/freeswitch/conf/autoload_configs/acl.conf.xml.original<br />cp /etc/odbcinst.ini /etc/odbcinst.ini.original<br />cp /etc/odbc.ini /etc/odbc.ini.original<br />@]<br /><br />Files' content follows, but first the files' list:<br /><br />[@<br />/usr/local/opensips/etc/opensips/opensipsctlrc<br />/usr/local/opensips/etc/opensips/opensips_residential_01.cfg<br />/usr/local/freeswitch/conf/dialplan/public.xml<br />/usr/local/freeswitch/scripts/config.lua<br />/usr/local/freeswitch/scripts/xml_handler.lua<br />/usr/local/freeswitch/conf/vars.xml<br />/usr/local/freeswitch/conf/autoload_configs/modules.conf.xml<br />/usr/local/freeswitch/conf/autoload_configs/lua.conf.xml<br />/usr/local/freeswitch/conf/autoload_configs/acl.conf.xml<br />/etc/odbcinst.ini<br />/etc/odbc.ini<br />@]<br /><br />You will copy and paste each one the files, overwriting the existing ones you just backed-up.<br /><br />!!! Scripts and Configuration files you can Copy and Paste, with explanations<br /><br />Below the files' content, with some explanation, file by file.<br /><br />You copy and paste each one the following files, overwriting the existing ones (you just made a backup of them).<br /><br />Then you can change them to your like, eg: changing the &quot;mydbpasswd&quot; password and the IP addresses.<br /><br />The files as they are here compose a working installation, provided you followed this tutorial step by step, and you use the same IP addresses.<br /><br />All that has been changed from original installed files is marked as &quot;CUSTOMIZE&quot;<br /><br />Follow &quot;CUSTOMIZE&quot;, Neo.<br /><br /><br />----<br />!!!! /usr/local/opensips/etc/opensips/opensipsctlrc<br /><br />In this file, that configures the behavior of the opensipsctrl utilities, you modify the DB-related values.<br /><br /><br />[@<br /><br /># $Id: opensipsctlrc 9049 2012-05-24 14:03:31Z osas $<br />#<br /># The OpenSIPS configuration file for the control tools.<br />#<br /># Here you can set variables used in the opensipsctl and opensipsdbctl setup<br /># scripts. Per default all variables here are commented out, the control tools<br /># will use their internal default values.<br /><br />## your SIP domain<br /># SIP_DOMAIN=opensips.org<br /><br />## chrooted directory<br /># $CHROOT_DIR=&quot;/path/to/chrooted/directory&quot;<br /><br />## database type: MYSQL, PGSQL, ORACLE, DB_BERKELEY, or DBTEXT,<br />## by default none is loaded<br /># If you want to setup a database with opensipsdbctl, you must at least specify<br /># this parameter.<br />DBENGINE=MYSQL<br /><br />## database host #CUSTOMIZE<br />DBHOST=localhost<br /><br />## database name (for ORACLE this is TNS name) #CUSTOMIZE<br />DBNAME=opensips<br /><br /># database path used by dbtext or db_berkeley<br /># DB_PATH=&quot;/usr/local/etc/opensips/dbtext&quot;<br /><br />## database read/write user #CUSTOMIZE<br />DBRWUSER=opensips<br /><br />## password for database read/write user #CUSTOMIZE<br />DBRWPW=&quot;mydbpassword&quot;<br /><br />## database super user (for ORACLE this is 'scheme-creator' user) #CUSTOMIZE<br />DBROOTUSER=&quot;root&quot;<br /><br /># user name column<br /># USERCOL=&quot;username&quot;<br /><br /><br /># SQL definitions<br /># If you change this definitions here, then you must change them<br /># in db/schema/entities.xml too.<br /># FIXME<br /><br /># FOREVER=&quot;2020-05-28 21:32:15&quot;<br /># DEFAULT_ALIASES_EXPIRES=$FOREVER<br /># DEFAULT_Q=&quot;1.0&quot;<br /># DEFAULT_CALLID=&quot;Default-Call-ID&quot;<br /># DEFAULT_CSEQ=&quot;13&quot;<br /># DEFAULT_LOCATION_EXPIRES=$FOREVER<br /><br /><br /># Program to calculate a message-digest fingerprint<br /># MD5=&quot;md5sum&quot;<br /><br /># awk tool<br /># AWK=&quot;awk&quot;<br /><br /># grep tool<br /># GREP=&quot;grep&quot;<br /><br /># sed tool<br /># SED=&quot;sed&quot;<br /><br /><br /># Describe what additional tables to install. Valid values for the variables<br /># below are yes/no/ask. With ask (default) it will interactively ask the user<br /># for an answer, while yes/no allow for automated, unassisted installs.<br />#<br /><br /># If to install tables for the modules in the EXTRA_MODULES variable.<br /># INSTALL_EXTRA_TABLES=ask<br /><br /># If to install presence related tables.<br /># INSTALL_PRESENCE_TABLES=ask<br /><br /># Define what module tables should be installed.<br /># If you use the postgres database and want to change the installed tables,<br /># then you must also adjust the STANDARD_TABLES or EXTRA_TABLES variable<br /># accordingly in the opensipsdbctl.base script.<br /><br /># opensips standard modules<br /># STANDARD_MODULES=&quot;standard acc domain group permissions registrar usrloc<br />#                   msilo alias_db uri_db speeddial avpops auth_db pdt dialog<br />#                   dispatcher dialplan drouting nathelper load_balancer&quot;<br /><br /># opensips extra modules<br /># EXTRA_MODULES=&quot;imc cpl siptrace domainpolicy carrierroute userblacklist b2b registrant&quot;<br /><br /><br />## type of aliases used: DB - database aliases; UL - usrloc aliases<br />## - default: none<br /># ALIASES_TYPE=&quot;DB&quot;<br /><br />## control engine: FIFO or UNIXSOCK<br />## - default FIFO<br /># CTLENGINE=xmlrpc<br /><br />## path to FIFO file<br /># OSIPS_FIFO=&quot;/tmp/opensips_fifo&quot;<br /><br />## MI_CONNECTOR control engine: FIFO, UNIXSOCK, UDP, XMLRPC<br /># MI_CONNECTOR=FIFO:/tmp/opensips_fifo<br /># MI_CONNECTOR=UNIXSOCK:/tmp/opensips.sock<br /># MI_CONNECTOR=UDP:192.168.2.133:8000<br /># MI_CONNECTOR=XMLRPC:192.168.2.133:8000<br /><br />## check ACL names; default on (1); off (0)<br /># VERIFY_ACL=1<br /><br />## ACL names - if VERIFY_ACL is set, only the ACL names from below list<br />## are accepted<br /># ACL_GROUPS=&quot;local ld int voicemail free-pstn&quot;<br /><br />## verbose - debug purposes - default '0'<br /># VERBOSE=1<br /><br />## do (1) or don't (0) store plaintext passwords<br />## in the subscriber table - default '1'<br /># STORE_PLAINTEXT_PW=0<br /><br />## do not display the output highlighted<br /># NOHLPRINT=1<br /><br />## OPENSIPS START Options<br />## PID file path - default is: /var/run/opensips.pid<br /># PID_FILE=/var/run/opensips.pid<br /><br />## Extra start options - default is: not set<br /># example: start opensips with 64MB share memory: STARTOPTIONS=&quot;-m 64&quot;<br /># STARTOPTIONS=<br /><br />@]<br /><br />----<br />!!!! /usr/local/opensips/etc/opensips/opensips_residential_01.cfg<br /><br />We created before using the osipsconfig utility a residential script, and we requested the following options: ENABLE_TCP, USE_ALIASES, USE_AUTH, USE_DBACC, USE_DBUSRLOC, USE_DIALOG, USE_DIALPLAN, VM_DIVERSION.<br /><br />So, we have tcp in addition to udp connectivity, aliases on login, authorization checks, db based accounting and location service, dialog tracking, dialplan transformations, and diversion (redirection) to voicemail server in case of no answer, busy, declined, etc.<br /><br />In this file you modify DB related values, inserting one block that was missed, IP addresses, syslog facility, modules path (follow &quot;CUSTOMIZE&quot;).<br /><br />Then you add a route( marked &quot;2&quot;) that checks if the called number begins with &quot;*&quot; (star) in which case strips the first * and sends the call to FreeSWITCH (marked &quot;freeswitch&quot;).<br /><br />Then you put the correct FreeSWITCH IP address where it redirects to VM (marked &quot;freeswitch&quot;).<br /><br /><br />[@<br /><br />#<br /># $Id: opensips_residential.m4 9042 2012-05-17 13:57:10Z vladut-paiu $<br />#<br /># OpenSIPS residential configuration script<br />#     by OpenSIPS Solutions &lt;team@opensips-solutions.com&gt;<br />#<br /># This script was generated via &quot;make menuconfig&quot;, from<br />#   the &quot;Residential&quot; scenario.<br /># You can enable / disable more features / functionalities by<br />#   re-generating the scenario with different options.#<br />#<br /># Please refer to the Core CookBook at:<br />#      http://www.opensips.org/Resources/DocsCookbooks<br /># for a explanation of possible statements, functions and parameters.<br />#<br /><br /><br />####### Global Parameters #########<br /><br />debug=3<br />log_stderror=no<br />log_facility=LOG_LOCAL1 # CUSTOMIZE ME<br /><br />fork=yes<br />children=4<br /><br />/* uncomment the following lines to enable debugging */<br />#debug=6<br />#fork=no<br />#log_stderror=yes<br /><br />/* uncomment the next line to enable the auto temporary blacklisting of<br />   not available destinations (default disabled) */<br />#disable_dns_blacklist=no<br /><br />/* uncomment the next line to enable IPv6 lookup after IPv4 dns<br />   lookup failures (default disabled) */<br />#dns_try_ipv6=yes<br /><br />/* comment the next line to enable the auto discovery of local aliases<br />   based on revers DNS on IPs */<br />auto_aliases=no<br /><br /><br />listen=udp:192.168.1.110:5060   # CUSTOMIZE ME<br /><br />disable_tcp=no<br />listen=tcp:192.168.1.110:5060   # CUSTOMIZE ME<br /><br />disable_tls=yes<br /><br /><br />####### Modules Section ########<br /><br />#set module path<br />mpath=&quot;/usr/local/opensips/lib64/opensips/modules/&quot; # CUSTOMIZE ME<br /><br />#### SIGNALING module<br />loadmodule &quot;signaling.so&quot;<br /><br />#### StateLess module<br />loadmodule &quot;sl.so&quot;<br /><br />#### Transaction Module<br />loadmodule &quot;tm.so&quot;<br />modparam(&quot;tm&quot;, &quot;fr_timer&quot;, 5)<br />modparam(&quot;tm&quot;, &quot;fr_inv_timer&quot;, 30)<br />modparam(&quot;tm&quot;, &quot;restart_fr_on_each_reply&quot;, 0)<br />modparam(&quot;tm&quot;, &quot;onreply_avp_mode&quot;, 1)<br /><br />#### Record Route Module<br />loadmodule &quot;rr.so&quot;<br />/* do not append from tag to the RR (no need for this script) */<br />modparam(&quot;rr&quot;, &quot;append_fromtag&quot;, 0)<br /><br />#### MAX ForWarD module<br />loadmodule &quot;maxfwd.so&quot;<br /><br />#### SIP MSG OPerationS module<br />loadmodule &quot;sipmsgops.so&quot;<br /><br />#### FIFO Management Interface<br />loadmodule &quot;mi_fifo.so&quot;<br />modparam(&quot;mi_fifo&quot;, &quot;fifo_name&quot;, &quot;/tmp/opensips_fifo&quot;)<br />modparam(&quot;mi_fifo&quot;, &quot;fifo_mode&quot;, 0666)<br /><br /><br />#### URI module<br />loadmodule &quot;uri.so&quot;<br />modparam(&quot;uri&quot;, &quot;use_uri_table&quot;, 0)<br />modparam(&quot;uri&quot;, &quot;db_url&quot;, # ADD and CUSTOMIZE ME<br />        &quot;mysql://opensips:mydbpassword@localhost/opensips&quot;) # ADD and CUSTOMIZE ME<br /><br /><br /><br /><br />#### MYSQL module<br />loadmodule &quot;db_mysql.so&quot;<br /><br />#### USeR LOCation module<br />loadmodule &quot;usrloc.so&quot;<br />modparam(&quot;usrloc&quot;, &quot;nat_bflag&quot;, 10)<br />modparam(&quot;usrloc&quot;, &quot;db_mode&quot;,   2)<br />modparam(&quot;usrloc&quot;, &quot;db_url&quot;,<br />        &quot;mysql://opensips:mydbpassword@localhost/opensips&quot;) # CUSTOMIZE ME<br /><br /><br />#### REGISTRAR module<br />loadmodule &quot;registrar.so&quot;<br />modparam(&quot;registrar&quot;, &quot;tcp_persistent_flag&quot;, 7)<br /><br />/* uncomment the next line not to allow more than 10 contacts per AOR */<br />#modparam(&quot;registrar&quot;, &quot;max_contacts&quot;, 10)<br /><br />#### ACCounting module<br />loadmodule &quot;acc.so&quot;<br />/* what special events should be accounted ? */<br />modparam(&quot;acc&quot;, &quot;early_media&quot;, 0)<br />modparam(&quot;acc&quot;, &quot;report_cancels&quot;, 0)<br />/* by default we do not adjust the direct of the sequential requests.<br />   if you enable this parameter, be sure the enable &quot;append_fromtag&quot;<br />   in &quot;rr&quot; module */<br />modparam(&quot;acc&quot;, &quot;detect_direction&quot;, 0)<br />modparam(&quot;acc&quot;, &quot;failed_transaction_flag&quot;, 3)<br />/* account triggers (flags) */<br />modparam(&quot;acc&quot;, &quot;db_flag&quot;, 1)<br />modparam(&quot;acc&quot;, &quot;db_missed_flag&quot;, 2)<br />modparam(&quot;acc&quot;, &quot;db_url&quot;,<br />        &quot;mysql://opensips:mydbpassword@localhost/opensips&quot;) # CUSTOMIZE ME<br /><br /><br />#### AUTHentication modules<br />loadmodule &quot;auth.so&quot;<br />loadmodule &quot;auth_db.so&quot;<br />modparam(&quot;auth_db&quot;, &quot;calculate_ha1&quot;, yes)<br />modparam(&quot;auth_db&quot;, &quot;password_column&quot;, &quot;password&quot;)<br />modparam(&quot;auth_db&quot;, &quot;db_url&quot;,<br />        &quot;mysql://opensips:mydbpassword@localhost/opensips&quot;) # CUSTOMIZE ME<br />modparam(&quot;auth_db&quot;, &quot;load_credentials&quot;, &quot;&quot;)<br /><br /><br />#### ALIAS module<br />loadmodule &quot;alias_db.so&quot;<br />modparam(&quot;alias_db&quot;, &quot;db_url&quot;,<br />        &quot;mysql://opensips:mydbpassword@localhost/opensips&quot;) # CUSTOMIZE ME<br /><br /><br /><br /><br /><br /><br />#### DIALOG module<br />loadmodule &quot;dialog.so&quot;<br />modparam(&quot;dialog&quot;, &quot;dlg_match_mode&quot;, 1)<br />modparam(&quot;dialog&quot;, &quot;default_timeout&quot;, 21600)  # 6 hours timeout<br />modparam(&quot;dialog&quot;, &quot;db_mode&quot;, 2)<br />modparam(&quot;dialog&quot;, &quot;db_url&quot;,<br />        &quot;mysql://opensips:mydbpassword@localhost/opensips&quot;) # CUSTOMIZE ME<br /><br /><br /><br /><br />####  DIALPLAN module<br />loadmodule &quot;dialplan.so&quot;<br />modparam(&quot;dialplan&quot;, &quot;db_url&quot;,<br />        &quot;mysql://opensips:mydbpassword@localhost/opensips&quot;) # CUSTOMIZE ME<br /><br /><br /><br /><br /><br /><br />####### Routing Logic ########<br /><br /># main request routing logic<br /><br />route{<br /><br /><br />        if (!mf_process_maxfwd_header(&quot;10&quot;)) {<br />                sl_send_reply(&quot;483&quot;,&quot;Too Many Hops&quot;);<br />                exit;<br />        }<br /><br />        if (has_totag()) {<br />                # sequential request withing a dialog should<br />                # take the path determined by record-routing<br />                if (loose_route()) {<br /><br />                        # validate the sequential request against dialog<br />                        if ( $DLG_status!=NULL &amp;&amp; !validate_dialog() ) {<br />                                xlog(&quot;In-Dialog $rm from $si (callid=$ci) is not valid according to dialog\n&quot;);<br />                                ## exit;<br />                        }<br /><br />                        if (is_method(&quot;BYE&quot;)) {<br />                                setflag(1); # do accounting ...<br />                                setflag(3); # ... even if the transaction fails<br />                        } else if (is_method(&quot;INVITE&quot;)) {<br />                                # even if in most of the cases is useless, do RR for<br />                                # re-INVITEs alos, as some buggy clients do change route set<br />                                # during the dialog.<br />                                record_route();<br />                        }<br /><br /><br /><br />                        # route it out to whatever destination was set by loose_route()<br />                        # in $du (destination URI).<br />                        route(1);<br />                } else {<br /><br />                        if ( is_method(&quot;ACK&quot;) ) {<br />                                if ( t_check_trans() ) {<br />                                        # non loose-route, but stateful ACK; must be an ACK after<br />                                        # a 487 or e.g. 404 from upstream server<br />                                        t_relay();<br />                                        exit;<br />                                } else {<br />                                        # ACK without matching transaction -&gt;<br />                                        # ignore and discard<br />                                        exit;<br />                                }<br />                        }<br />                        sl_send_reply(&quot;404&quot;,&quot;Not here&quot;);<br />                }<br />                exit;<br />        }<br /><br />        # CANCEL processing<br />        if (is_method(&quot;CANCEL&quot;))<br />        {<br />                if (t_check_trans())<br />                        t_relay();<br />                exit;<br />        }<br /><br />        t_check_trans();<br /><br />        if ( !(is_method(&quot;REGISTER&quot;)  ) ) {<br /><br />                if (from_uri==myself)<br /><br />                {<br /><br />                        # authenticate if from local subscriber<br />                        # authenticate all initial non-REGISTER request that pretend to be<br />                        # generated by local subscriber (domain from FROM URI is local)<br />                        if (!proxy_authorize(&quot;&quot;, &quot;subscriber&quot;)) {<br />                                proxy_challenge(&quot;&quot;, &quot;0&quot;);<br />                                exit;<br />                        }<br />                        if (!db_check_from()) {<br />                                sl_send_reply(&quot;403&quot;,&quot;Forbidden auth ID&quot;);<br />                                exit;<br />                        }<br /><br />                        consume_credentials();<br />                        # caller authenticated<br /><br />                } else {<br />                        # if caller is not local, then called number must be local<br /><br />                        if (!uri==myself) {<br />                                send_reply(&quot;403&quot;,&quot;Rely forbidden&quot;);<br />                                exit;<br />                        }<br />                }<br /><br />        }<br /><br />        # preloaded route checking<br />        if (loose_route()) {<br />                xlog(&quot;L_ERR&quot;,<br />                &quot;Attempt to route with preloaded Route's [$fu/$tu/$ru/$ci]&quot;);<br />                if (!is_method(&quot;ACK&quot;))<br />                        sl_send_reply(&quot;403&quot;,&quot;Preload Route denied&quot;);<br />                exit;<br />        }<br /><br />        # record routing<br />        if (!is_method(&quot;REGISTER|MESSAGE&quot;))<br />                record_route();<br /><br />        # account only INVITEs<br />        if (is_method(&quot;INVITE&quot;)) {<br /><br />                # create dialog with timeout<br />                if ( !create_dialog(&quot;B&quot;) ) {<br />                        send_reply(&quot;500&quot;,&quot;Internal Server Error&quot;);<br />                        exit;<br />                }<br /><br />                setflag(1); # do accounting<br />        }<br /><br /><br />        if (!uri==myself) {<br />                append_hf(&quot;P-hint: outbound\r\n&quot;);<br />                route(1);<br />        }<br /><br />        # requests for my domain<br /><br />        if (is_method(&quot;PUBLISH|SUBSCRIBE&quot;))<br />        {<br />                sl_send_reply(&quot;503&quot;, &quot;Service Unavailable&quot;);<br />                exit;<br />        }<br /><br />        if (is_method(&quot;REGISTER&quot;))<br />        {<br /><br />                # authenticate the REGISTER requests<br />                if (!www_authorize(&quot;&quot;, &quot;subscriber&quot;))<br />                {<br />                        www_challenge(&quot;&quot;, &quot;0&quot;);<br />                        exit;<br />                }<br /><br />                if (!db_check_to())<br />                {<br />                        sl_send_reply(&quot;403&quot;,&quot;Forbidden auth ID&quot;);<br />                        exit;<br />                }<br /><br />                if ( proto==TCP ||  0 ) setflag(7);<br /><br />                if (!save(&quot;location&quot;))<br />                        sl_reply_error();<br /><br />                exit;<br />        }<br /><br />        if ($rU==NULL) {<br />                # request with no Username in RURI<br />                sl_send_reply(&quot;484&quot;,&quot;Address Incomplete&quot;);<br />                exit;<br />        }<br /><br /><br />        # apply DB based aliases<br />        alias_db_lookup(&quot;dbaliases&quot;);<br /><br /><br />        # apply transformations from dialplan table<br />        dp_translate(&quot;0&quot;,&quot;$rU/$rU&quot;);<br /><br /><br />        #freeswitch<br />        route(2); # ADD and CUSTOMIZE ME<br /><br />        # do lookup with method filtering<br />        if (!lookup(&quot;location&quot;,&quot;m&quot;)) {<br />                if (!db_does_uri_exist()) {<br />                        send_reply(&quot;420&quot;,&quot;Bad Extension&quot;);<br />                        exit;<br />                }<br /><br /><br />                # redirect to a different VM system<br />                $du = &quot;sip:192.168.1.110:5090&quot;; # CUSTOMIZE ME #freeswitch<br />                route(1);<br /><br />        }<br /><br /><br />        # when routing via usrloc, log the missed calls also<br />        setflag(2);<br />        route(1);<br />}<br /><br /><br />route[1] {<br />        # for INVITEs enable some additional helper routes<br />        if (is_method(&quot;INVITE&quot;)) {<br /><br /><br /><br />                t_on_branch(&quot;2&quot;);<br />                t_on_reply(&quot;2&quot;);<br />                t_on_failure(&quot;1&quot;);<br />        }<br /><br /><br /><br />        if (!t_relay()) {<br />                send_reply(&quot;500&quot;,&quot;Internal Error&quot;);<br />        };<br />        exit;<br />}<br /><br /># freeswitch<br />route[2] {# ADD and CUSTOMIZE ME<br />        if (!is_method(&quot;INVITE&quot;)) {<br />                return;<br />        }<br /><br />        # if the called number begins with &quot;star&quot; (*) then strip it and redirect to freeswitch <br />        # (if it begins with two stars, eg: **, then one will be passed to FS)<br />        if ($rU=~&quot;^\*&quot;) {<br />                strip(1);<br />                $du = &quot;sip:192.168.1.110:5090&quot;; # CUSTOMIZE ME<br />                route(1);<br />        }<br />}<br /><br /><br /><br />branch_route[2] {<br />        xlog(&quot;new branch at $ru\n&quot;);<br />}<br /><br /><br />onreply_route[2] {<br /><br />        xlog(&quot;incoming reply\n&quot;);<br />}<br /><br /><br />failure_route[1] {<br />        if (t_was_cancelled()) {<br />                exit;<br />        }<br /><br />        # uncomment the following lines if you want to block client<br />        # redirect based on 3xx replies.<br />        ##if (t_check_status(&quot;3[0-9][0-9]&quot;)) {<br />        ##t_reply(&quot;404&quot;,&quot;Not found&quot;);<br />        ##      exit;<br />        ##}<br /><br /><br />        # redirect the failed to a different VM system<br />        if (t_check_status(&quot;486|408&quot;)) {<br />                $du = &quot;sip:192.168.1.110:5090&quot;; # CUSTOMIZE ME<br />                # do not set the missed call flag again<br />                route(1);<br />        }<br />}<br /><br /><br /><br />local_route {<br />        if (is_method(&quot;BYE&quot;) &amp;&amp; $DLG_dir==&quot;UPSTREAM&quot;) {<br /><br />                acc_db_request(&quot;200 Dialog Timeout&quot;, &quot;acc&quot;);<br /><br />        }<br />}<br /><br />@]<br /><br />----<br />!!!! /usr/local/freeswitch/conf/dialplan/public.xml<br /><br />Starting from the freshly installed default FreeSWITCH &quot;public&quot; (eg: from outside, not trusted to access services and features) dialplan, you insert as the first &quot;extension&quot;, aptly named &quot;from_opensips&quot;, an instruction that checks if the call is coming from the OpenSIPS server IP address, in which case the call is transferred to the corresponding destination_number in the &quot;default&quot; dialplan (eg: can access the services and features as an internal user).<br /><br />You must edit the OpenSIPS IP address.<br /><br />Follow &quot;CUSTOMIZE&quot;.<br /><br />[@<br /><br />&lt;!--<br />    NOTICE:<br /><br />    This context is usually accessed via the external sip profile listening on port 5080.<br /><br />    It is recommended to have separate inbound and outbound contexts.  Not only for security<br />    but clearing up why you would need to do such a thing.  You don't want outside un-authenticated<br />    callers hitting your default context which allows dialing calls thru your providers and results<br />    in Toll Fraud.<br />--&gt;<br /><br />&lt;!-- http://wiki.freeswitch.org/wiki/Dialplan_XML --&gt;<br />&lt;include&gt;<br />  &lt;context name=&quot;public&quot;&gt;<br /><br />    &lt;extension name=&quot;from_opensips&quot;&gt;<br />      &lt;condition field=&quot;network_addr&quot; expression=&quot;^192\.168\.1\.110$&quot;&gt; &lt;!--CUSTOMIZE--&gt;<br />        &lt;action application=&quot;transfer&quot; data=&quot;${destination_number} XML default&quot;/&gt;<br />      &lt;/condition&gt;<br />    &lt;/extension&gt;<br /><br />    &lt;extension name=&quot;unloop&quot;&gt;<br />      &lt;condition field=&quot;${unroll_loops}&quot; expression=&quot;^true$&quot;/&gt;<br />      &lt;condition field=&quot;${sip_looped_call}&quot; expression=&quot;^true$&quot;&gt;<br />        &lt;action application=&quot;deflect&quot; data=&quot;${destination_number}&quot;/&gt;<br />      &lt;/condition&gt;<br />    &lt;/extension&gt;<br />    &lt;!--<br />        Tag anything pass thru here as an outside_call so you can make sure not<br />        to create any routing loops based on the conditions that it came from<br />        the outside of the switch.<br />    --&gt;<br />    &lt;extension name=&quot;outside_call&quot; continue=&quot;true&quot;&gt;<br />      &lt;condition&gt;<br />        &lt;action application=&quot;set&quot; data=&quot;outside_call=true&quot;/&gt;<br />        &lt;action application=&quot;export&quot; data=&quot;RFC2822_DATE=${strftime(%a, %d %b %Y %T %z)}&quot;/&gt;<br />      &lt;/condition&gt;<br />    &lt;/extension&gt;<br /><br />    &lt;extension name=&quot;call_debug&quot; continue=&quot;true&quot;&gt;<br />      &lt;condition field=&quot;${call_debug}&quot; expression=&quot;^true$&quot; break=&quot;never&quot;&gt;<br />        &lt;action application=&quot;info&quot;/&gt;<br />      &lt;/condition&gt;<br />    &lt;/extension&gt;<br /><br />    &lt;extension name=&quot;public_extensions&quot;&gt;<br />      &lt;condition field=&quot;destination_number&quot; expression=&quot;^(10[01][0-9])$&quot;&gt;<br />        &lt;action application=&quot;transfer&quot; data=&quot;$1 XML default&quot;/&gt;<br />      &lt;/condition&gt;<br />    &lt;/extension&gt;<br /><br />    &lt;!--<br />        You can place files in the public directory to get included.<br />    --&gt;<br />    &lt;X-PRE-PROCESS cmd=&quot;include&quot; data=&quot;public/*.xml&quot;/&gt;<br />    &lt;!--<br />        If you have made it this far lets challenge the caller and if they authenticate<br />        lets try what they dialed in the default context. (commented out by default)<br />    --&gt;<br />    &lt;!--<br />    &lt;extension name=&quot;check_auth&quot; continue=&quot;true&quot;&gt;<br />      &lt;condition field=&quot;${sip_authorized}&quot; expression=&quot;^true$&quot; break=&quot;never&quot;&gt;<br />        &lt;anti-action application=&quot;respond&quot; data=&quot;407&quot;/&gt;<br />      &lt;/condition&gt;<br />    &lt;/extension&gt;<br /><br />    &lt;extension name=&quot;transfer_to_default&quot;&gt;<br />      &lt;condition&gt;<br />        &lt;action application=&quot;transfer&quot; data=&quot;${destination_number} XML default&quot;/&gt;<br />      &lt;/condition&gt;<br />    &lt;/extension&gt;<br />    --&gt;<br />  &lt;/context&gt;<br />&lt;/include&gt;<br /><br />@]<br /><br />----<br />!!!! /usr/local/freeswitch/scripts/config.lua<br /><br />This file you create ex-nihilo (eg: is not installed by FreeSWITCH). <br /><br />It is read by the xml_handler script, and configure it with the correct values for directories and database name, user and password.<br /><br />Edit it all, or at least edit &quot;mydbpassword&quot;.<br /><br />Follow &quot;CUSTOMIZE&quot;.<br /><br />[@<br /><br />--switch directories<br />        sounds_dir = &quot;/usr/local/freeswitch/sounds&quot;;<br />        recordings_dir = &quot;/usr/local/freeswitch/recordings&quot;;<br /><br />--database connection info<br />        db_type = &quot;mysql&quot;;<br />        db_name = &quot;opensips&quot;;<br />        dsn_name = &quot;opensips&quot;;<br />        dsn_username = &quot;opensips&quot;;<br />        dsn_password = &quot;mydbpassword&quot;; --CUSTOMIZE<br /><br />--additional info<br />        tmp_dir = &quot;&quot;;<br /><br />@]<br /><br /><br />----<br />!!!! /usr/local/freeswitch/scripts/xml_handler.lua<br /><br />This file you create ex-nihilo (eg: is not installed by FreeSWITCH).<br /><br />It is executed by the mod_lua Lua module, and fetch from OpenSIPS database the values with which it constructs an xml directory snippet that is passed in real time to FreeSWITCH when FS needs info about users.<br /><br />You don't need to edit this file, but can be interesting to read.<br /><br />This file comes originally from FusionPBX ( www.fusionpbx.com ), an opensource web interface to configure and manage FreeSWITCH, and has been cannibalized for our tutorial purposes.<br /><br />Particularly, you can find there almost all the fields that are supported in FS directory (eg user management), so it can be extended easyly sourcing values from the same or other databases.<br /><br /><br />[@<br /><br /><br />--      HEAVILY MODIFIED AND POSSIBLY BUGIFIED BY Giovanni Maruzzelli (gmaruzz@gmail.com)<br /><br />--      xml_handler.lua<br />--      Part of FusionPBX<br />--      Copyright (C) 2010 Mark J Crane &lt;markjcrane@fusionpbx.com&gt;<br />--      All rights reserved.<br />--<br />--      Redistribution and use in source and binary forms, with or without<br />--      modification, are permitted provided that the following conditions are met:<br />--<br />--      1. Redistributions of source code must retain the above copyright notice,<br />--         this list of conditions and the following disclaimer.<br />--<br />--      2. Redistributions in binary form must reproduce the above copyright<br />--         notice, this list of conditions and the following disclaimer in the<br />--         documentation and/or other materials provided with the distribution.<br />--<br />--      THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,<br />--      INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY<br />--      AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE<br />--      AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,<br />--      OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<br />--      SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<br />--      INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN<br />--      CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)<br />--      ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE<br />--      POSSIBILITY OF SUCH DAMAGE.<br /><br /><br />--      HEAVILY MODIFIED AND POSSIBLY BUGIFIED BY Giovanni Maruzzelli (gmaruzz@gmail.com)<br /><br />--set the debug level<br />debug[&quot;params&quot;] = true;<br />debug[&quot;sql&quot;] = true;<br />debug[&quot;xml_request&quot;] = true;<br />debug[&quot;xml_string&quot;] = true;<br /><br />--show param debug info<br />if (debug[&quot;params&quot;]) then<br />        freeswitch.consoleLog(&quot;notice&quot;, &quot;[xml_handler] Params:\n&quot; .. params:serialize() .. &quot;\n&quot;);<br />end<br /><br />--get the params and set them as variables<br />local domain_name = params:getHeader(&quot;domain&quot;);<br />local purpose   = params:getHeader(&quot;purpose&quot;);<br />local profile   = params:getHeader(&quot;profile&quot;);<br />local key    = params:getHeader(&quot;key&quot;);<br />local user   = params:getHeader(&quot;user&quot;);<br />local user_context = params:getHeader(&quot;variable_user_context&quot;);<br />local call_context = params:getHeader(&quot;Caller-Context&quot;);<br />local destination_number = params:getHeader(&quot;Caller-Destination-Number&quot;);<br />local caller_id_number = params:getHeader(&quot;Caller-Caller-ID-Number&quot;);<br /><br />--include the lua script<br />scripts_dir = string.sub(debug.getinfo(1).source,2,string.len(debug.getinfo(1).source)-(string.len(argv[0])+1));<br />include = assert(loadfile(scripts_dir .. &quot;/config.lua&quot;));<br />include();<br /><br />--connect to the database<br />--ODBC - data source name<br />        if (dsn_name) then<br />                dbh = freeswitch.Dbh(dsn_name,dsn_username,dsn_password);<br />        end<br />--FreeSWITCH core db handler<br />        if (db_type == &quot;sqlite&quot;) then<br />                dbh = freeswitch.Dbh(&quot;core:&quot;..db_path..&quot;/&quot;..db_name);<br />        end<br /><br /><br />--handle the directory<br />if (XML_REQUEST[&quot;section&quot;] == &quot;directory&quot; and key and user and domain_name) then<br /><br />--prevent processing for invalid user<br />continue = true;<br />if (user == &quot;*97&quot;) then<br />        continue = false;<br />end<br /><br />--get the extension from the database<br />if (continue) then<br /><br />        sql = &quot;SELECT * FROM subscriber WHERE domain = '&quot; .. domain_name .. &quot;' and username = '&quot; .. user .. &quot;' &quot;;<br />        if (debug[&quot;sql&quot;]) then<br />                freeswitch.consoleLog(&quot;notice&quot;, &quot;[xml_handler] SQL: &quot; .. sql .. &quot;\n&quot;);<br />        end<br />        dbh:query(sql, function(row)<br />                --general<br />                        domain_uuid = &quot;&quot;;<br />                        extension = row.username;<br />                        cidr = &quot;&quot;;<br />                        number_alias = &quot;&quot;;<br />                --params<br />                        password = row.password;<br />                        vm_enabled = &quot;true&quot;;<br />                        vm_password = row.password;<br />                        vm_attach_file = &quot;true&quot;;<br />                        vm_keep_local_after_email = &quot;true&quot;;<br />                        vm_mailto = row.email_address;<br />                        mwi_account = &quot;&quot;;<br />                        auth_acl = &quot;&quot;;<br />                --variables<br />                        sip_from_user = &quot;&quot;;<br />                        call_group = &quot;&quot;;<br />                        hold_music = &quot;&quot;;<br />                        toll_allow = &quot;&quot;;<br />                        accountcode = &quot;&quot;;<br />                        user_context = &quot;default&quot;;<br />                        effective_caller_id_name = &quot;&quot;;<br />                        effective_caller_id_number = &quot;&quot;;<br />                        outbound_caller_id_name = &quot;&quot;;<br />                        outbound_caller_id_number = &quot;&quot;;<br />                        emergency_caller_id_number = &quot;&quot;;<br />                        directory_full_name = &quot;&quot;;<br />                        directory_visible = &quot;&quot;;<br />                        directory_exten_visible = &quot;&quot;;<br />                        limit_max = &quot;&quot;;<br />                        limit_destination = &quot;&quot;;<br />                        sip_force_contact = &quot;&quot;;<br />                        sip_force_expires = &quot;&quot;;<br />                        nibble_account = &quot;&quot;;<br />                        sip_bypass_media = &quot;&quot;;<br /><br />                --set the dial_string<br />                dial_string = &quot;{sip_invite_domain=&quot; .. domain_name .. &quot;,presence_id=&quot; .. user .. &quot;@&quot; ..<br />domain_name .. &quot;}${sofia_contact(&quot; .. user .. &quot;@&quot; .. domain_name .. &quot;)}&quot;;<br /><br />        end);<br />end<br />--set the xml array and then concatenate the array to a string<br />if (password) then<br />        local xml = {}<br />        table.insert(xml, [[&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;]]);<br />        table.insert(xml, [[&lt;document type=&quot;freeswitch/xml&quot;&gt;]]);<br />        table.insert(xml, [[    &lt;section name=&quot;directory&quot;&gt;]]);<br />        table.insert(xml, [[            &lt;domain name=&quot;]] .. domain_name .. [[&quot;&gt;]]);<br />        if (number_alias) then<br />                if (cidr) then<br />                        table.insert(xml, [[                    &lt;user id=&quot;]] .. extension .. [[&quot;]] .. cidr .. number_alias .. [[&gt;]]);<br />                else<br />                        table.insert(xml, [[                    &lt;user id=&quot;]] .. extension .. [[&quot;]] .. number_alias .. [[&gt;]]);<br />                end<br />        else<br />                if (cidr) then<br />                        table.insert(xml, [[                    &lt;user id=&quot;]] .. extension .. [[&quot;]] .. cidr .. [[&gt;]]);<br />                else<br />                        table.insert(xml, [[                    &lt;user id=&quot;]] .. extension .. [[&quot;&gt;]]);<br />                end<br />        end<br />        table.insert(xml, [[                    &lt;params&gt;]]);<br />        table.insert(xml, [[                            &lt;param name=&quot;password&quot; value=&quot;]] .. password .. [[&quot;/&gt;]]);<br />        table.insert(xml, [[                            &lt;param name=&quot;vm-enabled&quot; value=&quot;]] .. vm_enabled .. [[&quot;/&gt;]]);<br />        if (string.len(vm_mailto) &gt; 0) then<br />                table.insert(xml, [[                            &lt;param name=&quot;vm-password&quot; value=&quot;]] .. vm_password  .. [[&quot;/&gt;]]);<br />                table.insert(xml, [[                            &lt;param name=&quot;vm-email-all-messages&quot; value=&quot;]] .. vm_enabled  ..[[&quot;/&gt;]]);<br />                table.insert(xml, [[                            &lt;param name=&quot;vm-attach-file&quot; value=&quot;]] .. vm_attach_file .. [[&quot;/&gt;]]);<br />                table.insert(xml, [[                            &lt;param name=&quot;vm-keep-local-after-email&quot; value=&quot;]] .. vm_keep_local_after_email .. [[&quot;/&gt;]]);<br />                table.insert(xml, [[                            &lt;param name=&quot;vm-mailto&quot; value=&quot;]] .. vm_mailto .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(mwi_account) &gt; 0) then<br />                table.insert(xml, [[                            &lt;param name=&quot;MWI-Account&quot; value=&quot;]] .. mwi_account .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(auth_acl) &gt; 0) then<br />                table.insert(xml, [[                            &lt;param name=&quot;auth-acl&quot; value=&quot;]] .. auth_acl .. [[&quot;/&gt;]]);<br />        end<br />        table.insert(xml, [[                            &lt;param name=&quot;dial-string&quot; value=&quot;]] .. dial_string .. [[&quot;/&gt;]]);<br />        table.insert(xml, [[                    &lt;/params&gt;]]);<br />        table.insert(xml, [[                    &lt;variables&gt;]]);<br />        table.insert(xml, [[                            &lt;variable name=&quot;domain_uuid&quot; value=&quot;]] .. domain_uuid .. [[&quot;/&gt;]]);<br />        if (user_context ~= &quot;default&quot; and user_context ~= &quot;public&quot; and user_context ~= &quot;features&quot;) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;domain_name&quot; value=&quot;]] .. user_context .. [[&quot;/&gt;]]);<br />        end<br />        table.insert(xml, [[                            &lt;variable name=&quot;caller_id_name&quot; value=&quot;]] .. sip_from_user .. [[&quot;/&gt;]]);<br />        table.insert(xml, [[                            &lt;variable name=&quot;caller_id_number&quot; value=&quot;]] .. sip_from_user .. [[&quot;/&gt;]]);<br />        if (string.len(call_group) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;call_group&quot; value=&quot;]] .. call_group .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(hold_music) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;hold_music&quot; value=&quot;]] .. hold_music .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(toll_allow) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;toll_allow&quot; value=&quot;]] .. toll_allow .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(accountcode) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;accountcode&quot; value=&quot;]] .. accountcode .. [[&quot;/&gt;]]);<br />        end<br />        table.insert(xml, [[                            &lt;variable name=&quot;user_context&quot; value=&quot;]] .. user_context .. [[&quot;/&gt;]]);<br />        if (string.len(effective_caller_id_name) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;effective_caller_id_name&quot; value=&quot;]] .. effective_caller_id_name.. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(effective_caller_id_number) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;effective_caller_id_number&quot; value=&quot;]] .. effective_caller_id_number.. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(outbound_caller_id_name) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;outbound_caller_id_name&quot; value=&quot;]] .. outbound_caller_id_name .. [[&quot;/&gt;]]);<br />                table.insert(xml, [[                            &lt;variable name=&quot;outbound_caller_id_name&quot; value=&quot;]] .. outbound_caller_id_name .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(outbound_caller_id_number) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;outbound_caller_id_number&quot; value=&quot;]] .. outbound_caller_id_number .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(emergency_caller_id_number) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;emergency_caller_id_number&quot; value=&quot;]] .. emergency_caller_id_number .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(directory_full_name) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;directory_full_name&quot; value=&quot;]] .. directory_full_name .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(directory_visible) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;directory-visible&quot; value=&quot;]] .. directory_visible .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(directory_exten_visible) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;directory-exten-visible&quot; value=&quot;]] .. directory_exten_visible .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(limit_max) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;limit_max&quot; value=&quot;]] .. limit_max .. [[&quot;/&gt;]]);<br />        else<br />                table.insert(xml, [[                            &lt;variable name=&quot;limit_max&quot; value=&quot;5&quot;/&gt;]]);<br />        end<br />        if (string.len(limit_destination) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;limit_destination&quot; value=&quot;]] .. limit_destination .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(sip_force_contact) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;sip_force_contact&quot; value=&quot;]] .. sip_force_contact .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(sip_force_expires) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;sip-force-expires&quot; value=&quot;]] .. sip_force_expires .. [[&quot;/&gt;]]);<br />        end<br />        if (string.len(nibble_account) &gt; 0) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;nibble_account&quot; value=&quot;]] .. nibble_account .. [[&quot;/&gt;]]);<br />        end<br />        if (sip_bypass_media == &quot;bypass-media&quot;) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;bypass_media&quot; value=&quot;true&quot;/&gt;]]);<br />        end<br />        if (sip_bypass_media == &quot;bypass-media-after-bridge&quot;) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;bypass_media_after_bridge&quot; value=&quot;true&quot;/&gt;]]);<br />        end<br />        if (sip_bypass_media == &quot;proxy-media&quot;) then<br />                table.insert(xml, [[                            &lt;variable name=&quot;proxy_media&quot; value=&quot;true&quot;/&gt;]]);<br />        end<br />        table.insert(xml, [[                            &lt;variable name=&quot;record_stereo&quot; value=&quot;true&quot;/&gt;]]);<br />        table.insert(xml, [[                            &lt;variable name=&quot;transfer_fallback_extension&quot; value=&quot;operator&quot;/&gt;]]);<br />        table.insert(xml, [[                            &lt;variable name=&quot;export_vars&quot; value=&quot;domain_name&quot;/&gt;]]);<br />        table.insert(xml, [[                    &lt;/variables&gt;]]);<br />        table.insert(xml, [[                    &lt;/user&gt;]]);<br />        table.insert(xml, [[            &lt;/domain&gt;]]);<br />        table.insert(xml, [[    &lt;/section&gt;]]);<br />        table.insert(xml, [[&lt;/document&gt;]]);<br />        XML_STRING = table.concat(xml, &quot;\n&quot;);<br />else<br />        XML_STRING = &quot;&quot;;<br />end<br /><br />--send the xml to a file<br />if (debug[&quot;xml_string&quot;]) then<br />        local file = assert(io.open(&quot;/tmp/directory.xml&quot;, &quot;w&quot;));<br />        file:write(XML_STRING);<br />        file:close();<br />end<br /><br />--send the xml to the console<br />if (debug[&quot;xml_string&quot;]) then<br />        freeswitch.consoleLog(&quot;notice&quot;, &quot;[xml_handler] XML_STRING: \n&quot; .. XML_STRING .. &quot;\n&quot;);<br />end<br />end<br /><br />if (debug[&quot;xml_request&quot;]) then<br />        freeswitch.consoleLog(&quot;notice&quot;, &quot;[xml_handler] Section: &quot; .. XML_REQUEST[&quot;section&quot;] .. &quot;\n&quot;);<br />        freeswitch.consoleLog(&quot;notice&quot;, &quot;[xml_handler] Tag Name: &quot; .. XML_REQUEST[&quot;tag_name&quot;] .. &quot;\n&quot;);<br />        freeswitch.consoleLog(&quot;notice&quot;, &quot;[xml_handler] Key Name: &quot; .. XML_REQUEST[&quot;key_name&quot;] .. &quot;\n&quot;);<br />        freeswitch.consoleLog(&quot;notice&quot;, &quot;[xml_handler] Key Value: &quot; .. XML_REQUEST[&quot;key_value&quot;] .. &quot;\n&quot;);<br />end<br /><br /><br />@]<br /><br />----<br />!!!! /usr/local/freeswitch/conf/vars.xml<br /><br />This file contains the variables that are interpolated into FreeSWITCH configuration files when they are sourced the first time at FreeSWITCH startup (eg: NOT when you &quot;reload&quot; FreeSWITCH).<br /><br />Here you do not have to change nothing, we configured FreeSWITCH ports before.<br /><br />Anyway, they're marked &quot;CUSTOMIZE&quot;.<br /><br />[@<br /><br />&lt;include&gt;<br />  &lt;!-- Preprocessor Variables<br />       These are introduced when configuration strings must be consistent across modules.<br />       NOTICE: YOU CAN NOT COMMENT OUT AN X-PRE-PROCESS line, Remove the line instead.<br /><br />       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING<br /><br />       YOU SHOULD CHANGE THIS default_password value if you don't want to be subject to any<br />       toll fraud in the future.  It's your responsibility to secure your own system.<br /><br />       This default config is used to demonstrate the feature set of FreeSWITCH.<br /><br />       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_password=1234&quot;/&gt;<br />  &lt;!-- Did you change it yet? --&gt;<br /><br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;sound_prefix=$${sounds_dir}/en/us/callie&quot;/&gt;<br /><br />  &lt;!--<br />      This setting is what sets the default domain FreeSWITCH will use if all else fails.<br /><br />      FreeSWICH will default to $${local_ip_v4} unless changed.  Changing this setting does<br />      affect the sip authentication.  Please review conf/directory/default.xml for more<br />      information on this topic.<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;domain=$${local_ip_v4}&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;domain_name=$${domain}&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;hold_music=local_stream://moh&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;use_profile=internal&quot;/&gt;<br /><br />  &lt;!--<br />      Enable ZRTP globally you can override this on a per channel basis<br /><br />      http://wiki.freeswitch.org/wiki/ZRTP (on how to enable zrtp)<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;zrtp_secure_media=true&quot;/&gt;<br /><br />  &lt;!--<br />       Examples of codec options: (module must be compiled and loaded)<br /><br />       codecname[@8000h|16000h|32000h[@XXi]]<br /><br />       XX is the frame size must be multples allowed for the codec<br />       FreeSWITCH can support 10-120ms on some codecs.<br />       We do not support exceeding the MTU of the RTP packet.<br /><br /><br />       iLBC@30i         - iLBC using mode=30 which will win in all cases.<br />       DVI4@8000h@20i   - IMA ADPCM 8kHz using 20ms ptime. (multiples of 10)<br />       DVI4@16000h@40i  - IMA ADPCM 16kHz using 40ms ptime. (multiples of 10)<br />       speex@8000h@20i  - Speex 8kHz using 20ms ptime.<br />       speex@16000h@20i - Speex 16kHz using 20ms ptime.<br />       speex@32000h@20i - Speex 32kHz using 20ms ptime.<br />       BV16             - BroadVoice 16kb/s narrowband, 8kHz<br />       BV32             - BroadVoice 32kb/s wideband, 16kHz<br />       G7221@16000h     - G722.1 16kHz (aka Siren 7)<br />       G7221@32000h     - G722.1C 32kHz (aka Siren 14)<br />       CELT@32000h      - CELT 32kHz, only 10ms supported<br />       CELT@48000h      - CELT 48kHz, only 10ms supported<br />       GSM@40i          - GSM 8kHz using 40ms ptime. (GSM is done in multiples of 20, Default is 20ms)<br />       G722             - G722 16kHz using default 20ms ptime. (multiples of 10)<br />       PCMU             - G711 8kHz ulaw using default 20ms ptime. (multiples of 10)<br />       PCMA             - G711 8kHz alaw using default 20ms ptime. (multiples of 10)<br />       G726-16          - G726 16kbit adpcm using default 20ms ptime. (multiples of 10)<br />       G726-24          - G726 24kbit adpcm using default 20ms ptime. (multiples of 10)<br />       G726-32          - G726 32kbit adpcm using default 20ms ptime. (multiples of 10)<br />       G726-40          - G726 40kbit adpcm using default 20ms ptime. (multiples of 10)<br />       AAL2-G726-16     - Same as G726-16 but using AAL2 packing. (multiples of 10)<br />       AAL2-G726-24     - Same as G726-24 but using AAL2 packing. (multiples of 10)<br />       AAL2-G726-32     - Same as G726-32 but using AAL2 packing. (multiples of 10)<br />       AAL2-G726-40     - Same as G726-40 but using AAL2 packing. (multiples of 10)<br />       LPC              - LPC10 using 90ms ptime (only supports 90ms at this time in FreeSWITCH)<br />       L16              - L16 isn't recommended for VoIP but you can do it. L16 can exceed the MTU rather quickly.<br /><br />       These are the passthru audio codecs:<br /><br />       G729             - G729 in passthru mode. (mod_g729)<br />       G723             - G723.1 in passthru mode. (mod_g723_1)<br />       AMR              - AMR in passthru mode. (mod_amr)<br /><br />       These are the passthru video codecs: (mod_h26x)<br /><br />       H261             - H.261 Video<br />       H263             - H.263 Video<br />       H263-1998        - H.263-1998 Video<br />       H263-2000        - H.263-2000 Video<br />       H264             - H.264 Video<br /><br />       RTP Dynamic Payload Numbers currently used in FreeSWITCH and what for.<br /><br />       96  - AMR<br />       97  - iLBC (30)<br />       98  - iLBC (20)<br />       99  - Speex 8kHz, 16kHz, 32kHz<br />       100 -<br />       101 - telephone-event<br />       102 -<br />       103 -<br />       104 -<br />       105 -<br />       106 - BV16<br />       107 - G722.1 (16kHz)<br />       108 -<br />       109 -<br />       110 -<br />       111 -<br />       112 -<br />       113 -<br />       114 - CELT 32kHz, 48kHz<br />       115 - G722.1C (32kHz)<br />       116 -<br />       117 - SILK 8kHz<br />       118 - SILK 12kHz<br />       119 - SILK 16kHz<br />       120 - SILK 24kHz<br />       121 - AAL2-G726-40 &amp;&amp; G726-40<br />       122 - AAL2-G726-32 &amp;&amp; G726-32<br />       123 - AAL2-G726-24 &amp;&amp; G726-24<br />       124 - AAL2-G726-16 &amp;&amp; G726-16<br />       125 -<br />       126 -<br />       127 - BV32<br /><br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;global_codec_prefs=G722,PCMU,PCMA,GSM&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;outbound_codec_prefs=PCMU,PCMA,GSM&quot;/&gt;<br /><br />  &lt;!--<br />      xmpp_client_profile and xmpp_server_profile<br />      xmpp_client_profile can be any string.<br />      xmpp_server_profile is appended to &quot;dingaling_&quot; to form the database name<br />      containing the &quot;subscriptions&quot; table.<br />      used by: dingaling.conf.xml enum.conf.xml<br />  --&gt;<br /><br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;xmpp_client_profile=xmppc&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;xmpp_server_profile=xmpps&quot;/&gt;<br />  &lt;!--<br />       THIS IS ONLY USED FOR DINGALING<br /><br />       bind_server_ip<br /><br />       Can be an ip address, a dns name, or &quot;auto&quot;.<br />       This determines an ip address available on this host to bind.<br />       If you are separating RTP and SIP traffic, you will want to have<br />       use different addresses where this variable appears.<br />       Used by: dingaling.conf.xml<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;bind_server_ip=auto&quot;/&gt;<br /><br />  &lt;!-- NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE<br /><br />       If you're going to load test FreeSWITCH please input real IP addresses<br />       for external_rtp_ip and external_sip_ip<br />  --&gt;<br /><br />  &lt;!-- external_rtp_ip<br />       Can be an one of:<br />           ip address: &quot;12.34.56.78&quot;<br />           a stun server lookup: &quot;stun:stun.server.com&quot;<br />           a DNS name: &quot;host:host.server.com&quot;<br />       where fs.mydomain.com is a DNS A record-useful when fs is on<br />       a dynamic IP address, and uses a dynamic DNS updater.<br />       If unspecified, the bind_server_ip value is used.<br />       Used by: sofia.conf.xml dingaling.conf.xml<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;external_rtp_ip=stun:stun.freeswitch.org&quot;/&gt;<br /><br />  &lt;!-- external_sip_ip<br />      Used as the public IP address for SDP.<br />       Can be an one of:<br />           ip address: &quot;12.34.56.78&quot;<br />           a stun server lookup: &quot;stun:stun.server.com&quot;<br />           a DNS name: &quot;host:host.server.com&quot;<br />       where fs.mydomain.com is a DNS A record-useful when fs is on<br />       a dynamic IP address, and uses a dynamic DNS updater.<br />       If unspecified, the bind_server_ip value is used.<br />       Used by: sofia.conf.xml dingaling.conf.xml<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;external_sip_ip=stun:stun.freeswitch.org&quot;/&gt;<br /><br />  &lt;!-- unroll-loops<br />       Used to turn on sip loopback unrolling.<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;unroll_loops=true&quot;/&gt;<br /><br />  &lt;!-- outbound_caller_id and outbound_caller_name<br />       The caller ID telephone number we should use when calling out.<br />       Used by: conference.conf.xml and user directory for default<br />       outbound callerid name and number.<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;outbound_caller_name=FreeSWITCH&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;outbound_caller_id=0000000000&quot;/&gt;<br /><br />  &lt;!-- various debug and defaults --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;call_debug=false&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;console_loglevel=info&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_areacode=918&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_country=US&quot;/&gt;<br /><br />  &lt;!-- if false or undefined, the destination number is included in presence NOTIFY dm:note.<br />       if true, the destination number is not included --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;presence_privacy=false&quot;/&gt;<br /><br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;be-ring=%(1000,3000,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;ca-ring=%(2000,4000,440,480)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;cn-ring=%(1000,4000,450)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;cy-ring=%(1500,3000,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;cz-ring=%(1000,4000,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;de-ring=%(1000,4000,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;dk-ring=%(1000,4000,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;dz-ring=%(1500,3500,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;eg-ring=%(2000,1000,475,375)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;es-ring=%(1500,3000,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;fi-ring=%(1000,4000,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;fr-ring=%(1500,3500,440)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;hk-ring=%(400,200,440,480);%(400,3000,440,480)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;hu-ring=%(1250,3750,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;il-ring=%(1000,3000,400)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;in-ring=%(400,200,425,375);%(400,2000,425,375)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;jp-ring=%(1000,2000,420,380)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;ko-ring=%(1000,2000,440,480)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;pk-ring=%(1000,2000,400)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;pl-ring=%(1000,4000,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;ro-ring=%(1850,4150,475,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;rs-ring=%(1000,4000,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;ru-ring=%(800,3200,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;sa-ring=%(1200,4600,425)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;tr-ring=%(2000,4000,450)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;uk-ring=%(400,200,400,450);%(400,2000,400,450)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;us-ring=%(2000,4000,440,480)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;bong-ring=v=-7;%(100,0,941.0,1477.0);v=-7;&gt;=2;+=.1;%(1400,0,350,440)&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;sit=%(274,0,913.8);%(274,0,1370.6);%(380,0,1776.7)&quot;/&gt;<br />  &lt;!--<br />      Setting up your default sip provider is easy.<br />      Below are some values that should work in most cases.<br /><br />      These are for conf/directory/default/example.com.xml<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_provider=example.com&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_provider_username=joeuser&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_provider_password=password&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_provider_from_domain=example.com&quot;/&gt;<br />  &lt;!-- true or false --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_provider_register=false&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;default_provider_contact=5000&quot;/&gt;<br /><br />  &lt;!--<br />      SIP and TLS settings. http://wiki.freeswitch.org/wiki/Tls<br />  --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;sip_tls_version=tlsv1&quot;/&gt;<br /><br />  &lt;!-- Internal SIP Profile --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;internal_auth_calls=true&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;internal_sip_port=5090&quot;/&gt; &lt;!--CUSTOMIZE--&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;internal_tls_port=5061&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;internal_ssl_enable=false&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;internal_ssl_dir=$${base_dir}/conf/ssl&quot;/&gt;<br /><br />  &lt;!-- External SIP Profile --&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;external_auth_calls=false&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;external_sip_port=5091&quot;/&gt; &lt;!--CUSTOMIZE--&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;external_tls_port=5081&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;external_ssl_enable=false&quot;/&gt;<br />  &lt;X-PRE-PROCESS cmd=&quot;set&quot; data=&quot;external_ssl_dir=$${base_dir}/conf/ssl&quot;/&gt;<br />&lt;/include&gt;<br /><br /><br />@]<br /><br /><br />----<br />!!!! /usr/local/freeswitch/conf/autoload_configs/modules.conf.xml<br /><br />This file controls which FreeSWITCH modules are loaded at startup time.<br /><br />No changes from standard original FreeSWITCH configuration, just be sure mod_lua is not commented out. We use Lua for database user management.<br /><br />[@<br /><br />&lt;configuration name=&quot;modules.conf&quot; description=&quot;Modules&quot;&gt;<br />  &lt;modules&gt;<br /><br />    &lt;!-- Loggers (I'd load these first) --&gt;<br />    &lt;load module=&quot;mod_console&quot;/&gt;<br />    &lt;load module=&quot;mod_logfile&quot;/&gt;<br />    &lt;!-- &lt;load module=&quot;mod_syslog&quot;/&gt; --&gt;<br /><br />    &lt;!--&lt;load module=&quot;mod_yaml&quot;/&gt;--&gt;<br /><br />    &lt;!-- Multi-Faceted --&gt;<br />    &lt;!-- mod_enum is a dialplan interface, an application interface and an api command interface --&gt;<br />    &lt;load module=&quot;mod_enum&quot;/&gt;<br /><br />    &lt;!-- XML Interfaces --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_xml_rpc&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_xml_curl&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_xml_cdr&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_xml_scgi&quot;/&gt; --&gt;<br /><br />    &lt;!-- Event Handlers --&gt;<br />    &lt;load module=&quot;mod_cdr_csv&quot;/&gt;<br />    &lt;!-- &lt;load module=&quot;mod_cdr_sqlite&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_event_multicast&quot;/&gt; --&gt;<br />    &lt;load module=&quot;mod_event_socket&quot;/&gt;<br />    &lt;!-- &lt;load module=&quot;mod_event_zmq&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_zeroconf&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_erlang_event&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_snmp&quot;/&gt; --&gt;<br /><br />    &lt;!-- Directory Interfaces --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_ldap&quot;/&gt; --&gt;<br /><br />    &lt;!-- Endpoints --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_dingaling&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_portaudio&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_alsa&quot;/&gt; --&gt;<br />    &lt;load module=&quot;mod_sofia&quot;/&gt;<br />    &lt;load module=&quot;mod_loopback&quot;/&gt;<br />    &lt;!-- &lt;load module=&quot;mod_woomera&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_freetdm&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_openzap&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_unicall&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_skinny&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_khomp&quot;/&gt;   --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_rtmp&quot;/&gt;   --&gt;<br /><br />    &lt;!-- Applications --&gt;<br />    &lt;load module=&quot;mod_commands&quot;/&gt;<br />    &lt;load module=&quot;mod_conference&quot;/&gt;<br />    &lt;load module=&quot;mod_db&quot;/&gt;<br />    &lt;load module=&quot;mod_dptools&quot;/&gt;<br />    &lt;load module=&quot;mod_expr&quot;/&gt;<br />    &lt;load module=&quot;mod_fifo&quot;/&gt;<br />    &lt;load module=&quot;mod_hash&quot;/&gt;<br />    &lt;load module=&quot;mod_voicemail&quot;/&gt;<br />    &lt;!--&lt;load module=&quot;mod_directory&quot;/&gt;--&gt;<br />    &lt;!--&lt;load module=&quot;mod_distributor&quot;/&gt;--&gt;<br />    &lt;!--&lt;load module=&quot;mod_lcr&quot;/&gt;--&gt;<br />    &lt;load module=&quot;mod_esf&quot;/&gt;<br />    &lt;load module=&quot;mod_fsv&quot;/&gt;<br />    &lt;load module=&quot;mod_cluechoo&quot;/&gt;<br />    &lt;load module=&quot;mod_valet_parking&quot;/&gt;<br />    &lt;!--&lt;load module=&quot;mod_fsk&quot;/&gt;--&gt;<br />    &lt;!--&lt;load module=&quot;mod_spy&quot;/&gt;--&gt;<br />    &lt;!--&lt;load module=&quot;mod_random&quot;/&gt;--&gt;<br />    &lt;load module=&quot;mod_httapi&quot;/&gt;<br /><br />    &lt;!-- SNOM Module --&gt;<br />    &lt;!--&lt;load module=&quot;mod_snom&quot;/&gt;--&gt;<br /><br />    &lt;!-- This one only works on Linux for now --&gt;<br />    &lt;!--&lt;load module=&quot;mod_ladspa&quot;/&gt;--&gt;<br /><br />    &lt;!-- Dialplan Interfaces --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_dialplan_directory&quot;/&gt; --&gt;<br />    &lt;load module=&quot;mod_dialplan_xml&quot;/&gt;<br />    &lt;load module=&quot;mod_dialplan_asterisk&quot;/&gt;<br /><br />    &lt;!-- Codec Interfaces --&gt;<br />    &lt;load module=&quot;mod_spandsp&quot;/&gt;<br />    &lt;load module=&quot;mod_g723_1&quot;/&gt;<br />    &lt;load module=&quot;mod_g729&quot;/&gt;<br />    &lt;load module=&quot;mod_amr&quot;/&gt;<br />    &lt;!--&lt;load module=&quot;mod_ilbc&quot;/&gt;--&gt;<br />    &lt;load module=&quot;mod_speex&quot;/&gt;<br />    &lt;load module=&quot;mod_h26x&quot;/&gt;<br />    &lt;load module=&quot;mod_vp8&quot;/&gt;<br />    &lt;!--&lt;load module=&quot;mod_siren&quot;/&gt;--&gt;<br />    &lt;!--&lt;load module=&quot;mod_isac&quot;/&gt;--&gt;<br />    &lt;!--&lt;load module=&quot;mod_celt&quot;/&gt;--&gt;<br />    &lt;!--&lt;load module=&quot;mod_opus&quot;/&gt;--&gt;<br /><br />    &lt;!-- File Format Interfaces --&gt;<br />    &lt;load module=&quot;mod_sndfile&quot;/&gt;<br />    &lt;load module=&quot;mod_native_file&quot;/&gt;<br />    &lt;!-- &lt;load module=&quot;mod_shell_stream&quot;/&gt; --&gt;<br />    &lt;!--For icecast/mp3 streams/files--&gt;<br />    &lt;!--&lt;load module=&quot;mod_shout&quot;/&gt;--&gt;<br />    &lt;!--For local streams (play all the files in a directory)--&gt;<br />    &lt;load module=&quot;mod_local_stream&quot;/&gt;<br />    &lt;load module=&quot;mod_tone_stream&quot;/&gt;<br /><br />    &lt;!-- Timers --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_timerfd&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_posix_timer&quot;/&gt; --&gt;<br /><br />    &lt;!-- Languages --&gt;<br />    &lt;load module=&quot;mod_spidermonkey&quot;/&gt;<br />    &lt;!-- &lt;load module=&quot;mod_perl&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_python&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_java&quot;/&gt; --&gt;<br />    &lt;load module=&quot;mod_lua&quot;/&gt;<br /><br />    &lt;!-- ASR /TTS --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_flite&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_pocketsphinx&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_cepstral&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_tts_commandline&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_rss&quot;/&gt; --&gt;<br /><br />    &lt;!-- Say --&gt;<br />    &lt;load module=&quot;mod_say_en&quot;/&gt;<br />    &lt;!-- &lt;load module=&quot;mod_say_ru&quot;/&gt; --&gt;<br />    &lt;!-- &lt;load module=&quot;mod_say_zh&quot;/&gt; --&gt;<br /><br />    &lt;!-- Third party modules --&gt;<br />    &lt;!--&lt;load module=&quot;mod_nibblebill&quot;/&gt;--&gt;<br />    &lt;!--&lt;load module=&quot;mod_callcenter&quot;/&gt;--&gt;<br /><br />  &lt;/modules&gt;<br />&lt;/configuration&gt;<br /><br /><br />@]<br /><br />----<br />!!!! /usr/local/freeswitch/conf/autoload_configs/lua.conf.xml<br /><br />This is the configuration file for mod_lua.<br /><br />Start with the standard installed file, and then add the name of the script that will provide the XML data (in our case &quot;xml_handler.lua&quot;) for which part of FreeSWITCH (in our case just for the &quot;directory&quot; part).<br /><br />You don't need to customize this file, but the lines added are marked as &quot;CUSTOMIZE&quot;.<br /><br />[@<br /><br />&lt;configuration name=&quot;lua.conf&quot; description=&quot;LUA Configuration&quot;&gt;<br />  &lt;settings&gt;<br /><br />    &lt;!--<br />    Specify local directories that will be searched for LUA modules<br />    These entries will be pre-pended to the LUA_CPATH environment variable<br />    --&gt;<br />    &lt;!-- &lt;param name=&quot;module-directory&quot; value=&quot;/usr/lib/lua/5.1/?.so&quot;/&gt; --&gt;<br />    &lt;!-- &lt;param name=&quot;module-directory&quot; value=&quot;/usr/local/lib/lua/5.1/?.so&quot;/&gt; --&gt;<br /><br />    &lt;!--<br />    Specify local directories that will be searched for LUA scripts<br />    These entries will be pre-pended to the LUA_PATH environment variable<br />    --&gt;<br />    &lt;!-- &lt;param name=&quot;script-directory&quot; value=&quot;/usr/local/lua/?.lua&quot;/&gt; --&gt;<br />    &lt;!-- &lt;param name=&quot;script-directory&quot; value=&quot;$${base_dir}/scripts/?.lua&quot;/&gt; --&gt;<br /><br />    &lt;!--&lt;param name=&quot;xml-handler-script&quot; value=&quot;/dp.lua&quot;/&gt;--&gt;<br />    &lt;!--&lt;param name=&quot;xml-handler-bindings&quot; value=&quot;dialplan&quot;/&gt;--&gt;<br /><br />    &lt;!--<br />        The following options identifies a lua script that is launched<br />        at startup and may live forever in the background.<br />        You can define multiple lines, one for each script you<br />        need to run.<br />    --&gt;<br />    &lt;!--&lt;param name=&quot;startup-script&quot; value=&quot;startup_script_1.lua&quot;/&gt;--&gt;<br />    &lt;!--&lt;param name=&quot;startup-script&quot; value=&quot;startup_script_2.lua&quot;/&gt;--&gt;<br />        &lt;param name=&quot;xml-handler-script&quot; value=&quot;xml_handler.lua&quot;/&gt; &lt;!--CUSTOMIZE--&gt;<br />        &lt;param name=&quot;xml-handler-bindings&quot; value=&quot;directory&quot;/&gt; &lt;!--CUSTOMIZE--&gt;<br />  &lt;/settings&gt;<br />&lt;/configuration&gt;<br /><br />@]<br /><br />----<br />!!!! /usr/local/freeswitch/conf/autoload_configs/acl.conf.xml<br /><br />This file configure the Access Control List (ACL) for FreeSWITCH.<br /><br />Starting from the original installed file, you insert one line that allows (without further checking for authorization) any call coming from the OpenSIPS IP address.<br /><br />You need to customize that IP address, follow &quot;CUSTOMIZE&quot;.<br /><br />[@<br /><br />&lt;configuration name=&quot;acl.conf&quot; description=&quot;Network Lists&quot;&gt;<br />  &lt;network-lists&gt;<br />    &lt;!--<br />         These ACL's are automatically created on startup.<br /><br />         rfc1918.auto  - RFC1918 Space<br />         nat.auto      - RFC1918 Excluding your local lan.<br />         localnet.auto - ACL for your local lan.<br />         loopback.auto - ACL for your local lan.<br />    --&gt;<br /><br />    &lt;list name=&quot;lan&quot; default=&quot;allow&quot;&gt;<br />      &lt;node type=&quot;deny&quot; cidr=&quot;192.168.42.0/24&quot;/&gt;<br />      &lt;node type=&quot;allow&quot; cidr=&quot;192.168.42.42/32&quot;/&gt;<br />    &lt;/list&gt;<br /><br />    &lt;!--<br />        This will traverse the directory adding all users<br />        with the cidr= tag to this ACL, when this ACL matches<br />        the users variables and params apply as if they<br />        digest authenticated.<br />    --&gt;<br />    &lt;list name=&quot;domains&quot; default=&quot;deny&quot;&gt;<br />      &lt;!-- domain= is special it scans the domain from the directory to build the ACL --&gt;<br />      &lt;node type=&quot;allow&quot; domain=&quot;$${domain}&quot;/&gt;<br />      &lt;!-- use cidr= if you wish to allow ip ranges to this domains acl. --&gt;<br />      &lt;!-- &lt;node type=&quot;allow&quot; cidr=&quot;192.168.0.0/24&quot;/&gt; --&gt;<br />      &lt;node type=&quot;allow&quot; cidr=&quot;192.168.1.110/24&quot;/&gt; &lt;!--CUSTOMIZE--&gt;<br />    &lt;/list&gt;<br /><br />  &lt;/network-lists&gt;<br />&lt;/configuration&gt;<br /><br />@]<br /><br />----<br />!!!! /etc/odbcinst.ini<br /><br />This is the ODBC configuration file that tells ODBC where to find drivers.<br /><br />You probably don't need to customize it. Just check that is like the following.<br /><br />[@<br /><br />[MySQL]<br />Description     = MySQL driver<br />Driver          = /usr/lib64/odbc/libmyodbc.so<br />Setup           = /usr/lib64/odbc/libodbcmyS.so<br />UsageCount      = 1<br />FileUsage       = 1<br />Threading       = 0<br /><br />@]<br /><br />----<br />!!!! /etc/odbc.ini<br /><br />PAY ATTENTION TO THIS FILE !!!<br /><br />If you insert comments in it, it will not work (brain damaged, but true).<br /><br />You need at least to change &quot;mydbpassword&quot;.<br /><br />DON'T INSERT COMMENTS<br /><br />[@<br /><br />[opensips]<br />Driver          = /usr/lib64/odbc/libmyodbc.so<br />SERVER          = 127.0.0.1<br />PORT            = 3306<br />DATABASE        = opensips<br />OPTION          = 67108864<br />USER            = opensips<br />PASSWORD        = mydbpassword<br /><br /><br />@]<br /><br /><br />----<br />!!! PROFIT !<br /><br />Restart it all<br /><br />[@<br /><br />/etc/init.d/apache2 restart<br />/etc/init.d/opensips restart<br />/usr/local/freeswitch/bin/freeswitch -stop<br />/usr/local/freeswitch/bin/freeswitch -nc -nonat<br /><br />@]<br /><br />Go with your browser to http://webserveripaddress/cp<br /><br />Use OpenSIPS-CP to create a domain, then a couple users in that domain.<br /><br />Verify that all is working.<br /><br />They can call each other, calls goes to voicemail when needed, FreeSWITCH features can be accessed prepending * (star) to the corresponding FreeSWITCH extension (eg: *9664 for Music).<br /><br />Get rich!</div></div></div>
      <div class='diffrestore'><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=edit&restore=diff:1366822450:1366822450:&preview=y  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=edit&restore=diff:1366822450:1366822450:&preview=y%27" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=edit&restore=diff:1366822450:1366822450:&preview=y">Restore</a></div></div></div>
  
<!--PageRightFmt--><!--/PageRightFmt--></td>
</tr></table>
<!--PageFooterFmt-->
  <div id='wikifoot'>
  <hr class="bottomline" /></td>
    <div class='footnav'>
	
      <a rel="nofollow" href="Tutorials-OpenSIPSFreeSwitchIntegration-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=edit">Edit</a> |
      <a rel="nofollow" href="Tutorials-OpenSIPSFreeSwitchIntegration-action=diff.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=diff">History</a> |
      <a rel="nofollow" href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=print  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=print%27" tppabs="http://www.opensips.org/Documentation/Tutorials-OpenSIPSFreeSwitchIntegration?action=print" target='_blank'>Print</a> |
      <a href="RecentChanges.htm" tppabs="http://www.opensips.org/Documentation/RecentChanges">Recent Changes</a> |
      <a href="javascript:if(confirm(%27http://www.opensips.org/Site/Search  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Site/Search%27" tppabs="http://www.opensips.org/Site/Search">Search</a></div>
    <div class='lastmod'>Page last modified on May 16, 2013, at 06:06 PM</div></div>
<!--HTMLFooter-->
</div>
</body>
</html>
