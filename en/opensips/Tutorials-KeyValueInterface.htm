<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title>openSIPS | Documentation / Tutorials-KeyValueInterface </title>
  <meta http-equiv='Content-Style-Type' content='text/css' />
  <link rel='stylesheet' href="opensips.css" tppabs="http://www.opensips.org/pub/skins/opensips/opensips.css" type='text/css' />
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 4px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
  .editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }
 
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script>
  <link href="commentboxplus.css" tppabs="http://www.opensips.org/pub/commentboxplus/commentboxplus.css" rel='stylesheet' type='text/css' />
  <link rel='stylesheet' href="wsplus.css" tppabs="http://www.opensips.org/pub/wsplus/wsplus.css" 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url("csshover.htc")/*tpa=http://www.opensips.org/pub/wsplus/csshover.htc*/; }
    .rollover * { visibility: visible; }
  </style><![endif]-->
  <meta name='robots' content='index,follow' />

  <link rel="icon" type="image/png" href="http://opensips.org/favicon.png">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','analytics.js'/*tpa=http://www.google-analytics.com/analytics.js*/,'ga');

  ga('create', 'UA-47615177-1', 'http://www.opensips.org/Documentation/opensips.org');
  ga('send', 'pageview');

	function resizeIframe(obj) {
	    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
		  }

  </script>

</head>
<body>
<div id="main">
<!--PageHeaderFmt-->
  <div id='wikilogo'>
  <img class="motto" src="motto.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/motto.jpg" width="328" height="40" alt="The new breed of communication engine.">
  <a href="javascript:if(confirm(%27http://www.opensips.org/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/%27" tppabs="http://www.opensips.org/"><img class="logo" src="logo2.jpg" tppabs="http://www.opensips.org/pub/skins/opensips/images/logo2.jpg"
    alt='openSIPS' border='0' /></a>
 </div>
 <div id='wikihead'>
 <table border=0>
  <tr valign=top><td width=250>
   <p><a class='wikilink' title='Signup' href="javascript:if(confirm(%27http://www.opensips.org/Login/Signup?action=login  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Login/Signup?action=login%27" tppabs="http://www.opensips.org/Login/Signup?action=login">Login</a> | <a class='wikilink' title='Signup' href="javascript:if(confirm(%27http://www.opensips.org/Login/Signup  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Login/Signup%27" tppabs="http://www.opensips.org/Login/Signup">Register</a> 
</p>

  </td></tr>
  <tr><td width=250>
   <form action="http://www.opensips.org/">
   
    <input type='hidden' name='n' value='Documentation.Tutorials-KeyValueInterface' />
    <input type='hidden' name='action' value='search' />

    <input type='text' name='q' id='formsubmit' value='' class='inputbox searchbox' />
	<input type='submit' id='formbutton' class='inputbutton searchbutton' value=' ' /></form>
  </td></tr>
  </table>
 </div>

<!--/PageHeaderFmt-->
<div id="osTopNav" >
	<div id="osTopNavLeft">
	</div>

	<div id="osTopNavRight">
	</div>

	<ul id="osTopNavList">
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/About/About  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/About/About%27" tppabs="http://www.opensips.org/About/About" title="About">About</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Downloads/Downloads  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Downloads/Downloads%27" tppabs="http://www.opensips.org/Downloads/Downloads" title="Download">Downloads</a>
		</li>
		<li>
			<a href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals" title="Documentation">Documentation</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Community/Foundation-Main  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Community/Foundation-Main%27" tppabs="http://www.opensips.org/Community/Foundation-Main" title="Community">Community</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Development/Development  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Development/Development%27" tppabs="http://www.opensips.org/Development/Development" title="Development">Development</a>
		</li>
		<li>
			<a href="javascript:if(confirm(%27http://www.opensips.org/Support/Contact  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Support/Contact%27" tppabs="http://www.opensips.org/Support/Contact" title="Support">Support</a>
		</li>
	</ul>
</div>
<!--PageMenuFmt-->
<!--/PageMenuFmt-->
  <table width='100%' align="center" cellpadding='0' cellspacing='0' id='wikimid'>
    <tr>
<!--PageLeftFmt-->
      <td valign='top' bgcolor="#E2F8DA" id='wikileft'>
        <p class='sidehead'> <span  style='color: #185662;'> Documentation</span>
</p><ul><li><a class='wikilink' title='Manuals' href="Manuals.htm" tppabs="http://www.opensips.org/Documentation/Manuals">Manuals</a>
</li><li><a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Advanced Tutorials</a>
</li><li><a class='wikilink' title='TipsFAQ' href="TipsFAQ.htm" tppabs="http://www.opensips.org/Documentation/TipsFAQ">Tips &amp; FAQ</a>
</li><li><a class='wikilink' title='Migration' href="Migration.htm" tppabs="http://www.opensips.org/Documentation/Migration">Version Migration</a>
</li><li><a class='wikilink' title='Webinars' href="Webinars.htm" tppabs="http://www.opensips.org/Documentation/Webinars">OpenSIPS Webinars</a>
</li><li><a class='wikilink' title='Troubleshooting' href="Troubleshooting.htm" tppabs="http://www.opensips.org/Documentation/Troubleshooting">Troubleshooting</a>
</li><li><a class='wikilink' title='Tools' href="Tools.htm" tppabs="http://www.opensips.org/Documentation/Tools">OpenSIPS Tools</a>
</li><li><a class='wikilink' title='Development-Tutorials' href="Development-Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Development-Tutorials">Devel Tutorial</a>
</li></ul><div class='vspace'></div>
</td>
<!--/PageLeftFmt-->
      <td id='wikibody' valign='top'>
<!--PageTitleFmt-->
        
<!--PageText-->
<div id='wikitext'>
<h5>Documentation -&gt; <a class='wikilink' title='Tutorials' href="Tutorials.htm" tppabs="http://www.opensips.org/Documentation/Tutorials">Tutorials</a> -&gt; Key-Value Interface</h5>
<hr />
<p class='vspace'>This page has been visited 6203 times.
</p><div class='tocfloat'><p><a name='toc' id='toc'></a><b>Table of Content</b> (<a id="tocidtog" href="javascript:toggle('tocid');">hide</a>)</p><ol class='toc' id='tocid'><li>1.&nbsp;<a href='#toc1'>Key-Value Interface</a></li><li>2.&nbsp;<a href='#toc2'>Core API</a></li><li>3.&nbsp;<a href='#toc3'>Use Cases and Examples</a><ol class='toc'><li>3.1&nbsp;<a href='#toc4'>Password caching for DB authentication</a></li><li>3.2&nbsp;<a href='#toc5'>Simple but distributed billing</a></li></ol></li></ol></div>
<hr />
<div class='vspace'></div><h3><a name='toc1' id='toc1'></a>1.&nbsp; Key-Value Interface</h3>
<p>The Key-Value interface added into OpenSIPS provides an easy way for the script writer and the module writer to transparently access different Key-Value type back-ends, very similar to the way the DB interface allows easy connection to different types of SQL databases.
</p>
<p class='vspace'>Modules that offer actual back-end connection will use the Key-Value interface in order to provide the actual functionality to the end-user. At the current stage in time ( Official 1.7 release is out, trunk holds the future 1.8 ), there are four modules that use the interface :
</p>
<div class='vspace'></div><ul><li>cachedb_local - Uses OpenSIPS shared memory as storage 
<ul><li>Advantage - very fast, no external communication needed
</li><li>Disadvantage - low persistency, an OpenSIPS restart will cause the cache to get flushed
</li></ul></li><li>cachedb_memcached - Uses Memcached servers as back-end
<ul><li>Advantage - memory costs are no longer on the server. Better persistency, OpenSIPS restart will not affect memcached state
</li><li>Disadvantage - still behaves very much like a cache, so a Memcached server restart will cause all the information to be lost
</li></ul></li><li>cachedb_redis - Uses Redis Cluster servers as back-end
<ul><li>Advantage - Behaves like a DB, so a restart both on the OpenSIPS and the Redis server will not cause any data loss. Even more, because of the distributed character of the Redis Cluster, it can allow for easy and fast key-value sharing between multiple SIP instances.
</li><li>Disadvantage - The cost of full persistency and distribution makes it slower than the above back-ends.
</li></ul></li><li>cachedb_cassandra - Uses Cassandra Cluster servers as back-end
<ul><li>Advantage - Behaves like a DB, so a restart both on the OpenSIPS and the Cassandra server will not cause any data loss. Even more, because of the distributed character of the Cassandra Cluster, it can allow for easy and fast key-value sharing between multiple SIP instances.
</li><li>Disadvantage - The cost of full persistency and distribution makes it slower than the above back-ends.
</li></ul></li></ul><hr />
<div class='vspace'></div><h3><a name='toc2' id='toc2'></a>2.&nbsp; Core API</h3>
<p>The OpenSIPS core offers an API for operating with any memory caching system from the script. This API is composed out of the following functions: 
</p>
<div class='vspace'></div><ul><li>store - <a class='wikilink' title='Script-CoreFunctions' href="Script-CoreFunctions-2-2.htm#toc101" tppabs="http://www.opensips.org/Documentation/Script-CoreFunctions#toc101">cache_store()</a>
</li><li>fetch - <a class='wikilink' title='Script-CoreFunctions' href="Script-CoreFunctions-2-2.htm#toc102" tppabs="http://www.opensips.org/Documentation/Script-CoreFunctions#toc102">cache_fetch()</a>
</li><li>remove - <a class='wikilink' title='Script-CoreFunctions' href="Script-CoreFunctions-2-2.htm#toc103" tppabs="http://www.opensips.org/Documentation/Script-CoreFunctions#toc103">cache_remove()</a>
</li><li>add - <a class='wikilink' title='Script-CoreFunctions' href="Script-CoreFunctions-2-2.htm#toc104" tppabs="http://www.opensips.org/Documentation/Script-CoreFunctions#toc104">cache_add()</a>
</li><li>sub - <a class='wikilink' title='Script-CoreFunctions' href="Script-CoreFunctions-2-2.htm#toc105" tppabs="http://www.opensips.org/Documentation/Script-CoreFunctions#toc105">cache_sub()</a>
</li></ul><p class='vspace'>Each of the above functions in the API receive as first parameter the ENGINE_ID of the targeted cache system, a plain-text string.
The three modules previously listed that offer the actual implementation behave in the following way, in regards to providing the ENGINE_ID :
</p><ul><li>cachedb_local : the ENGINE_ID is always "local"
</li><li>cachedb_memcached : The Memcached module exports a parameter to script, <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/devel/cachedb_memcached.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/devel/cachedb_memcached.html#id249176%27" tppabs="http://www.opensips.org/html/docs/modules/devel/cachedb_memcached.html#id249176" rel='nofollow'>cachedb_url</a> . The prefix part of the URL provided ( the part before :// ) will be the ENGINE_ID identifier that will be provided to the functions in the API
</li><li>cachedb_redis : Similar to the memcached module, the Redis module exports a parameter to script, <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/devel/cachedb_redis.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/devel/cachedb_redis.html#id249095%27" tppabs="http://www.opensips.org/html/docs/modules/devel/cachedb_redis.html#id249095" rel='nofollow'>cachedb_url</a> . The prefix part of the URL provided ( the part before :// ) will be the ENGINE_ID identifier that will be provided to the functions in the API
</li></ul><div class='vspace'></div><hr />
<div class='vspace'></div><h3><a name='toc3' id='toc3'></a>3.&nbsp; Use Cases and Examples</h3>
<h4><a name='toc4' id='toc4'></a>3.1&nbsp; Password caching for DB authentication</h4>
<h5>The idea - how to</h5>
<p>The idea is, after performing a DB authentication (authentication by fetching the password from DB) to store the password in memcache; the password is stored with a certain lifetime to ensure that from time to time the password is read from DB again.
</p>
<p class='vspace'>When a new authentication is needed, first we check if the password is available in memcache (previously stored and not yet expired); if so, we use the value from there to perform authentication without a DB hit.
</p>
<p class='vspace'>As we have to store in the same time the passwords of more than one users, we need to use different names for the attributes -&gt; the attribute name will contain the user name, something like "passwd_username". 
</p>
<div class='vspace'></div><h5>The logic - diagram </h5>
<ol><li>REGISTER request received
</li><li>is password stored in "passwd_$tu" attribute?
<ol><li>NO -&gt; perform DB authentication 
</li><li>store the used password into "passwd_$tu" with s lifetime (1200 seconds - 10 minutes)
</li><li>DONE
</li></ol></li><li>YES -&gt; use the value from the memcache do to authentication from script variables.
</li><li>DONE
</li></ol><div class='vspace'></div><h5>Script example</h5>
<p>Current format of authentication script for REGISTER is:
</p><pre class='escaped'>
	if (!www_authorize("", "subscriber")) {
		www_challenge("", "0");
		exit;
	};
</pre>
<p class='vspace'>By adding memcache support, the script looks like:
</p><pre class='escaped'>
....
loadmodule "modules/db_mysql/db_mysql.so"
loadmodule "modules/auth/auth.so"
loadmodule "modules/auth_db/auth_db.so"
loadmodule "modules/localcache/localcache.so"
....
modparam("auth","username_spec","$avp(i:54)")
modparam("auth","password_spec","$avp(i:55)")
modparam("auth","calculate_ha1",1)

modparam("auth_db", "calculate_ha1", yes)
modparam("auth_db", "password_column", "password")
modparam("auth_db", "db_url","mysql://opensips:opensipsrw@localhost/opensips_1_2")
modparam("auth_db", "load_credentials", "$avp(i:55)=password")
....

....
route[x]{
	.....
	# do we have the password cached ?
	if(cache_fetch("local","passwd_$tu",$avp(i:55))) {
		$avp(i:54) = $tU;
		xlog("SCRIPT: stored password is $avp(i:55)\n");
		# perform auth from variables
		# $avp(i:54) contains the username
		# $avp(i:55) contains the password
		if (!pv_www_authorize("")) {
			# authentication failed -&gt; do challenge			
			www_challenge("", "0");
			exit;
		};
	} else {
		# perform DB authentication -&gt;
		# password will be loaded from DB automatically
		if (!www_authorize("", "subscriber")) {
			# authentication failed -&gt; do challenge		
			www_challenge("", "0");
			exit;
		};
		# after DB authentication, the password is available
		# in $avp(i:55) because of the "load_credentials"
		# module parameter.
		xlog("SCRIPT: storing password &lt;$avp(i:55)&gt;\n");
		# use a 20 minutes lifetime for the password;
		# after that, it will erased from cache and we do
		# db authentication again (refresh the passwd from DB)
		cache_store("local","passwd_$tu","$avp(i:55)",1200);
	}

	....
}
</pre>
<p class='vspace'>References:
</p><ol><li>auth module - see <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.5.x/auth.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.5.x/auth.html%27" tppabs="http://www.opensips.org/html/docs/modules/1.5.x/auth.html" rel='nofollow'>functions and parameters</a>
</li><li>auth_db module - see <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/1.5.x/auth_db.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/1.5.x/auth_db.html%27" tppabs="http://www.opensips.org/html/docs/modules/1.5.x/auth_db.html" rel='nofollow'>functions and parameters</a>
</li></ol><div class='vspace'></div><h5>Performance improvement</h5>
<p>Assuming a 30 minute registration period and placing a call each 20 minutes, without any caching, there will be 5 authentication queries to DB per hour per user.
</p>
<p class='vspace'>This means, for 1000 users, per day : 1000 * 3 * 24 = 72000 queries per day for auth.
</p>
<p class='vspace'>If you set a 2 hours lifetime for cached data, you have one query per user at each 2 hours.
</p>
<p class='vspace'>So, for the same 1000 users, per day, you have : 1000 * 0.5 * 24 = 12000 queries per day for auth
</p>
<p class='vspace'>So, this gives you a reduction to with 83% (to 17%) of the numbers of queries! 
</p>
<div class='vspace'></div><h4><a name='toc5' id='toc5'></a>3.2&nbsp; Simple but distributed billing</h4>
<h5>The idea - how to</h5>
<p>One can have multiple distributed OpenSIPS servers responsible for the same domain, for redundancy and load-balancing purposes, which can easily be accomplished via a simple mechanism like DNS Round-Robin.
Because all of the OpenSIPS servers will try to access the user's credit information, the problem occurs when you try to bill the calls done via those distributed OpenSIPS servers, but also when it comes to rejecting certain calls because the user does not have enough credit available.
</p>
<p class='vspace'>The solution would be to use a Redis DB clusters. The key will hold the actual username and the value will be the available credit. Because of the atomic nature of cache_add and cache_sub operations, all the OpenSIPS servers can reliably update the credit once the call ends. An OpenSIPS server can also consistently get the credit available for a certain user, in order to decide if it allows initial INVITEs to pass through or not. Even more, because of the persistency of Redis Server, all the credit information will not be lost in case of failures.
</p>
<div class='vspace'></div><h5>Prerequisites </h5>
<p>Each machine where OpenSIPS runs should have a Redis Server instance running. All the Redis Servers should be linked into a Redis cluster. A good tutorial on how create a simple Redis Cluster is located <a class='urllink' href="javascript:if(confirm(%27http://antirez.com/post/2-4-and-other-news.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://antirez.com/post/2-4-and-other-news.html%27" tppabs="http://antirez.com/post/2-4-and-other-news.html" rel='nofollow'>here</a>.
</p>
<div class='vspace'></div><h5>Script example</h5>
<p>Rejecting calls due to low credit and updating credit cost after each call end can be done in the following way :
</p>
<div class='vspace'></div><pre class='escaped'>

modparam("cachedb_redis","cachedb_url","redis://192.168.2.1:6379") 
....

route {
...
   # sequential requests
   if (has_totag()) {
      if (is_method("BYE")) {
          # substract from credit call_duration*cost cents
          $avp(cost) = $DLG_lifetime * $(dlg_val(cost){s.int});
          cache_sub("redis","credit_$fU",$avp(cost),0);
      }
      ...
   } else {
      # initial INVITE
      if (is_method("INVITE")) {
         # get user credit
         cache_fetch("redis","credit_$fU",$avp(user_credit));
         if ($avp(user_credit) &lt;= 1) {
            xlog("User $fU does not have enough credit\n");
            sl_send_reply("403","Forbidden - Not enough credit");
            exit;
         }

         create_dialog();
         # get call cost
         $dlg_val(cost)= "3"; 
      }
      ...
   }
...
}
</pre>
</div>
  
<!--PageRightFmt--><!--/PageRightFmt--></td>
</tr></table>
<!--PageFooterFmt-->
  <div id='wikifoot'>
  <hr class="bottomline" /></td>
    <div class='footnav'>
	
      <a rel="nofollow" href="Tutorials-KeyValueInterface-action=edit.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-KeyValueInterface?action=edit">Edit</a> |
      <a rel="nofollow" href="Tutorials-KeyValueInterface-action=diff.htm" tppabs="http://www.opensips.org/Documentation/Tutorials-KeyValueInterface?action=diff">History</a> |
      <a rel="nofollow" href="javascript:if(confirm(%27http://www.opensips.org/Documentation/Tutorials-KeyValueInterface?action=print  \n\nThis file was not retrieved by Teleport Pro, because it was unavailable, or its retrieval was aborted, or the project was stopped too soon.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation/Tutorials-KeyValueInterface?action=print%27" tppabs="http://www.opensips.org/Documentation/Tutorials-KeyValueInterface?action=print" target='_blank'>Print</a> |
      <a href="RecentChanges.htm" tppabs="http://www.opensips.org/Documentation/RecentChanges">Recent Changes</a> |
      <a href="javascript:if(confirm(%27http://www.opensips.org/Site/Search  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Site/Search%27" tppabs="http://www.opensips.org/Site/Search">Search</a></div>
    <div class='lastmod'>Page last modified on May 16, 2013, at 06:04 PM</div></div>
<!--HTMLFooter-->
</div>
</body>
</html>
