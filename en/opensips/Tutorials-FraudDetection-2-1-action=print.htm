<!DOCTYPE html 
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head>
  <title>openSIPS | Documentation / Tutorials-FraudDetection-2-1</title>
  <link rel='stylesheet' href="print.css" tppabs="http://www.opensips.org/pub/skins/print/print.css" type='text/css' />
  <!--HTMLHeader--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
span.anchor {
	float: left;
	font-size: 10px;
	margin-left: -10px;
	width: 10px;
    position:relative; top:-0.1em;
	text-align: center;
}
span.anchor a { text-decoration: none; }
span.anchor a:hover { text-decoration: underline; }
ol.toc { text-indent:-20px; list-style: none; }
ol.toc ol.toc { text-indent:-40px; }
div.tocfloat { font-size: smaller; margin-bottom: 10px;
    border-top: 1px dotted #555555; border-bottom: 1px dotted #555555;
    padding-top: 5px; padding-bottom: 5px; 
    width: 38%; float: right; margin-left: 10px; clear: right;
    margin-right:-13px; padding-right: 13px; padding-left: 13px;
    background-color: #eeeeee; }
div.toc { font-size: smaller; 
    padding: 4px; border: 1px dotted #cccccc;
    background: #f7f7f7;
    margin-bottom: 10px; }
  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
  .editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }
 
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style><script type="text/javascript">
function toggle(obj) {
    var elstyle = document.getElementById(obj).style;
    var text    = document.getElementById(obj + "tog");
    if (elstyle.display == 'none') {
        elstyle.display = 'block';
        text.innerHTML = "hide";
    } else {
        elstyle.display = 'none';
        text.innerHTML = "show";
    }
}
</script>
  <link href="commentboxplus.css" tppabs="http://www.opensips.org/pub/commentboxplus/commentboxplus.css" rel='stylesheet' type='text/css' />
  <link rel='stylesheet' href="wsplus.css" tppabs="http://www.opensips.org/pub/wsplus/wsplus.css" 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url("csshover.htc")/*tpa=http://www.opensips.org/pub/wsplus/csshover.htc*/; }
    .rollover * { visibility: visible; }
  </style><![endif]-->
  <meta name='robots' content='noindex,nofollow' />

</head>
<body>
  <div id='printhead'>
    <h3>From openSIPS</h3>
    <h1 class='pagename'><a href="javascript:if(confirm(%27http://www.opensips.org/Documentation  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/Documentation%27" tppabs="http://www.opensips.org/Documentation">Documentation: Tutorials-FraudDetection-2-1</a></h1>
  </div>
<!--PageText-->
<div id='wikitext'>
<h5>Documentation -&gt; <a class='wikilink' href="Tutorials-action=print.htm" tppabs="http://www.opensips.org/Documentation/Tutorials?action=print">Tutorials</a> -&gt; Using the <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/2.1.x/fraud_detection.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/2.1.x/fraud_detection.html%27" tppabs="http://www.opensips.org/html/docs/modules/2.1.x/fraud_detection.html" rel='nofollow'><ins>Fraud Detection</ins></a> module </h5>
<p>This page has been visited 2089 times.
</p><div class='tocfloat'><p><a name='toc' id='toc'></a><b>Table of Content</b> (<a id="tocidtog" href="javascript:toggle('tocid');">hide</a>)</p><ol class='toc' id='tocid'><li>1.&nbsp;<a href='#toc1'>Introduction</a></li><li>2.&nbsp;<a href='#toc2'>Module Overview</a><ol class='toc'><li>2.1&nbsp;<a href='#toc3'>Functionality</a></li><li>2.2&nbsp;<a href='#toc4'>DB provisioning</a></li><li>2.3&nbsp;<a href='#toc5'>How does it work?</a></li></ol></li><li>3.&nbsp;<a href='#toc6'>Example script</a></li></ol></div>
<hr />
<div class='vspace'></div><h2><a name='toc1' id='toc1'></a>1.&nbsp; Introduction</h2>
<p>Fraudulent calls have been a part of VoIP since its very beginnings. Typically, there are two ways through which a malicious user can gain permission to place calls through a VoIP platform: <em>account hijacking</em> and <em>weak platform security</em>.
</p>
<p class='vspace'>The module provides a way of <ins>detecting suspicious calls</ins> from the same users to the same destinations might would otherwise likely end up costing the affected VoIP account (or the VoIP provider!) considerable amounts of money. This is done by closely <ins>monitoring a set of call-related parameters</ins> for each <strong>[user,destination]</strong> pair, together with sets of provisioned alerting thresholds.
</p>
<div class='vspace'></div><h2><a name='toc2' id='toc2'></a>2.&nbsp; Module Overview</h2>
<h3><a name='toc3' id='toc3'></a>2.1&nbsp; Functionality</h3>
<p>With the help of the dialog module, fraud_detection is able to monitor the following call-related statistics for each <em>[user,destination]</em> pair:
</p>
<div class='vspace'></div><ul><li>calls-per-minute
</li><li>call duration
</li><li>total calls
</li><li>concurrent calls
</li><li>consecutive calls to the same destination
</li></ul><p><em>Note: the above statistics require a user-provisioned time interval to be sampled upon (see 'Table provisioning' below)</em>
</p>
<div class='vspace'></div><h3><a name='toc4' id='toc4'></a>2.2&nbsp; DB provisioning</h3>
<h4>Table creation</h4>
<p>In order to create the <strong>fraud_detection</strong> table, first make sure your <em>opensipsctlrc</em> file contains the desired SQL engine, DB name and access credentials:
</p>
<div class='vspace'></div><pre class='escaped'>
    vim /usr/local/etc/opensips/opensipsctlrc
</pre>
<p class='vspace'>Now you can add the extra OpenSIPS tables:
</p>
<div class='vspace'></div><pre class='escaped'>
    opensipsdbctl extra
</pre>
<div class='vspace'></div><h4>Table provisioning</h4>
<p>The following is an example of a fraud detecting profile for destination prefix <strong>"99"</strong>. Note that all of the rules below are part of the same profile: <strong>1</strong>.
</p><pre class='escaped'>
INSERT INTO fraud_detection(profileid, prefix, start_hour, end_hour, daysoftheweek, cpm_warning, cpm_critical, call_duration_warning, \
call_duration_critical, total_calls_warning, total_calls_critical, concurrent_calls_warning, concurrent_calls_critical, \
sequential_calls_warning, sequential_calls_critical) VALUES(1, '99', '09:00', '17:00', 'Mon-Fri', 3, 5, 120, 220, 16, 35, 3, 5, 6, 20), \
(1, '99', '17:01', '23:59', 'Mon-Fri', 3, 5, 160, 250, 21, 35, 3, 5, 8, 26), \
(1, '99', '00:00', '08:59', 'Mon-Fri', 3, 4, 80, 160, 10, 20, 3, 4, 5, 15), \
(1, '99', '00:00', '23:59', 'Sat,Sun', 3, 5, 190, 290, 24, 40, 3, 5, 12, 30);
</pre>
<p><br clear='all' />
</p>
<table border='1' ><tr ><td  align='center'><strong>rule id</strong></td><td  align='center'><strong>profile id</strong></td><td  align='center'><strong>prefix</strong></td><td  align='center'><strong>start hour</strong></td><td  align='center'><strong>end hour</strong></td><td  align='center'><strong>days of the week</strong></td><td  align='center'><strong>cpm warning</strong></td><td  align='center'><strong>cpm critical</strong></td><td  align='center'><strong>call duration warning</strong></td><td  align='center'><strong>call duration critical</strong></td><td  align='center'><strong>total calls warning</strong></td><td  align='center'><strong>total calls critical</strong></td><td  align='center'><strong>concurrent calls warning</strong></td><td  align='center'><strong>concurrent calls critical</strong></td><td  align='center'><strong>sequential calls warning</strong></td><td  align='center'><strong>sequential calls critical</strong></td></tr>
<tr ><td  align='left'> 1</td><td  align='center'>1</td><td  align='center'>99</td><td  align='center'>09:00</td><td  align='center'>17:00</td><td  align='center'>Mon-Fri</td><td  align='center'>3</td><td  align='center'>5</td><td  align='center'>120</td><td  align='center'>220</td><td  align='center'>16</td><td  align='center'>35</td><td  align='center'>3</td><td  align='center'>5</td><td  align='center'>6</td><td  align='center'>20</td></tr>
<tr ><td  align='left'> 2</td><td  align='center'>1</td><td  align='center'>99</td><td  align='center'>17:01</td><td  align='center'>23:59</td><td  align='center'>Mon-Fri</td><td  align='center'>3</td><td  align='center'>5</td><td  align='center'>160</td><td  align='center'>250</td><td  align='center'>21</td><td  align='center'>35</td><td  align='center'>3</td><td  align='center'>5</td><td  align='center'>8</td><td  align='center'>26</td></tr>
<tr ><td  align='left'> 3</td><td  align='center'>1</td><td  align='center'>99</td><td  align='center'>00:00</td><td  align='center'>08:59</td><td  align='center'>Mon-Fri</td><td  align='center'>3</td><td  align='center'>4</td><td  align='center'>80</td><td  align='center'>160</td><td  align='center'>10</td><td  align='center'>20</td><td  align='center'>3</td><td  align='center'>4</td><td  align='center'>5</td><td  align='center'>15</td></tr>
<tr ><td  align='left'> 4</td><td  align='center'>1</td><td  align='center'>99</td><td  align='center'>00:00</td><td  align='center'>23:59</td><td  align='center'>Sat,Sun</td><td  align='center'>3</td><td  align='center'>5</td><td  align='center'>190</td><td  align='center'>290</td><td  align='center'>24</td><td  align='center'>40</td><td  align='center'>3</td><td  align='center'>5</td><td  align='center'>12</td><td  align='center'>30</td></tr>
</table>
<p><span  style='color: green;'><strong>fraud_detection table example</strong></span>
<br clear='all' />
</p>
<p class='vspace'><br />
Data interpretation:
</p>
<div class='vspace'></div><ul><li><strong>Rule 1</strong> will obviously match from <strong>09:00 to 17:00</strong>, <strong>Monday to Friday</strong>. It will trigger a <span  style='color: #ff9900;'><strong>fraud warning</strong></span> event/error each time a user either:
<ul><li>has made <strong>3 or 4 calls within the last minute</strong>
</li><li>makes one call lasting <strong>between 120 and 219 minutes</strong>
</li><li>makes a new call, having made <strong>between 15 and 33 calls</strong> in the current interval
</li><li>attempts to make <strong>3 or 4 simultaneous calls</strong>
</li><li>makes <strong>between 6 and 19 consecutive calls</strong> to the same destination
</li></ul></li><li>The same <strong>Rule 1</strong> will trigger a <span  style='color: red;'><strong>fraud critical</strong></span> event/error each time a user either:
<ul><li>has made at least <strong>5 calls within the last minute</strong>
</li><li>makes one call lasting <strong>at least 220 minutes</strong>
</li><li>makes a new call, having made <strong>at least 34 calls</strong> in the current interval
</li><li>attempts to make <strong>at least 5 simultaneous calls</strong>
</li><li>makes <strong>at least 20 consecutive calls</strong> to the same destination
</li></ul></li></ul><div class='vspace'></div><h3><a name='toc5' id='toc5'></a>2.3&nbsp; How does it work?</h3>
<p>As stated in the Chapter 1 of the <a class='urllink' href="javascript:if(confirm(%27http://www.opensips.org/html/docs/modules/2.1.x/fraud_detection.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.opensips.org/html/docs/modules/2.1.x/fraud_detection.html%27" tppabs="http://www.opensips.org/html/docs/modules/2.1.x/fraud_detection.html" rel='nofollow'>documentation</a>, the module monitors 5 parameters which are updated every time the <strong><em>check_fraud</em></strong> function is called (i.e each time a call is made). For each set of <ins>number</ins>, <ins>prefix</ins> and <ins>username</ins>
, unique values of the 5 parameters will be kept and monitored. Each time a value is altered, it will be compared to a threshold value. There are two threshold values for each of the 5 parameters (warning and critical thresholds), thus making a total of 10 values. This threshold values along with a time interval in which they are applicable form a so-called <em>rule</em>. It's the admin's job to provide the <em>fraud rules</em> to OpenSIPs through the db interface.
</p>
<div class='vspace'></div><h2><a name='toc6' id='toc6'></a>3.&nbsp; Example script</h2>
<p>Firstly, we load the dependencies and the <strong>fraud_detection</strong> module
</p><pre class='escaped'>
loadmodule "drouting.so"
loadmodule "dialog.so"
loadmodule "fraud_detection.so"
</pre>
<p class='vspace'><br clear='all' />
Then we set the mandatory parameters
</p><pre class='escaped'>
modparam("drouting", "db_partitions_url", "mysql://root:123456@localhost/opensips")
modparam("drouting", "use_partitions", 1)
modparam("fraud_detection", "db_url", "mysql://root:123456@localhost/opensips")
</pre>
<p class='vspace'><br clear='all' />
Optionally, we load the event_route module to bind the warning and critical events to an event route
</p><pre class='escaped'>
loadmodule "event_route.so"
</pre>
<p class='vspace'><br clear='all' />
Let's assume that for each INITIAL INVITE we want to check and update the fraud parameters
</p><pre class='escaped'>
route{
	if (has_totag()) {
		loose_route();
	}
	else {
		record_route();
		check_fraud("$fU", "$rU", "1");
		if ($rc &lt; 0) {
			xlog("Problems for user $fU rc=$rc\n");
		}
	}
	t_relay();
}
</pre>
<p>Some issues can be identified on the spot, hence the check of the return code. Please refer to the module's documentation for the return code's meaning.
Please note the last parameter of the <em>check_fraud</em> function: it's the profile id we set earlier.
</p>
<p class='vspace'><br clear='all' />
</p>
<p class='vspace'>Optionally, we can bind the warning and critical events
</p><pre class='escaped'>
event_route[E_FRD_WARNING] {

	fetch_event_params("$var(param);$var(val);$var(thr);$var(user);$var(number);$var(ruleid)");
	xlog("E_FRD_WARNING: $var(param);$var(val);$var(thr);$var(user);$var(number);$var(ruleid)\n");
}

event_route[E_FRD_CRITICAL] {

	fetch_event_params("$var(param);$var(val);$var(thr);$var(user);$var(number);$var(ruleid)");
	xlog("E_FRD_CRITICAL: $var(param);$var(val);$var(thr);$var(user);$var(number);$var(ruleid)\n");
}

</pre>
</div>

  <div id='printfoot'>
    <div class='from'>Retrieved from http://www.opensips.org/Documentation/Tutorials-FraudDetection-2-1</div>
    <div class='lastmod'>Page last modified on May 10, 2015, at 10:17 PM</div></div>
<!--HTMLFooter-->
</body>
</html>
